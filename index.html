<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICP Club - Plataforma</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: radial-gradient(ellipse at top, rgba(79, 70, 229, 0.1) 0%, transparent 50%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .logo {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-select {
            cursor: pointer;
        }

        .form-select option {
            background: #1a1a1a;
            color: #ffffff;
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
            width: auto;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .text-center {
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.03);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            padding: 0 1rem;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #a1a1aa;
        }

        .nav-item:hover:not(.locked) {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .nav-item.active {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .nav-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .logout-btn {
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #a1a1aa;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .progress-container {
            margin-top: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            transition: width 0.3s ease;
        }

        .steps-grid {
            display: grid;
            gap: 1.5rem;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-card:not(.locked):hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .step-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-info {
            flex: 1;
        }

        .step-number {
            color: #4F46E5;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-current {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .badge-locked {
            background: rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
        }

        .video-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-card {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .exercises-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            color: #a1a1aa;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #ffffff;
        }

        .tab.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
        }

        .exercises-list {
            display: grid;
            gap: 1rem;
        }

        .exercise-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .exercise-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .exercise-meta {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .exercise-type {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .type-weekly {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .type-monthly {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .type-quarterly {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        .locked-message {
            text-align: center;
            padding: 4rem 2rem;
        }

        .locked-message h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .locked-message p {
            color: #a1a1aa;
        }

        .exercise-form {
            max-width: 800px;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .form-section-desc {
            color: #a1a1aa;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .auto-save-indicator.saving {
            color: #3b82f6;
        }

        .auto-save-indicator.saved {
            color: #10b981;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .review-section {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-section h3 {
            margin-bottom: 1rem;
        }

        .review-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            color: #e5e7eb;
            line-height: 1.6;
        }

        /* Admin styles */
        .admin-section {
            margin-bottom: 2rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-email {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .user-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4F46E5;
        }

        .user-stat-label {
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .step-unlock-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
        }

        .review-exercise-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .review-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .review-field {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .review-field:last-child {
            border-bottom: none;
        }

        .review-field-title {
            font-weight: 600;
            color: #4F46E5;
            margin-bottom: 0.5rem;
        }

        .review-field-content {
            color: #e5e7eb;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .create-exercise-form {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row > * {
            flex: 1;
        }

        .content-management-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .stage-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stage-number {
            display: inline-block;
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .user-actions {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">ICP Club</div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="tu@email.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Contrase√±a</label>
                    <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
            
            <p class="text-center" style="margin-top: 1rem; color: #a1a1aa; font-size: 0.9rem;">
                ¬øProblemas para acceder? Contacta con tu mentor.
            </p>
        </div>
    </div>

    <div id="dashboardApp" class="app-container hidden">
        <div class="sidebar">
            <div class="sidebar-logo">ICP Club</div>
            
            <div class="nav-menu" id="navMenu">
                <!-- Navigation items will be loaded here -->
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>

        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">¬°Bienvenido, <span id="userName">Trader</span>!</h1>
                    <p class="page-subtitle">Aqu√≠ tienes tu progreso y pr√≥ximas tareas</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="currentStepStat">1</div>
                        <div class="stat-label">Paso Actual</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedExercisesCount">0</div>
                        <div class="stat-label">Ejercicios Completados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="progressPercentage">0%</div>
                        <div class="stat-label">Progreso Total</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Tu Progreso General</h2>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Programa de 5 etapas</span>
                            <span id="progressText">0/5 etapas</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Etapa Actual</h2>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Est√°s en la <strong style="color: #4F46E5;">Etapa <span id="currentStepText">1</span></strong></p>
                    <button class="btn" onclick="navigateToCurrentStep()" style="width: auto;">Ver Contenido de la Etapa ‚Üí</button>
                </div>
            </div>

            <!-- Steps Page -->
            <div id="stepsPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Etapas del Programa</h1>
                    <p class="page-subtitle">5 etapas para dominar tu trading</p>
                </div>

                <div class="steps-grid" id="stepsGrid">
                    <!-- Steps will be loaded here -->
                </div>
            </div>

            <!-- Step Detail Page -->
            <div id="stepDetailPage" class="page-content hidden">
                <div class="page-header">
                    <button onclick="navigateToPage('steps')" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; margin-bottom: 1rem; font-size: 1rem;">‚Üê Volver a Etapas</button>
                    <h1 class="page-title" id="stepDetailTitle">Etapa</h1>
                    <p class="page-subtitle" id="stepDetailSubtitle"></p>
                </div>

                <div class="video-container" id="stepVideo">
                    <!-- Video will be loaded here -->
                </div>

                <div class="tool-card">
                    <h3>üõ†Ô∏è Herramienta de esta Etapa</h3>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Accede a la herramienta espec√≠fica para completar esta etapa</p>
                    <button class="btn" id="toolButton" style="width: auto;">Acceder a la Herramienta</button>
                </div>

                <div class="card" id="stepContent">
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <p style="color: #a1a1aa;">Contenido de la etapa...</p>
                </div>
            </div>

            <!-- Exercises Page -->
            <div id="exercisesPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Mis Ejercicios</h1>
                    <p class="page-subtitle">Revisiones semanales, mensuales y trimestrales</p>
                </div>

                <div class="exercises-tabs">
                    <div class="tab active" data-tab="pending">Pendientes</div>
                    <div class="tab" data-tab="completed">Completados</div>
                </div>

                <div id="pendingExercises" class="exercises-list">
                    <!-- Pending exercises will be loaded here -->
                </div>

                <div id="completedExercisesList" class="exercises-list hidden">
                    <!-- Completed exercises will be loaded here -->
                </div>
            </div>

            <!-- Exercise Form Page -->
            <div id="exerciseFormPage" class="page-content hidden">
                <div class="page-header">
                    <button onclick="navigateToPage('exercises')" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; margin-bottom: 1rem; font-size: 1rem;">‚Üê Volver a Ejercicios</button>
                    <h1 class="page-title" id="exerciseFormTitle">Revisi√≥n</h1>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                        <p class="page-subtitle" id="exerciseFormSubtitle">Completa todos los campos</p>
                        <div class="auto-save-indicator" id="autoSaveIndicator">
                            <span id="autoSaveText">Sin cambios</span>
                        </div>
                    </div>
                </div>

                <form class="exercise-form" id="exerciseForm">
                    <div class="form-section">
                        <div class="form-section-title">üìä M√©tricas</div>
                        <div class="form-section-desc">Comparte tus m√©tricas principales de este per√≠odo</div>
                        <div class="form-group">
                            <textarea id="metrics" class="form-textarea" placeholder="Ej: Ganadas: 15, Perdidas: 8, Win rate: 65%, P&L: +$1,200..." required></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">‚úÖ Qu√© funcion√≥</div>
                        <div class="form-section-desc">Describe qu√© estrategias, comportamientos o decisiones dieron resultado</div>
                        <div class="form-group">
                            <textarea id="whatWorked" class="form-textarea" placeholder="Ej: Respet√© mi plan de trading, esper√© setups claros, mantuve mi risk management..." required></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">‚ùå Qu√© no funcion√≥</div>
                        <div class="form-section-desc">Identifica errores, patrones negativos o decisiones que no dieron resultado</div>
                        <div class="form-group">
                            <textarea id="whatDidntWork" class="form-textarea" placeholder="Ej: Forc√© trades sin setup, sal√≠ antes de tiempo por miedo..." required></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üòì Algo que me cost√≥</div>
                        <div class="form-section-desc">¬øQu√© te result√≥ dif√≠cil o desafiante en este per√≠odo?</div>
                        <div class="form-group">
                            <textarea id="struggles" class="form-textarea" placeholder="Ej: Me cost√≥ mantener la disciplina despu√©s de una p√©rdida, controlar la ansiedad..." required></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üèÜ Un win (logro)</div>
                        <div class="form-section-desc">Celebra un logro, por peque√±o que sea</div>
                        <div class="form-group">
                            <textarea id="wins" class="form-textarea" placeholder="Ej: Logr√© seguir mi checklist todos los d√≠as, tuve mi mejor semana en ganancias..." required></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üîÑ Qu√© har√≠a diferente</div>
                        <div class="form-section-desc">Si pudieras volver atr√°s, ¬øqu√© cambiar√≠as?</div>
                        <div class="form-group">
                            <textarea id="whatDifferent" class="form-textarea" placeholder="Ej: Reducir√≠a el tama√±o de posici√≥n en d√≠as vol√°tiles, har√≠a m√°s breaks..." required></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üéØ KPIs para el siguiente per√≠odo</div>
                        <div class="form-section-desc">Define tus objetivos medibles para la pr√≥xima semana/mes/trimestre</div>
                        <div class="form-group">
                            <textarea id="kpis" class="form-textarea" placeholder="Ej: Win rate > 60%, Max drawdown < 3%, Respetar plan 100% de los d√≠as..." required></textarea>
                        </div>
                    </div>

                    <div id="reviewSection" class="review-section hidden">
                        <h3>üí¨ Feedback del Mentor</h3>
                        <div class="review-content" id="reviewContent"></div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">Guardar Borrador</button>
                        <button type="submit" class="btn" id="submitExerciseBtn">Enviar para Revisi√≥n</button>
                    </div>
                </form>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Panel de Administraci√≥n</h1>
                    <p class="page-subtitle">Gestiona alumnos, etapas y ejercicios</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="adminTotalStudents">0</div>
                        <div class="stat-label">Total Alumnos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminPendingReviews">0</div>
                        <div class="stat-label">Ejercicios Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminActiveStudents">0</div>
                        <div class="stat-label">Alumnos Activos</div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Gesti√≥n de Alumnos</h2>
                        <div class="user-list" id="adminUsersList">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Ejercicios Pendientes de Revisi√≥n</h2>
                        <div id="adminPendingExercises">
                            <!-- Pending exercises will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Gesti√≥n de Contenido de Etapas</h2>
                        <p style="color: #a1a1aa; margin-bottom: 1.5rem;">Edita videos, herramientas y recursos de cada etapa</p>
                        <div id="stagesContentManagement">
                            <!-- Stages content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendarPage" class="page-content hidden">
                <div id="calendarLocked" class="locked-message">
                    <h3>üîí Llamadas Bloqueadas</h3>
                    <p>Tu mentor desbloquear√° esta secci√≥n cuando sea el momento de agendar tu llamada 1:1</p>
                </div>

                <div id="calendarUnlocked" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Agendar Llamada</h1>
                        <p class="page-subtitle">Reserva tu sesi√≥n 1:1 con tu mentor</p>
                    </div>
                    <div class="card">
                        <div style="min-height: 600px;">
                            <iframe src="https://calendly.com/edgartradea/30min" width="100%" height="600" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Mi Perfil</h1>
                    <p class="page-subtitle">Informaci√≥n de tu cuenta</p>
                </div>
                <div class="card">
                    <p style="color: #a1a1aa;">Esta secci√≥n se est√° construyendo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Revisar Ejercicio</h2>
                <button class="modal-close" onclick="closeReviewModal()">√ó</button>
            </div>
            
            <div id="reviewModalContent">
                <!-- Exercise content will be loaded here -->
            </div>

            <div class="form-group" style="margin-top: 2rem;">
                <label class="form-label" for="reviewFeedback">Feedback para el alumno</label>
                <textarea id="reviewFeedback" class="form-textarea" placeholder="Escribe aqu√≠ tu feedback..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeReviewModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitReview()">Aprobar y Enviar Feedback</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, addDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1U_K-9vkGGnKcbAALA-pSRMTv8f0B_M4",
            authDomain: "icp-club-app.firebaseapp.com",
            projectId: "icp-club-app",
            storageBucket: "icp-club-app.firebasestorage.app",
            messagingSenderId: "684016793931",
            appId: "1:684016793931:web:127126cbb7b133ad5290ce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let currentExercise = null;
        let currentReviewExercise = null;
        let autoSaveTimer = null;

        const steps = [
            { id: 1, title: "Identificar errores", video: "", tool: "" },
            { id: 2, title: "Sistemas y procesos", video: "", tool: "" },
            { id: 3, title: "H√°bitos", video: "", tool: "" },
            { id: 4, title: "Integraci√≥n al trading", video: "", tool: "" },
            { id: 5, title: "Trading", video: "", tool: "" }
        ];

        const loginPage = document.getElementById('loginPage');
        const dashboardApp = document.getElementById('dashboardApp');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user);
                showDashboard();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            hideMessages();
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showSuccess('Login exitoso!');
            } catch (error) {
                showError(getErrorMessage(error.code));
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        });

        // Navigation
        function showLogin() {
            loginPage.classList.remove('hidden');
            dashboardApp.classList.add('hidden');
        }

        function showDashboard() {
            loginPage.classList.add('hidden');
            dashboardApp.classList.remove('hidden');
            loadNavigation();
            navigateToPage('dashboard');
        }

        function loadNavigation() {
            const navMenu = document.getElementById('navMenu');
            const isAdmin = userData?.role === 'admin';
            
            const navItems = [
                { id: 'dashboard', icon: 'üìä', label: 'Dashboard', locked: false },
                { id: 'steps', icon: 'üìö', label: 'Etapas', locked: false },
                { id: 'exercises', icon: '‚úçÔ∏è', label: 'Mis Ejercicios', locked: false },
                { id: 'calendar', icon: 'üìÖ', label: 'Agendar Llamada', locked: !userData?.calendarUnlocked && !isAdmin },
                { id: 'profile', icon: 'üë§', label: 'Perfil', locked: false }
            ];

            if (isAdmin) {
                navItems.splice(4, 0, { id: 'admin', icon: '‚öôÔ∏è', label: 'Admin', locked: false });
            }

            navMenu.innerHTML = navItems.map(item => `
                <div class="nav-item ${item.locked ? 'locked' : ''}" data-page="${item.id}">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                    ${item.locked ? '<span>üîí</span>' : ''}
                </div>
            `).join('');

            document.querySelectorAll('.nav-item:not(.locked)').forEach(item => {
                item.addEventListener('click', () => {
                    navigateToPage(item.dataset.page);
                });
            });
        }

        window.navigateToPage = function(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
            
            const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            if (page === 'dashboard') loadDashboard();
            else if (page === 'steps') loadSteps();
            else if (page === 'exercises') loadExercises();
            else if (page === 'calendar') loadCalendar();
            else if (page === 'admin') loadAdminDashboard();
        }

        window.navigateToCurrentStep = function() {
            const currentStep = userData?.currentStep || 1;
            navigateToStep(currentStep);
        }

        window.navigateToStep = async function(stepId) {
            const step = steps.find(s => s.id === stepId);
            if (!step) return;

            const isUnlocked = userData?.unlockedSteps?.includes(stepId);
            if (!isUnlocked && userData?.role !== 'admin') return;

            // Load stage configuration from Firestore
            let stageConfig = {};
            try {
                const configDoc = await getDoc(doc(db, 'config', 'stages'));
                if (configDoc.exists()) {
                    const allConfig = configDoc.data();
                    stageConfig = allConfig[`stage${stepId}`] || {};
                }
            } catch (error) {
                console.log('No config found for stage');
            }

            document.getElementById('stepDetailTitle').textContent = `Etapa ${stepId}: ${step.title}`;
            document.getElementById('stepDetailSubtitle').textContent = stageConfig.description || '';

            const videoContainer = document.getElementById('stepVideo');
            const videoUrl = stageConfig.video || step.video;
            
            if (videoUrl) {
                let embedUrl = videoUrl;
                
                // Convert YouTube URL to embed
                if (videoUrl.includes('youtube.com/watch')) {
                    const videoId = new URL(videoUrl).searchParams.get('v');
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (videoUrl.includes('youtu.be/')) {
                    const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (videoUrl.includes('loom.com/share/')) {
                    const videoId = videoUrl.split('loom.com/share/')[1].split('?')[0];
                    embedUrl = `https://www.loom.com/embed/${videoId}`;
                } else if (videoUrl.includes('vimeo.com/')) {
                    const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
                    embedUrl = `https://player.vimeo.com/video/${videoId}`;
                }
                
                videoContainer.innerHTML = `<iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = '<p style="color: #a1a1aa;">Video pr√≥ximamente...</p>';
            }

            const toolButton = document.getElementById('toolButton');
            const toolUrl = stageConfig.tool || step.tool;
            
            if (toolUrl) {
                toolButton.onclick = () => window.open(toolUrl, '_blank');
                toolButton.style.display = 'block';
            } else {
                toolButton.style.display = 'none';
            }

            // Update resources section
            const stepContent = document.getElementById('stepContent');
            if (stageConfig.resources) {
                stepContent.innerHTML = `
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <div style="color: #e5e7eb; line-height: 1.8; white-space: pre-wrap;">${stageConfig.resources}</div>
                `;
            } else {
                stepContent.innerHTML = `
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <p style="color: #a1a1aa;">Pr√≥ximamente tu mentor a√±adir√° recursos aqu√≠...</p>
                `;
            }

            navigateToPage('stepDetail');
        }

        // Load functions
        async function loadUserData(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                } else {
                    userData = {
                        email: user.email,
                        name: user.email.split('@')[0],
                        currentStep: 1,
                        unlockedSteps: [1],
                        calendarUnlocked: false,
                        completedExercises: 0,
                        role: 'student'
                    };
                    await setDoc(doc(db, 'users', user.uid), userData);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadDashboard() {
            document.getElementById('userName').textContent = userData?.name || 'Trader';
            document.getElementById('currentStepStat').textContent = userData?.currentStep || 1;
            document.getElementById('currentStepText').textContent = userData?.currentStep || 1;
            document.getElementById('completedExercisesCount').textContent = userData?.completedExercises || 0;

            const completedSteps = (userData?.unlockedSteps?.length || 1) - 1;
            const progressPercent = Math.round((completedSteps / 5) * 100);
            document.getElementById('progressPercentage').textContent = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${completedSteps}/5 etapas`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
        }

        async function loadSteps() {
            const stepsGrid = document.getElementById('stepsGrid');
            const unlockedSteps = userData?.unlockedSteps || [1];
            const currentStep = userData?.currentStep || 1;

            stepsGrid.innerHTML = steps.map(step => {
                const isUnlocked = unlockedSteps.includes(step.id);
                const isCurrent = step.id === currentStep;
                const isCompleted = step.id < currentStep;
                
                let badge = '';
                if (isCompleted) badge = '<span class="step-badge badge-completed">‚úì Completado</span>';
                else if (isCurrent) badge = '<span class="step-badge badge-current">Actual</span>';
                else badge = '<span class="step-badge badge-locked">üîí Bloqueado</span>';

                return `
                    <div class="step-card ${!isUnlocked ? 'locked' : ''}" onclick="${isUnlocked ? `navigateToStep(${step.id})` : ''}">
                        <div class="step-info">
                            <div class="step-number">Etapa ${step.id}</div>
                            <div class="step-title">${step.title}</div>
                        </div>
                        ${badge}
                    </div>
                `;
            }).join('');
        }

        async function loadExercises() {
            // Setup tabs first (remove old listeners)
            const tabs = document.querySelectorAll('.exercises-tabs .tab');
            tabs.forEach(tab => {
                // Remove old listeners by cloning
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
            });

            // Add new listeners
            document.querySelectorAll('.exercises-tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.exercises-tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.tab === 'pending') {
                        document.getElementById('pendingExercises').classList.remove('hidden');
                        document.getElementById('completedExercisesList').classList.add('hidden');
                    } else {
                        document.getElementById('pendingExercises').classList.add('hidden');
                        document.getElementById('completedExercisesList').classList.remove('hidden');
                    }
                });
            });

            try {
                const exercisesRef = collection(db, 'exercises');
                const q = query(
                    exercisesRef,
                    where('userId', '==', currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                const exercises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort by createdAt manually
                exercises.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                console.log('Ejercicios cargados:', exercises); // Debug

                const pending = exercises.filter(e => e.status === 'draft' || e.status === 'pending');
                const completed = exercises.filter(e => e.status === 'completed');

                renderExercisesList('pendingExercises', pending);
                renderExercisesList('completedExercisesList', completed);
            } catch (error) {
                console.error('Error loading exercises:', error);
                document.getElementById('pendingExercises').innerHTML = 
                    `<p style="color: #ef4444; text-align: center; padding: 2rem;">Error al cargar ejercicios: ${error.message}</p>`;
            }
        }

        function renderExercisesList(containerId, exercises) {
            const container = document.getElementById(containerId);
            
            console.log(`Renderizando ${exercises.length} ejercicios en ${containerId}`); // Debug
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay ejercicios aqu√≠</p>';
                return;
            }

            container.innerHTML = exercises.map(exercise => {
                const typeClass = exercise.type === 'weekly' ? 'type-weekly' : 
                                  exercise.type === 'monthly' ? 'type-monthly' : 'type-quarterly';
                const typeLabel = exercise.type === 'weekly' ? 'Semanal' : 
                                  exercise.type === 'monthly' ? 'Mensual' : 'Trimestral';
                
                let date = 'Sin fecha';
                if (exercise.createdAt) {
                    try {
                        if (exercise.createdAt.toDate) {
                            date = exercise.createdAt.toDate().toLocaleDateString('es-ES');
                        } else if (exercise.createdAt.seconds) {
                            date = new Date(exercise.createdAt.seconds * 1000).toLocaleDateString('es-ES');
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e);
                    }
                }
                
                const statusLabel = exercise.status === 'draft' ? 'üìù Borrador' : 
                                    exercise.status === 'pending' ? '‚è≥ En revisi√≥n' : '‚úÖ Completado';

                return `
                    <div class="exercise-card" onclick="openExercise('${exercise.id}')">
                        <div class="exercise-info">
                            <h3>Revisi√≥n ${typeLabel}</h3>
                            <div class="exercise-meta">${date} ¬∑ ${statusLabel}</div>
                        </div>
                        <span class="exercise-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        window.openExercise = async function(exerciseId) {
            try {
                const exerciseDoc = await getDoc(doc(db, 'exercises', exerciseId));
                if (!exerciseDoc.exists()) return;

                currentExercise = { id: exerciseId, ...exerciseDoc.data() };
                
                document.getElementById('exerciseFormTitle').textContent = `Revisi√≥n ${currentExercise.type === 'weekly' ? 'Semanal' : currentExercise.type === 'monthly' ? 'Mensual' : 'Trimestral'}`;
                
                // Fill form
                document.getElementById('metrics').value = currentExercise.metrics || '';
                document.getElementById('whatWorked').value = currentExercise.whatWorked || '';
                document.getElementById('whatDidntWork').value = currentExercise.whatDidntWork || '';
                document.getElementById('struggles').value = currentExercise.struggles || '';
                document.getElementById('wins').value = currentExercise.wins || '';
                document.getElementById('whatDifferent').value = currentExercise.whatDifferent || '';
                document.getElementById('kpis').value = currentExercise.kpis || '';

                // Show review if completed
                const reviewSection = document.getElementById('reviewSection');
                if (currentExercise.status === 'completed' && currentExercise.mentorFeedback) {
                    reviewSection.classList.remove('hidden');
                    document.getElementById('reviewContent').textContent = currentExercise.mentorFeedback;
                } else {
                    reviewSection.classList.add('hidden');
                }

                // Disable form if completed
                const isCompleted = currentExercise.status === 'completed';
                document.querySelectorAll('#exerciseForm textarea').forEach(textarea => {
                    textarea.disabled = isCompleted;
                });
                document.getElementById('submitExerciseBtn').disabled = isCompleted;

                navigateToPage('exerciseForm');
                setupAutoSave();
            } catch (error) {
                console.error('Error opening exercise:', error);
            }
        }

        function setupAutoSave() {
            const fields = ['metrics', 'whatWorked', 'whatDidntWork', 'struggles', 'wins', 'whatDifferent', 'kpis'];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                element.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    updateAutoSaveIndicator('saving');
                    
                    autoSaveTimer = setTimeout(async () => {
                        await saveAsDraft();
                        updateAutoSaveIndicator('saved');
                    }, 2000);
                });
            });
        }

        function updateAutoSaveIndicator(state) {
            const indicator = document.getElementById('autoSaveIndicator');
            const text = document.getElementById('autoSaveText');
            
            indicator.className = 'auto-save-indicator';
            
            if (state === 'saving') {
                indicator.classList.add('saving');
                text.textContent = 'üíæ Guardando...';
            } else if (state === 'saved') {
                indicator.classList.add('saved');
                text.textContent = '‚úì Guardado';
                setTimeout(() => {
                    indicator.className = 'auto-save-indicator';
                    text.textContent = 'Sin cambios';
                }, 2000);
            }
        }

        window.saveAsDraft = async function() {
            if (!currentExercise) return;

            const exerciseData = {
                metrics: document.getElementById('metrics').value,
                whatWorked: document.getElementById('whatWorked').value,
                whatDidntWork: document.getElementById('whatDidntWork').value,
                struggles: document.getElementById('struggles').value,
                wins: document.getElementById('wins').value,
                whatDifferent: document.getElementById('whatDifferent').value,
                kpis: document.getElementById('kpis').value,
                status: 'draft',
                updatedAt: Timestamp.now()
            };

            try {
                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
            } catch (error) {
                console.error('Error saving draft:', error);
            }
        }

        document.getElementById('exerciseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentExercise) return;

            const submitBtn = document.getElementById('submitExerciseBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            const exerciseData = {
                metrics: document.getElementById('metrics').value,
                whatWorked: document.getElementById('whatWorked').value,
                whatDidntWork: document.getElementById('whatDidntWork').value,
                struggles: document.getElementById('struggles').value,
                wins: document.getElementById('wins').value,
                whatDifferent: document.getElementById('whatDifferent').value,
                kpis: document.getElementById('kpis').value,
                status: 'pending',
                submittedAt: Timestamp.now()
            };

            try {
                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
                showSuccess('¬°Ejercicio enviado para revisi√≥n!');
                setTimeout(() => {
                    navigateToPage('exercises');
                }, 1500);
            } catch (error) {
                console.error('Error submitting exercise:', error);
                showError('Error al enviar el ejercicio');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar para Revisi√≥n';
            }
        });

        async function loadCalendar() {
            const locked = document.getElementById('calendarLocked');
            const unlocked = document.getElementById('calendarUnlocked');
            
            if (userData?.calendarUnlocked || userData?.role === 'admin') {
                locked.classList.add('hidden');
                unlocked.classList.remove('hidden');
            } else {
                locked.classList.remove('hidden');
                unlocked.classList.add('hidden');
            }
        }

        // Admin functions
        async function loadAdminDashboard() {
            if (userData?.role !== 'admin') {
                navigateToPage('dashboard');
                return;
            }

            try {
                // Load all users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(u => u.role !== 'admin');

                // Load pending exercises
                const exercisesSnapshot = await getDocs(
                    query(collection(db, 'exercises'), where('status', '==', 'pending'))
                );
                const pendingExercises = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update stats
                document.getElementById('adminTotalStudents').textContent = users.length;
                document.getElementById('adminPendingReviews').textContent = pendingExercises.length;
                document.getElementById('adminActiveStudents').textContent = users.filter(u => u.currentStep > 1).length;

                // Render users list
                renderAdminUsersList(users);

                // Render pending exercises
                renderAdminPendingExercises(pendingExercises, users);

                // Load stages content management
                await loadStagesContent();
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        function renderAdminUsersList(users) {
            const container = document.getElementById('adminUsersList');
            
            container.innerHTML = users.map(user => {
                const completedSteps = (user.unlockedSteps?.length || 1) - 1;
                
                return `
                    <div class="user-card">
                        <div class="user-header">
                            <div>
                                <div class="user-name">${user.name || user.email}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                        
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-value">${user.currentStep || 1}</div>
                                <div class="user-stat-label">Etapa Actual</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${completedSteps}</div>
                                <div class="user-stat-label">Completadas</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${user.completedExercises || 0}</div>
                                <div class="user-stat-label">Ejercicios</div>
                            </div>
                        </div>

                        <div class="step-unlock-controls">
                            <select class="form-select" id="stepSelect_${user.id}" style="flex: 1;">
                                ${steps.map(step => `
                                    <option value="${step.id}" ${user.currentStep === step.id ? 'selected' : ''}>
                                        Etapa ${step.id}: ${step.title}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="btn btn-small" onclick="unlockStepForUser('${user.id}')">
                                Desbloquear Etapa
                            </button>
                        </div>

                        <div class="create-exercise-form" id="createExForm_${user.id}" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: #4F46E5;">Crear Ejercicio</h4>
                            <div class="form-row">
                                <select class="form-select" id="exType_${user.id}">
                                    <option value="weekly">Semanal</option>
                                    <option value="monthly">Mensual</option>
                                    <option value="quarterly">Trimestral</option>
                                </select>
                                <button class="btn btn-success btn-small" onclick="createExerciseForUser('${user.id}')">
                                    Crear
                                </button>
                            </div>
                        </div>

                        <div class="user-actions">
                            <button class="btn btn-secondary btn-small" onclick="toggleCalendar('${user.id}', ${!user.calendarUnlocked})">
                                ${user.calendarUnlocked ? 'üîì Bloquear' : 'üîí Desbloquear'} Calendario
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="toggleCreateExerciseForm('${user.id}')">
                                ‚ûï Crear Ejercicio
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.unlockStepForUser = async function(userId) {
            try {
                const selectedStep = parseInt(document.getElementById(`stepSelect_${userId}`).value);
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();
                
                const unlockedSteps = userData.unlockedSteps || [1];
                if (!unlockedSteps.includes(selectedStep)) {
                    unlockedSteps.push(selectedStep);
                    unlockedSteps.sort((a, b) => a - b);
                }

                await updateDoc(userRef, {
                    currentStep: selectedStep,
                    unlockedSteps: unlockedSteps
                });

                showSuccess(`Etapa ${selectedStep} desbloqueada para el alumno`);
                loadAdminDashboard();
            } catch (error) {
                console.error('Error unlocking step:', error);
                showError('Error al desbloquear la etapa');
            }
        }

        window.toggleCalendar = async function(userId, unlock) {
            try {
                await updateDoc(doc(db, 'users', userId), {
                    calendarUnlocked: unlock
                });

                showSuccess(unlock ? 'Calendario desbloqueado' : 'Calendario bloqueado');
                loadAdminDashboard();
            } catch (error) {
                console.error('Error toggling calendar:', error);
                showError('Error al actualizar el calendario');
            }
        }

        function renderAdminPendingExercises(exercises, users) {
            const container = document.getElementById('adminPendingExercises');
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay ejercicios pendientes de revisi√≥n</p>';
                return;
            }

            container.innerHTML = exercises.map(exercise => {
                const user = users.find(u => u.id === exercise.userId);
                const typeClass = exercise.type === 'weekly' ? 'type-weekly' : 
                                  exercise.type === 'monthly' ? 'type-monthly' : 'type-quarterly';
                const typeLabel = exercise.type === 'weekly' ? 'Semanal' : 
                                  exercise.type === 'monthly' ? 'Mensual' : 'Trimestral';
                const date = exercise.submittedAt?.toDate ? exercise.submittedAt.toDate().toLocaleDateString('es-ES') : 'Sin fecha';

                return `
                    <div class="exercise-card" onclick="openReviewModal('${exercise.id}', '${user?.name || 'Alumno'}')">
                        <div class="exercise-info">
                            <h3>${user?.name || user?.email || 'Alumno'} - Revisi√≥n ${typeLabel}</h3>
                            <div class="exercise-meta">Enviado el ${date}</div>
                        </div>
                        <span class="exercise-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        window.openReviewModal = async function(exerciseId, userName) {
            try {
                const exerciseDoc = await getDoc(doc(db, 'exercises', exerciseId));
                if (!exerciseDoc.exists()) return;

                currentReviewExercise = { id: exerciseId, ...exerciseDoc.data() };
                
                const modal = document.getElementById('reviewModal');
                const content = document.getElementById('reviewModalContent');
                
                content.innerHTML = `
                    <div class="review-exercise-header">
                        <div>
                            <h3>${userName}</h3>
                            <p style="color: #a1a1aa;">Revisi√≥n ${currentReviewExercise.type === 'weekly' ? 'Semanal' : currentReviewExercise.type === 'monthly' ? 'Mensual' : 'Trimestral'}</p>
                        </div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">üìä M√©tricas</div>
                        <div class="review-field-content">${currentReviewExercise.metrics || 'Sin respuesta'}</div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">‚úÖ Qu√© funcion√≥</div>
                        <div class="review-field-content">${currentReviewExercise.whatWorked || 'Sin respuesta'}</div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">‚ùå Qu√© no funcion√≥</div>
                        <div class="review-field-content">${currentReviewExercise.whatDidntWork || 'Sin respuesta'}</div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">üòì Algo que me cost√≥</div>
                        <div class="review-field-content">${currentReviewExercise.struggles || 'Sin respuesta'}</div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">üèÜ Un win (logro)</div>
                        <div class="review-field-content">${currentReviewExercise.wins || 'Sin respuesta'}</div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">üîÑ Qu√© har√≠a diferente</div>
                        <div class="review-field-content">${currentReviewExercise.whatDifferent || 'Sin respuesta'}</div>
                    </div>

                    <div class="review-field">
                        <div class="review-field-title">üéØ KPIs para el siguiente per√≠odo</div>
                        <div class="review-field-content">${currentReviewExercise.kpis || 'Sin respuesta'}</div>
                    </div>
                `;

                document.getElementById('reviewFeedback').value = '';
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error opening review modal:', error);
            }
        }

        window.closeReviewModal = function() {
            document.getElementById('reviewModal').classList.add('hidden');
            currentReviewExercise = null;
        }

        window.submitReview = async function() {
            if (!currentReviewExercise) return;

            const feedback = document.getElementById('reviewFeedback').value.trim();
            if (!feedback) {
                showError('Por favor, escribe un feedback para el alumno');
                return;
            }

            try {
                await updateDoc(doc(db, 'exercises', currentReviewExercise.id), {
                    status: 'completed',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                // Update user's completed exercises count
                const userRef = doc(db, 'users', currentReviewExercise.userId);
                const userDoc = await getDoc(userRef);
                const currentCount = userDoc.data().completedExercises || 0;
                await updateDoc(userRef, {
                    completedExercises: currentCount + 1
                });

                showSuccess('¬°Ejercicio revisado y feedback enviado!');
                closeReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error submitting review:', error);
                showError('Error al enviar la revisi√≥n');
            }
        }

        // Utility functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Email inv√°lido',
                'auth/user-disabled': 'Usuario deshabilitado',
                'auth/user-not-found': 'Usuario no encontrado',
                'auth/wrong-password': 'Contrase√±a incorrecta',
                'auth/invalid-credential': 'Credenciales inv√°lidas'
            };
            return messages[code] || 'Error al iniciar sesi√≥n';
        }

        window.toggleCreateExerciseForm = function(userId) {
            const form = document.getElementById(`createExForm_${userId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        window.createExerciseForUser = async function(userId) {
            const type = document.getElementById(`exType_${userId}`).value;
            
            try {
                const exerciseData = {
                    userId: userId,
                    type: type,
                    status: 'draft',
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now(),
                    metrics: '',
                    whatWorked: '',
                    whatDidntWork: '',
                    struggles: '',
                    wins: '',
                    whatDifferent: '',
                    kpis: ''
                };

                await addDoc(collection(db, 'exercises'), exerciseData);
                
                showSuccess(`‚úÖ Ejercicio ${type === 'weekly' ? 'semanal' : type === 'monthly' ? 'mensual' : 'trimestral'} creado!`);
                document.getElementById(`createExForm_${userId}`).style.display = 'none';
            } catch (error) {
                console.error('Error creating exercise:', error);
                showError('Error al crear el ejercicio');
            }
        }

        async function loadStagesContent() {
            const container = document.getElementById('stagesContentManagement');
            
            // Load stages configuration from Firestore
            let stagesConfig = {};
            try {
                const configDoc = await getDoc(doc(db, 'config', 'stages'));
                if (configDoc.exists()) {
                    stagesConfig = configDoc.data();
                }
            } catch (error) {
                console.log('No config found, using defaults');
            }

            container.innerHTML = steps.map(step => {
                const config = stagesConfig[`stage${step.id}`] || {};
                
                return `
                    <div class="content-management-card">
                        <div class="stage-card-header">
                            <div>
                                <span class="stage-number">Etapa ${step.id}</span>
                                <h3 style="margin-top: 0.5rem;">${step.title}</h3>
                            </div>
                        </div>

                        <form id="stageForm_${step.id}" onsubmit="saveStageContent(event, ${step.id})">
                            <div class="form-group">
                                <label class="form-label">Video URL (YouTube, Loom, Vimeo)</label>
                                <input 
                                    type="url" 
                                    class="form-input" 
                                    id="video_${step.id}"
                                    value="${config.video || ''}"
                                    placeholder="https://www.youtube.com/watch?v=..."
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">Herramienta URL</label>
                                <input 
                                    type="url" 
                                    class="form-input" 
                                    id="tool_${step.id}"
                                    value="${config.tool || ''}"
                                    placeholder="https://..."
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea 
                                    class="form-textarea" 
                                    id="description_${step.id}"
                                    placeholder="Descripci√≥n de la etapa..."
                                >${config.description || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Recursos Adicionales</label>
                                <textarea 
                                    class="form-textarea" 
                                    id="resources_${step.id}"
                                    placeholder="Links, documentos, material extra..."
                                >${config.resources || ''}</textarea>
                            </div>

                            <button type="submit" class="btn btn-small">
                                üíæ Guardar Cambios
                            </button>
                        </form>
                    </div>
                `;
            }).join('');
        }

        window.saveStageContent = async function(event, stageId) {
            event.preventDefault();
            
            const video = document.getElementById(`video_${stageId}`).value.trim();
            const tool = document.getElementById(`tool_${stageId}`).value.trim();
            const description = document.getElementById(`description_${stageId}`).value.trim();
            const resources = document.getElementById(`resources_${stageId}`).value.trim();

            try {
                const configRef = doc(db, 'config', 'stages');
                const configDoc = await getDoc(configRef);
                
                let currentConfig = {};
                if (configDoc.exists()) {
                    currentConfig = configDoc.data();
                }

                currentConfig[`stage${stageId}`] = {
                    video,
                    tool,
                    description,
                    resources,
                    updatedAt: Timestamp.now()
                };

                await setDoc(configRef, currentConfig, { merge: true });
                
                // Update local steps array
                const stepIndex = steps.findIndex(s => s.id === stageId);
                if (stepIndex !== -1) {
                    steps[stepIndex].video = video;
                    steps[stepIndex].tool = tool;
                    steps[stepIndex].description = description;
                }

                showSuccess(`‚úÖ Etapa ${stageId} actualizada correctamente`);
            } catch (error) {
                console.error('Error saving stage content:', error);
                showError('Error al guardar los cambios');
            }
        }

        // Make functions global
        window.navigateToPage = navigateToPage;
        window.navigateToCurrentStep = navigateToCurrentStep;
        window.navigateToStep = navigateToStep;
        window.openExercise = openExercise;
        window.saveAsDraft = saveAsDraft;
        window.unlockStepForUser = unlockStepForUser;
        window.toggleCalendar = toggleCalendar;
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.submitReview = submitReview;
        window.toggleCreateExerciseForm = toggleCreateExerciseForm;
        window.createExerciseForUser = createExerciseForUser;
        window.saveStageContent = saveStageContent;
    </script>
</body>
</html>
