<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICP Club - Plataforma</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: radial-gradient(ellipse at top, rgba(79, 70, 229, 0.1) 0%, transparent 50%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .logo {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-select {
            cursor: pointer;
        }

        .form-select option {
            background: #1a1a1a;
            color: #ffffff;
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
            width: auto;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .text-center {
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.03);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            padding: 0 1rem;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #a1a1aa;
        }

        .nav-item:hover:not(.locked) {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .nav-item.active {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .nav-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .logout-btn {
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #a1a1aa;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .progress-container {
            margin-top: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            transition: width 0.3s ease;
        }

        .steps-grid {
            display: grid;
            gap: 1.5rem;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-card:not(.locked):hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .step-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-info {
            flex: 1;
        }

        .step-number {
            color: #4F46E5;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-current {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .badge-locked {
            background: rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
        }

        /* Stage 0: Self-Assessment Styles */
        .assessment-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .assessment-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .assessment-label {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .assessment-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4F46E5;
        }

        .slider-container {
            position: relative;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        .average-score {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(124, 58, 237, 0.2));
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }

        .average-score-number {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .average-score-label {
            font-size: 1.2rem;
            color: #a1a1aa;
            margin-top: 0.5rem;
        }

        /* Collapsible Tool Card Styles */
        .tool-card-compact {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .tool-card-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .tool-card-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .tool-card-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tool-card-icon {
            font-size: 1.5rem;
        }

        .tool-card-title-group h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .tool-card-subtitle {
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .tool-card-expand-icon {
            font-size: 1.5rem;
            color: #4F46E5;
            transition: transform 0.3s ease;
        }

        .tool-card-compact.expanded .tool-card-expand-icon {
            transform: rotate(180deg);
        }

        .tool-card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tool-card-compact.expanded .tool-card-body {
            max-height: 10000px;
        }

        .tool-card-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        /* Expandable Section Styles */
        .expandable-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .expandable-section-header {
            padding: 1rem 1.25rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .expandable-section-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .expandable-section-title {
            font-weight: 600;
            color: #4F46E5;
            font-size: 1rem;
        }

        .expandable-section-icon {
            color: #4F46E5;
            transition: transform 0.3s ease;
        }

        .expandable-section.expanded .expandable-section-icon {
            transform: rotate(180deg);
        }

        .expandable-section-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expandable-section.expanded .expandable-section-body {
            max-height: 5000px;
        }

        .expandable-section-content {
            padding: 1rem 1.25rem;
        }

        .subsection-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .subsection-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .subsection-item-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: #e5e7eb;
        }

        .subsection-item button {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .subsection-item button:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .add-item-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(79, 70, 229, 0.1);
            border: 1px dashed rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            color: #4F46E5;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.75rem;
        }

        .add-item-btn:hover {
            background: rgba(79, 70, 229, 0.15);
            border-style: solid;
        }

        /* Error/RED Item Styles */
        .items-list-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .items-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .items-list {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(79, 70, 229, 0.3);
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: #ffffff;
        }

        .item-status {
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border: none;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-icon.edit:hover {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .item-editor {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .item-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .item-editor-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .question-block {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .question-number {
            display: inline-block;
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 1rem;
            line-height: 1.5;
            color: #ffffff;
        }

        .question-help {
            font-size: 0.9rem;
            color: #a1a1aa;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #a1a1aa;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .empty-state-text {
            font-size: 0.95rem;
        }

        .save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #a1a1aa;
        }

        .save-indicator.saving {
            color: #3b82f6;
        }

        .save-indicator.saved {
            color: #10b981;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .video-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exercises-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            color: #a1a1aa;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #ffffff;
        }

        .tab.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
        }

        .exercises-list {
            display: grid;
            gap: 1rem;
        }

        .exercise-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .exercise-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .exercise-meta {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .exercise-type {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .type-weekly {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .type-monthly {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .type-quarterly {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        .locked-message {
            text-align: center;
            padding: 4rem 2rem;
        }

        .locked-message h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .locked-message p {
            color: #a1a1aa;
        }

        .exercise-form {
            max-width: 800px;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .form-section-desc {
            color: #a1a1aa;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .auto-save-indicator.saving {
            color: #3b82f6;
        }

        .auto-save-indicator.saved {
            color: #10b981;
        }

        .review-section {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-section h3 {
            margin-bottom: 1rem;
        }

        .review-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            color: #e5e7eb;
            line-height: 1.6;
        }

        /* Admin styles */
        .admin-section {
            margin-bottom: 2rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-email {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .user-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4F46E5;
        }

        .user-stat-label {
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .step-unlock-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
        }

        .review-exercise-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .review-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .review-field {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .review-field:last-child {
            border-bottom: none;
        }

        .review-field-title {
            font-weight: 600;
            color: #4F46E5;
            margin-bottom: 0.5rem;
        }

        .review-field-content {
            color: #e5e7eb;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .create-exercise-form {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row > * {
            flex: 1;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        .content-management-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .stage-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stage-number {
            display: inline-block;
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .user-actions {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">ICP Club</div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="tu@email.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Contrase√±a</label>
                    <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
            
            <p class="text-center" style="margin-top: 1rem; color: #a1a1aa; font-size: 0.9rem;">
                ¬øProblemas para acceder? Contacta con tu mentor.
            </p>
        </div>
    </div>

    <div id="dashboardApp" class="app-container hidden">
        <div class="sidebar">
            <div class="sidebar-logo">ICP Club</div>
            
            <div class="nav-menu" id="navMenu">
                <!-- Navigation items will be loaded here -->
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>

        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">¬°Bienvenido, <span id="userName">Trader</span>!</h1>
                    <p class="page-subtitle">Aqu√≠ tienes tu progreso y pr√≥ximas tareas</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="currentStepStat">1</div>
                        <div class="stat-label">Paso Actual</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedExercisesCount">0</div>
                        <div class="stat-label">Ejercicios Completados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="progressPercentage">0%</div>
                        <div class="stat-label">Progreso Total</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Tu Progreso General</h2>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Programa de 5 etapas</span>
                            <span id="progressText">0/5 etapas</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Etapa Actual</h2>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Est√°s en la <strong style="color: #4F46E5;">Etapa <span id="currentStepText">1</span></strong></p>
                    <button class="btn" onclick="navigateToCurrentStep()" style="width: auto;">Ver Contenido de la Etapa ‚Üí</button>
                </div>
            </div>

            <!-- Steps Page -->
            <div id="stepsPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Etapas del Programa</h1>
                    <p class="page-subtitle">5 etapas para dominar tu trading + Auto-evaluaci√≥n</p>
                </div>

                <div class="steps-grid" id="stepsGrid">
                    <!-- Steps will be loaded here -->
                </div>
            </div>

            <!-- Step Detail Page -->
            <div id="stepDetailPage" class="page-content hidden">
                <div class="page-header">
                    <button onclick="navigateToPage('steps')" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; margin-bottom: 1rem; font-size: 1rem;">‚Üê Volver a Etapas</button>
                    <h1 class="page-title" id="stepDetailTitle">Etapa</h1>
                    <p class="page-subtitle" id="stepDetailSubtitle"></p>
                </div>

                <div class="video-container" id="stepVideo">
                    <!-- Video will be loaded here -->
                </div>

                <!-- Stage Tools Section -->
                <div id="stageToolsSection" class="stage-tools-section">
                    <!-- Tools will be loaded here dynamically -->
                </div>

                <!-- Submit Stage for Review -->
                <div class="card" id="submitStageCard">
                    <h2 class="card-title">‚úÖ Completar Etapa</h2>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Cuando hayas completado todo el contenido y la herramienta de esta etapa, env√≠ala para revisi√≥n.</p>
                    <div id="stageSubmitStatus" style="margin-bottom: 1rem;"></div>
                    <button class="btn" id="submitStageBtn" onclick="submitStageForReview()">üì§ Enviar Etapa para Revisi√≥n</button>
                </div>

                <div class="card" id="stepContent">
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <p style="color: #a1a1aa;">Contenido de la etapa...</p>
                </div>
            </div>

            <!-- Exercises Page -->
            <div id="exercisesPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Mis Ejercicios</h1>
                    <p class="page-subtitle">Revisiones semanales, mensuales y trimestrales</p>
                </div>

                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">‚ûï Crear Nuevo Ejercicio</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button class="btn btn-secondary" onclick="createMyExercise('weekly')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÖ</div>
                            <div style="font-weight: 600;">Revisi√≥n Semanal</div>
                        </button>
                        <button class="btn btn-secondary" onclick="createMyExercise('monthly')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÜ</div>
                            <div style="font-weight: 600;">Revisi√≥n Mensual</div>
                        </button>
                        <button class="btn btn-secondary" onclick="createMyExercise('quarterly')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                            <div style="font-weight: 600;">Revisi√≥n Trimestral</div>
                        </button>
                        <button class="btn btn-secondary" onclick="createMyExercise('pattern')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üß†</div>
                            <div style="font-weight: 600;">Diario de Patrones</div>
                        </button>
                    </div>
                </div>

                <div class="exercises-tabs">
                    <div class="tab active" data-tab="pending">Pendientes</div>
                    <div class="tab" data-tab="completed">Completados</div>
                </div>

                <div id="pendingExercises" class="exercises-list">
                    <!-- Pending exercises will be loaded here -->
                </div>

                <div id="completedExercisesList" class="exercises-list hidden">
                    <!-- Completed exercises will be loaded here -->
                </div>
            </div>

            <!-- Exercise Form Page -->
            <div id="exerciseFormPage" class="page-content hidden">
                <div class="page-header">
                    <button onclick="navigateToPage('exercises')" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; margin-bottom: 1rem; font-size: 1rem;">‚Üê Volver a Ejercicios</button>
                    <h1 class="page-title" id="exerciseFormTitle">Revisi√≥n</h1>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                        <p class="page-subtitle" id="exerciseFormSubtitle">Completa todos los campos</p>
                        <div class="auto-save-indicator" id="autoSaveIndicator">
                            <span id="autoSaveText">Sin cambios</span>
                        </div>
                    </div>
                </div>

                <form class="exercise-form" id="exerciseForm">
                    <div id="reviewFormContent">
                        <!-- Form content will be loaded dynamically based on exercise type -->
                    </div>

                    <div id="reviewSection" class="review-section hidden">
                        <h3>üí¨ Feedback del Mentor</h3>
                        <div class="review-content" id="reviewContent"></div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">Guardar Borrador</button>
                        <button type="submit" class="btn" id="submitExerciseBtn">Enviar para Revisi√≥n</button>
                    </div>
                </form>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Panel de Administraci√≥n</h1>
                    <p class="page-subtitle">Gestiona alumnos, etapas y ejercicios</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="adminTotalStudents">0</div>
                        <div class="stat-label">Total Alumnos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminPendingReviews">0</div>
                        <div class="stat-label">Ejercicios Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminActiveStudents">0</div>
                        <div class="stat-label">Alumnos Activos</div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Gesti√≥n de Alumnos</h2>
                        <div class="user-list" id="adminUsersList">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Ejercicios Pendientes de Revisi√≥n</h2>
                        <div id="adminPendingExercises">
                            <!-- Pending exercises will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Etapas Pendientes de Revisi√≥n</h2>
                        <div id="adminPendingStages">
                            <!-- Pending stages will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Gesti√≥n de Contenido de Etapas</h2>
                        <p style="color: #a1a1aa; margin-bottom: 1.5rem;">Edita videos, herramientas y recursos de cada etapa</p>
                        <div id="stagesContentManagement">
                            <!-- Stages content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendarPage" class="page-content hidden">
                <div id="calendarLocked" class="locked-message">
                    <h3>üîí Llamadas Bloqueadas</h3>
                    <p>Tu mentor desbloquear√° esta secci√≥n cuando sea el momento de agendar tu llamada 1:1</p>
                </div>

                <div id="calendarUnlocked" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Agendar Llamada</h1>
                        <p class="page-subtitle">Reserva tu sesi√≥n 1:1 con tu mentor</p>
                    </div>
                    <div class="card">
                        <div style="min-height: 600px;">
                            <iframe src="https://calendly.com/edgartradea/30min" width="100%" height="600" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Mi Perfil</h1>
                    <p class="page-subtitle">Informaci√≥n de tu cuenta</p>
                </div>
                <div class="card">
                    <p style="color: #a1a1aa;">Esta secci√≥n se est√° construyendo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Revisar Ejercicio</h2>
                <button class="modal-close" onclick="closeReviewModal()">√ó</button>
            </div>
            
            <div id="reviewModalContent">
                <!-- Exercise content will be loaded here -->
            </div>

            <div class="form-group" style="margin-top: 2rem;">
                <label class="form-label" for="reviewFeedback">Feedback para el alumno</label>
                <textarea id="reviewFeedback" class="form-textarea" placeholder="Escribe aqu√≠ tu feedback..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeReviewModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitReview()">Aprobar y Enviar Feedback</button>
            </div>
        </div>
    </div>

    <!-- Stage Review Modal -->
    <div id="stageReviewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Revisar Etapa</h2>
                <button class="modal-close" onclick="closeStageReviewModal()">√ó</button>
            </div>
            
            <div id="stageReviewModalContent">
                <!-- Stage content will be loaded here -->
            </div>

            <div class="form-group" style="margin-top: 2rem;">
                <label class="form-label" for="stageFeedback">Feedback para el alumno</label>
                <textarea id="stageFeedback" class="form-textarea" placeholder="Escribe aqu√≠ tu feedback..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeStageReviewModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="rejectStage()">Rechazar</button>
                <button class="btn btn-success" onclick="approveStage()">Aprobar Etapa</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, addDoc, orderBy, Timestamp, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1U_K-9vkGGnKcbAALA-pSRMTv8f0B_M4",
            authDomain: "icp-club-app.firebaseapp.com",
            projectId: "icp-club-app",
            storageBucket: "icp-club-app.firebasestorage.app",
            messagingSenderId: "684016793931",
            appId: "1:684016793931:web:4a4870a86beb01ee5290ce",
            measurementId: "G-DDPRR5NY4L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let currentExercise = null;
        let currentReviewExercise = null;
        let currentStageWork = null;
        let currentReviewStage = null;
        let autoSaveTimer = null;
        let currentStageId = null;
        let currentErrorId = null;
        let currentErrors = [];
        let errorAutoSaveTimer = null;
        
        // Stage 2 variables
        let currentREDItems = [];
        let currentREDId = null;
        let redAutoSaveTimer = null;
        let stage2SystemsData = null;
        let systemsAutoSaveTimer = null;
        let stage2HabitsData = null;
        let habitsAutoSaveTimer = null;

        // Stage 0 variables
        let stage0Data = null;
        let stage0AutoSaveTimer = null;

        const steps = [
            { id: 0, title: "Auto-evaluaci√≥n", video: "", tool: "" },
            { id: 1, title: "Identificar errores", video: "", tool: "" },
            { id: 2, title: "Sistemas y procesos", video: "", tool: "" },
            { id: 3, title: "H√°bitos", video: "", tool: "" },
            { id: 4, title: "Integraci√≥n al trading", video: "", tool: "" },
            { id: 5, title: "Trading", video: "", tool: "" }
        ];

        const loginPage = document.getElementById('loginPage');
        const dashboardApp = document.getElementById('dashboardApp');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user);
                showDashboard();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            hideMessages();
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showSuccess('Login exitoso!');
            } catch (error) {
                showError(getErrorMessage(error.code));
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        });

        // Navigation
        function showLogin() {
            loginPage.classList.remove('hidden');
            dashboardApp.classList.add('hidden');
        }

        function showDashboard() {
            loginPage.classList.add('hidden');
            dashboardApp.classList.remove('hidden');
            loadNavigation();
            navigateToPage('dashboard');
        }

        function loadNavigation() {
            const navMenu = document.getElementById('navMenu');
            const isAdmin = userData?.role === 'admin';
            
            const navItems = [
                { id: 'dashboard', icon: 'üìä', label: 'Dashboard', locked: false },
                { id: 'steps', icon: 'üìö', label: 'Etapas', locked: false },
                { id: 'exercises', icon: '‚úçÔ∏è', label: 'Mis Ejercicios', locked: false },
                { id: 'calendar', icon: 'üìÖ', label: 'Agendar Llamada', locked: !userData?.calendarUnlocked && !isAdmin },
                { id: 'profile', icon: 'üë§', label: 'Perfil', locked: false }
            ];

            if (isAdmin) {
                navItems.splice(4, 0, { id: 'admin', icon: '‚öôÔ∏è', label: 'Admin', locked: false });
            }

            navMenu.innerHTML = navItems.map(item => `
                <div class="nav-item ${item.locked ? 'locked' : ''}" data-page="${item.id}">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                    ${item.locked ? '<span>üîí</span>' : ''}
                </div>
            `).join('');

            document.querySelectorAll('.nav-item:not(.locked)').forEach(item => {
                item.addEventListener('click', () => {
                    navigateToPage(item.dataset.page);
                });
            });
        }

        window.navigateToPage = function(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
            
            const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            if (page === 'dashboard') loadDashboard();
            else if (page === 'steps') loadSteps();
            else if (page === 'exercises') loadExercises();
            else if (page === 'calendar') loadCalendar();
            else if (page === 'admin') loadAdminDashboard();
        }

        window.navigateToCurrentStep = function() {
            const currentStep = userData?.currentStep || 1;
            navigateToStep(currentStep);
        }

        window.navigateToStep = async function(stepId) {
            const step = steps.find(s => s.id === stepId);
            if (!step) return;

            const isUnlocked = userData?.unlockedSteps?.includes(stepId) || stepId === 0;
            if (!isUnlocked && userData?.role !== 'admin') return;

            // Load stage configuration from Firestore
            let stageConfig = {};
            try {
                const configDoc = await getDoc(doc(db, 'config', 'stages'));
                if (configDoc.exists()) {
                    const allConfig = configDoc.data();
                    stageConfig = allConfig[`stage${stepId}`] || {};
                }
            } catch (error) {
                console.log('No config found for stage');
            }

            document.getElementById('stepDetailTitle').textContent = `Etapa ${stepId}: ${step.title}`;
            document.getElementById('stepDetailSubtitle').textContent = stageConfig.description || '';

            const videoContainer = document.getElementById('stepVideo');
            const videoUrl = stageConfig.video || step.video;
            
            if (videoUrl) {
                let embedUrl = videoUrl;
                
                // Convert YouTube URL to embed
                if (videoUrl.includes('youtube.com/watch')) {
                    const videoId = new URL(videoUrl).searchParams.get('v');
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (videoUrl.includes('youtu.be/')) {
                    const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (videoUrl.includes('loom.com/share/')) {
                    const videoId = videoUrl.split('loom.com/share/')[1].split('?')[0];
                    embedUrl = `https://www.loom.com/embed/${videoId}`;
                } else if (videoUrl.includes('vimeo.com/')) {
                    const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
                    embedUrl = `https://player.vimeo.com/video/${videoId}`;
                }
                
                videoContainer.innerHTML = `<iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = '<p style="color: #a1a1aa;">Video pr√≥ximamente...</p>';
            }

            // Update resources section
            const stepContent = document.getElementById('stepContent');
            if (stageConfig.resources) {
                stepContent.innerHTML = `
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <div style="color: #e5e7eb; line-height: 1.8; white-space: pre-wrap;">${stageConfig.resources}</div>
                `;
            } else {
                stepContent.innerHTML = `
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <p style="color: #a1a1aa;">Pr√≥ximamente tu mentor a√±adir√° recursos aqu√≠...</p>
                `;
            }

            navigateToPage('stepDetail');
            
            // Load stage-specific tools
            currentStageId = stepId;
            const toolsSection = document.getElementById('stageToolsSection');
            
            if (stepId === 0 && userData?.role !== 'admin') {
                // Stage 0: Self-Assessment
                toolsSection.classList.remove('hidden');
                await loadStage0Assessment();
            } else if (stepId === 1 && userData?.role !== 'admin') {
                // Stage 1: Load errors management system
                toolsSection.classList.remove('hidden');
                await loadStage1Errors();
            } else if (stepId === 2 && userData?.role !== 'admin') {
                // Stage 2: Load 3 tools (RED, Systems, Habits)
                toolsSection.classList.remove('hidden');
                await loadStage2Tools();
            } else {
                // Other stages: hide tools section for now
                toolsSection.classList.add('hidden');
            }
            
            // Load stage submission status (only for students and not for stage 0)
            if (userData?.role !== 'admin' && stepId !== 0) {
                await updateStageSubmitStatus(stepId);
            } else {
                document.getElementById('submitStageCard').style.display = 'none';
            }
        }

        // Load functions
        async function loadUserData(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                    
                    // Ensure Stage 0 is always unlocked
                    if (!userData.unlockedSteps || !userData.unlockedSteps.includes(0)) {
                        const unlockedSteps = userData.unlockedSteps || [1];
                        if (!unlockedSteps.includes(0)) {
                            unlockedSteps.unshift(0);
                        }
                        userData.unlockedSteps = unlockedSteps;
                        await updateDoc(doc(db, 'users', user.uid), {
                            unlockedSteps: unlockedSteps
                        });
                    }
                } else {
                    userData = {
                        email: user.email,
                        name: user.email.split('@')[0],
                        currentStep: 1,
                        unlockedSteps: [0, 1], // Stage 0 always unlocked
                        calendarUnlocked: false,
                        completedExercises: 0,
                        role: 'student'
                    };
                    await setDoc(doc(db, 'users', user.uid), userData);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadDashboard() {
            document.getElementById('userName').textContent = userData?.name || 'Trader';
            document.getElementById('currentStepStat').textContent = userData?.currentStep || 1;
            document.getElementById('currentStepText').textContent = userData?.currentStep || 1;
            document.getElementById('completedExercisesCount').textContent = userData?.completedExercises || 0;

            const completedSteps = (userData?.unlockedSteps?.length || 1) - 2; // Subtract Stage 0 and current
            const progressPercent = Math.round((completedSteps / 5) * 100);
            document.getElementById('progressPercentage').textContent = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${completedSteps}/5 etapas`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
        }

        async function loadSteps() {
            const stepsGrid = document.getElementById('stepsGrid');
            const unlockedSteps = userData?.unlockedSteps || [0, 1];
            const currentStep = userData?.currentStep || 1;

            stepsGrid.innerHTML = steps.map(step => {
                const isUnlocked = unlockedSteps.includes(step.id) || step.id === 0;
                const isCurrent = step.id === currentStep;
                const isCompleted = step.id < currentStep;
                
                let badge = '';
                if (step.id === 0) {
                    badge = '<span class="step-badge badge-current">Siempre Disponible</span>';
                } else if (isCompleted) {
                    badge = '<span class="step-badge badge-completed">‚úì Completado</span>';
                } else if (isCurrent) {
                    badge = '<span class="step-badge badge-current">Actual</span>';
                } else {
                    badge = '<span class="step-badge badge-locked">üîí Bloqueado</span>';
                }

                return `
                    <div class="step-card ${!isUnlocked ? 'locked' : ''}" onclick="${isUnlocked ? `navigateToStep(${step.id})` : ''}">
                        <div class="step-info">
                            <div class="step-number">Etapa ${step.id}</div>
                            <div class="step-title">${step.title}</div>
                        </div>
                        ${badge}
                    </div>
                `;
            }).join('');
        }

        async function loadExercises() {
            // Setup tabs first (remove old listeners)
            const tabs = document.querySelectorAll('.exercises-tabs .tab');
            tabs.forEach(tab => {
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
            });

            // Add new listeners
            document.querySelectorAll('.exercises-tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.exercises-tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.tab === 'pending') {
                        document.getElementById('pendingExercises').classList.remove('hidden');
                        document.getElementById('completedExercisesList').classList.add('hidden');
                    } else {
                        document.getElementById('pendingExercises').classList.add('hidden');
                        document.getElementById('completedExercisesList').classList.remove('hidden');
                    }
                });
            });

            try {
                const exercisesRef = collection(db, 'exercises');
                const q = query(
                    exercisesRef,
                    where('userId', '==', currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                const exercises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort by createdAt manually
                exercises.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                console.log('Ejercicios cargados:', exercises);

                const pending = exercises.filter(e => e.status === 'draft' || e.status === 'pending');
                const completed = exercises.filter(e => e.status === 'completed');

                renderExercisesList('pendingExercises', pending);
                renderExercisesList('completedExercisesList', completed);
            } catch (error) {
                console.error('Error loading exercises:', error);
                document.getElementById('pendingExercises').innerHTML = 
                    `<p style="color: #ef4444; text-align: center; padding: 2rem;">Error al cargar ejercicios: ${error.message}</p>`;
            }
        }

        function renderExercisesList(containerId, exercises) {
            const container = document.getElementById(containerId);
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay ejercicios aqu√≠</p>';
                return;
            }

            container.innerHTML = exercises.map(exercise => {
                let typeClass, typeLabel;
                
                if (exercise.type === 'weekly') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Semanal';
                } else if (exercise.type === 'monthly') {
                    typeClass = 'type-monthly';
                    typeLabel = 'Mensual';
                } else if (exercise.type === 'quarterly') {
                    typeClass = 'type-quarterly';
                    typeLabel = 'Trimestral';
                } else if (exercise.type === 'pattern') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Diario de Patrones';
                }
                
                let date = 'Sin fecha';
                if (exercise.createdAt) {
                    try {
                        if (exercise.createdAt.toDate) {
                            date = exercise.createdAt.toDate().toLocaleDateString('es-ES');
                        } else if (exercise.createdAt.seconds) {
                            date = new Date(exercise.createdAt.seconds * 1000).toLocaleDateString('es-ES');
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e);
                    }
                }
                
                const statusLabel = exercise.status === 'draft' ? 'üìù Borrador' : 
                                    exercise.status === 'pending' ? '‚è≥ En revisi√≥n' : '‚úÖ Completado';

                return `
                    <div class="exercise-card" onclick="openExercise('${exercise.id}')">
                        <div class="exercise-info">
                            <h3>${typeLabel}</h3>
                            <div class="exercise-meta">${date} ¬∑ ${statusLabel}</div>
                        </div>
                        <span class="exercise-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        window.createMyExercise = async function(type) {
            if (!currentUser) return;

            try {
                const exerciseData = {
                    userId: currentUser.uid,
                    type: type,
                    status: 'draft',
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                };

                // Add empty fields based on type
                if (type === 'pattern') {
                    exerciseData.when = '';
                    exerciseData.feeling = '';
                    exerciseData.action = '';
                } else {
                    exerciseData.tradesWon = 0;
                    exerciseData.tradesLost = 0;
                    exerciseData.tradesBreakeven = 0;
                    exerciseData.pnl = 0;
                    exerciseData.whatWorked = '';
                    exerciseData.whatDidntWork = '';
                    exerciseData.struggles = '';
                    exerciseData.wins = '';
                    exerciseData.whatChange = '';
                    exerciseData.kpis = '';
                }

                const docRef = await addDoc(collection(db, 'exercises'), exerciseData);
                
                showSuccess('‚úÖ Ejercicio creado! Ahora puedes completarlo');
                
                // Open the newly created exercise
                await openExercise(docRef.id);
            } catch (error) {
                console.error('Error creating exercise:', error);
                showError('Error al crear el ejercicio: ' + error.message);
            }
        }

        window.openExercise = async function(exerciseId) {
            try {
                const exerciseDoc = await getDoc(doc(db, 'exercises', exerciseId));
                if (!exerciseDoc.exists()) {
                    showError('Ejercicio no encontrado');
                    return;
                }

                currentExercise = { id: exerciseId, ...exerciseDoc.data() };
                console.log('Ejercicio cargado:', currentExercise);
                
                // Set title based on type
                let titleText = '';
                if (currentExercise.type === 'weekly') titleText = 'Revisi√≥n Semanal';
                else if (currentExercise.type === 'monthly') titleText = 'Revisi√≥n Mensual';
                else if (currentExercise.type === 'quarterly') titleText = 'Revisi√≥n Trimestral';
                else if (currentExercise.type === 'pattern') titleText = 'Diario de Patrones';
                
                document.getElementById('exerciseFormTitle').textContent = titleText;
                
                // Load appropriate form based on type
                const formContent = document.getElementById('reviewFormContent');
                if (currentExercise.type === 'pattern') {
                    formContent.innerHTML = getPatternFormHTML();
                } else {
                    formContent.innerHTML = getReviewFormHTML();
                }
                
                // Fill form with existing data
                fillExerciseForm(currentExercise);

                // Show review if completed
                const reviewSection = document.getElementById('reviewSection');
                if (currentExercise.status === 'completed' && currentExercise.mentorFeedback) {
                    reviewSection.classList.remove('hidden');
                    document.getElementById('reviewContent').textContent = currentExercise.mentorFeedback;
                } else {
                    reviewSection.classList.add('hidden');
                }

                // Disable form if completed
                const isCompleted = currentExercise.status === 'completed';
                document.querySelectorAll('#exerciseForm input, #exerciseForm textarea').forEach(field => {
                    field.disabled = isCompleted;
                });
                document.getElementById('submitExerciseBtn').disabled = isCompleted;

                navigateToPage('exerciseForm');
                
                // Setup form after navigating
                setTimeout(() => {
                    setupExerciseFormHandlers();
                }, 100);
            } catch (error) {
                console.error('Error opening exercise:', error);
                showError('Error al abrir el ejercicio: ' + error.message);
            }
        }

        function setupExerciseFormHandlers() {
            console.log('Setting up form handlers...');
            
            // Remove old submit listener
            const form = document.getElementById('exerciseForm');
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Add new submit listener
            document.getElementById('exerciseForm').addEventListener('submit', handleExerciseSubmit);
            
            // Setup auto-save
            setupAutoSave();
            
            console.log('Form handlers ready');
        }

        async function handleExerciseSubmit(e) {
            e.preventDefault();
            console.log('Form submitted!');
            
            if (!currentExercise) {
                console.error('No current exercise');
                return;
            }

            const submitBtn = document.getElementById('submitExerciseBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            let exerciseData = {
                status: 'pending',
                submittedAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            };

            try {
                if (currentExercise.type === 'pattern') {
                    exerciseData.when = document.getElementById('when').value;
                    exerciseData.feeling = document.getElementById('feeling').value;
                    exerciseData.action = document.getElementById('action').value;
                    
                    console.log('Pattern data:', exerciseData);
                } else {
                    exerciseData.tradesWon = parseInt(document.getElementById('tradesWon').value) || 0;
                    exerciseData.tradesLost = parseInt(document.getElementById('tradesLost').value) || 0;
                    exerciseData.tradesBreakeven = parseInt(document.getElementById('tradesBreakeven').value) || 0;
                    exerciseData.pnl = parseFloat(document.getElementById('pnl').value) || 0;
                    exerciseData.whatWorked = document.getElementById('whatWorked').value;
                    exerciseData.whatDidntWork = document.getElementById('whatDidntWork').value;
                    exerciseData.struggles = document.getElementById('struggles').value;
                    exerciseData.wins = document.getElementById('wins').value;
                    exerciseData.whatChange = document.getElementById('whatChange').value;
                    exerciseData.kpis = document.getElementById('kpis').value;
                    
                    console.log('Review data:', exerciseData);
                }

                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
                console.log('Exercise submitted successfully');
                
                showSuccess('¬°Ejercicio enviado para revisi√≥n!');
                setTimeout(() => {
                    navigateToPage('exercises');
                    loadExercises();
                }, 1500);
            } catch (error) {
                console.error('Error submitting exercise:', error);
                showError('Error al enviar el ejercicio: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar para Revisi√≥n';
            }
        }

        function getReviewFormHTML() {
            return `
                <div class="form-section">
                    <div class="form-section-title">üìä M√©tricas</div>
                    <div class="form-section-desc">Resultados num√©ricos de tu trading</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ganadas</label>
                            <input type="number" id="tradesWon" class="form-input" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Perdidas</label>
                            <input type="number" id="tradesLost" class="form-input" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Breakeven</label>
                            <input type="number" id="tradesBreakeven" class="form-input" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">P&L ($)</label>
                            <input type="number" id="pnl" class="form-input" step="0.01" value="0" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">‚úÖ Qu√© funcion√≥</div>
                    <div class="form-section-desc">Describe qu√© estrategias, comportamientos o decisiones dieron resultado</div>
                    <div class="form-group">
                        <textarea id="whatWorked" class="form-textarea" placeholder="Ej: Respet√© mi plan de trading, esper√© setups claros, mantuve mi risk management..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">‚ùå Qu√© no funcion√≥</div>
                    <div class="form-section-desc">Identifica errores, patrones negativos o decisiones que no dieron resultado</div>
                    <div class="form-group">
                        <textarea id="whatDidntWork" class="form-textarea" placeholder="Ej: Forc√© trades sin setup, sal√≠ antes de tiempo por miedo..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üòì Algo que me cost√≥</div>
                    <div class="form-section-desc">¬øQu√© te result√≥ dif√≠cil o desafiante en este per√≠odo?</div>
                    <div class="form-group">
                        <textarea id="struggles" class="form-textarea" placeholder="Ej: Me cost√≥ mantener la disciplina despu√©s de una p√©rdida, controlar la ansiedad..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üèÜ Un win (logro)</div>
                    <div class="form-section-desc">Celebra un logro, por peque√±o que sea</div>
                    <div class="form-group">
                        <textarea id="wins" class="form-textarea" placeholder="Ej: Logr√© seguir mi checklist todos los d√≠as, tuve mi mejor semana en ganancias..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üîÑ Qu√© cambiar√≠a esta semana para mejorar</div>
                    <div class="form-section-desc">Acciones espec√≠ficas que tomar√°s para mejorar</div>
                    <div class="form-group">
                        <textarea id="whatChange" class="form-textarea" placeholder="Ej: Voy a reducir el tama√±o de posici√≥n en d√≠as vol√°tiles, har√© m√°s breaks..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üéØ KPIs de Proceso</div>
                    <div class="form-section-desc">Define objetivos de proceso (comportamientos) para el siguiente per√≠odo</div>
                    <div class="form-group">
                        <textarea id="kpis" class="form-textarea" placeholder="Ej: Seguir mi checklist 100% de los d√≠as, hacer journaling post-trade, respetar mis horarios de trading, tomar 1 break cada 2 horas..." required></textarea>
                    </div>
                </div>
            `;
        }

        function getPatternFormHTML() {
            return `
                <div class="form-section">
                    <div class="form-section-title">üß† Diario de Patrones de Ejecuci√≥n</div>
                    <div class="form-section-desc">Identifica patrones en tu comportamiento. L√≠mite: 100 palabras por campo</div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üìÖ Cu√°ndo ha pasado</div>
                    <div class="form-section-desc">Describe el contexto y momento (m√°x 100 palabras)</div>
                    <div class="form-group">
                        <textarea id="when" class="form-textarea" maxlength="600" placeholder="Ej: Despu√©s de 2 p√©rdidas seguidas, cuando el mercado estaba muy vol√°til..." required></textarea>
                        <div style="text-align: right; color: #a1a1aa; font-size: 0.85rem; margin-top: 0.25rem;">
                            <span id="whenCount">0</span>/600 caracteres (~100 palabras)
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üí≠ C√≥mo me he sentido / Qu√© he pensado</div>
                    <div class="form-section-desc">Tus emociones y pensamientos en ese momento (m√°x 100 palabras)</div>
                    <div class="form-group">
                        <textarea id="feeling" class="form-textarea" maxlength="600" placeholder="Ej: Me sent√≠ frustrado y ansioso. Pens√© que ten√≠a que recuperar lo perdido r√°pido..." required></textarea>
                        <div style="text-align: right; color: #a1a1aa; font-size: 0.85rem; margin-top: 0.25rem;">
                            <span id="feelingCount">0</span>/600 caracteres (~100 palabras)
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">‚ö° Qu√© he hecho</div>
                    <div class="form-section-desc">Tu acci√≥n y comportamiento (m√°x 100 palabras)</div>
                    <div class="form-group">
                        <textarea id="action" class="form-textarea" maxlength="600" placeholder="Ej: Entr√© en un trade sin setup claro, aument√© el tama√±o de posici√≥n para recuperar..." required></textarea>
                        <div style="text-align: right; color: #a1a1aa; font-size: 0.85rem; margin-top: 0.25rem;">
                            <span id="actionCount">0</span>/600 caracteres (~100 palabras)
                        </div>
                    </div>
                </div>
            `;
        }

        function fillExerciseForm(exercise) {
            if (exercise.type === 'pattern') {
                document.getElementById('when').value = exercise.when || '';
                document.getElementById('feeling').value = exercise.feeling || '';
                document.getElementById('action').value = exercise.action || '';
                
                // Setup character counters
                ['when', 'feeling', 'action'].forEach(field => {
                    const textarea = document.getElementById(field);
                    const counter = document.getElementById(`${field}Count`);
                    counter.textContent = textarea.value.length;
                    
                    textarea.addEventListener('input', function() {
                        counter.textContent = this.value.length;
                    });
                });
            } else {
                document.getElementById('tradesWon').value = exercise.tradesWon || 0;
                document.getElementById('tradesLost').value = exercise.tradesLost || 0;
                document.getElementById('tradesBreakeven').value = exercise.tradesBreakeven || 0;
                document.getElementById('pnl').value = exercise.pnl || 0;
                document.getElementById('whatWorked').value = exercise.whatWorked || '';
                document.getElementById('whatDidntWork').value = exercise.whatDidntWork || '';
                document.getElementById('struggles').value = exercise.struggles || '';
                document.getElementById('wins').value = exercise.wins || '';
                document.getElementById('whatChange').value = exercise.whatChange || '';
                document.getElementById('kpis').value = exercise.kpis || '';
            }
        }

        function setupAutoSave() {
            let fields = [];
            
            if (currentExercise.type === 'pattern') {
                fields = ['when', 'feeling', 'action'];
            } else {
                fields = ['tradesWon', 'tradesLost', 'tradesBreakeven', 'pnl', 'whatWorked', 'whatDidntWork', 'struggles', 'wins', 'whatChange', 'kpis'];
            }
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', () => {
                        clearTimeout(autoSaveTimer);
                        updateAutoSaveIndicator('saving');
                        
                        autoSaveTimer = setTimeout(async () => {
                            await saveAsDraft();
                            updateAutoSaveIndicator('saved');
                        }, 2000);
                    });
                }
            });
        }

        function updateAutoSaveIndicator(state) {
            const indicator = document.getElementById('autoSaveIndicator');
            const text = document.getElementById('autoSaveText');
            
            indicator.className = 'auto-save-indicator';
            
            if (state === 'saving') {
                indicator.classList.add('saving');
                text.textContent = 'üíæ Guardando...';
            } else if (state === 'saved') {
                indicator.classList.add('saved');
                text.textContent = '‚úì Guardado';
                setTimeout(() => {
                    indicator.className = 'auto-save-indicator';
                    text.textContent = 'Sin cambios';
                }, 2000);
            }
        }

        window.saveAsDraft = async function() {
            if (!currentExercise) {
                console.error('No current exercise to save');
                return;
            }

            console.log('Saving draft...');

            let exerciseData = {
                status: 'draft',
                updatedAt: Timestamp.now()
            };

            try {
                if (currentExercise.type === 'pattern') {
                    const whenField = document.getElementById('when');
                    const feelingField = document.getElementById('feeling');
                    const actionField = document.getElementById('action');
                    
                    if (whenField) exerciseData.when = whenField.value;
                    if (feelingField) exerciseData.feeling = feelingField.value;
                    if (actionField) exerciseData.action = actionField.value;
                } else {
                    const tradesWonField = document.getElementById('tradesWon');
                    const tradesLostField = document.getElementById('tradesLost');
                    const tradesBreakevenField = document.getElementById('tradesBreakeven');
                    const pnlField = document.getElementById('pnl');
                    const whatWorkedField = document.getElementById('whatWorked');
                    const whatDidntWorkField = document.getElementById('whatDidntWork');
                    const strugglesField = document.getElementById('struggles');
                    const winsField = document.getElementById('wins');
                    const whatChangeField = document.getElementById('whatChange');
                    const kpisField = document.getElementById('kpis');
                    
                    if (tradesWonField) exerciseData.tradesWon = parseInt(tradesWonField.value) || 0;
                    if (tradesLostField) exerciseData.tradesLost = parseInt(tradesLostField.value) || 0;
                    if (tradesBreakevenField) exerciseData.tradesBreakeven = parseInt(tradesBreakevenField.value) || 0;
                    if (pnlField) exerciseData.pnl = parseFloat(pnlField.value) || 0;
                    if (whatWorkedField) exerciseData.whatWorked = whatWorkedField.value;
                    if (whatDidntWorkField) exerciseData.whatDidntWork = whatDidntWorkField.value;
                    if (strugglesField) exerciseData.struggles = strugglesField.value;
                    if (winsField) exerciseData.wins = winsField.value;
                    if (whatChangeField) exerciseData.whatChange = whatChangeField.value;
                    if (kpisField) exerciseData.kpis = kpisField.value;
                }

                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
                console.log('Draft saved successfully');
            } catch (error) {
                console.error('Error saving draft:', error);
                showError('Error al guardar: ' + error.message);
            }
        }

        async function loadCalendar() {
            const locked = document.getElementById('calendarLocked');
            const unlocked = document.getElementById('calendarUnlocked');
            
            if (userData?.calendarUnlocked || userData?.role === 'admin') {
                locked.classList.add('hidden');
                unlocked.classList.remove('hidden');
            } else {
                locked.classList.remove('hidden');
                unlocked.classList.add('hidden');
            }
        }

        // ========================================
        // STAGE 0: SELF-ASSESSMENT FUNCTIONS
        // ========================================

        const assessmentAreas = [
            { id: 'relationships', label: '‚ù§Ô∏è Relaciones', icon: '‚ù§Ô∏è' },
            { id: 'money', label: 'üí∞ Dinero', icon: 'üí∞' },
            { id: 'health', label: 'üèÉ Salud', icon: 'üèÉ' },
            { id: 'spirituality', label: 'üôè Espiritualidad', icon: 'üôè' },
            { id: 'growth', label: 'üå± Crecimiento Personal', icon: 'üå±' },
            { id: 'contribution', label: 'üåç Contribuci√≥n al mundo', icon: 'üåç' },
            { id: 'leisure', label: 'üéÆ Ocio', icon: 'üéÆ' },
            { id: 'family', label: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia y Amigos', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
            { id: 'work', label: 'üíº Trabajo', icon: 'üíº' },
            { id: 'trading', label: 'üìà Trading', icon: 'üìà' }
        ];

        async function loadStage0Assessment() {
            if (!currentUser) return;

            try {
                // Load existing assessment
                const assessmentQuery = query(
                    collection(db, 'stage0Assessment'),
                    where('userId', '==', currentUser.uid)
                );
                const assessmentSnapshot = await getDocs(assessmentQuery);
                
                if (!assessmentSnapshot.empty) {
                    stage0Data = { id: assessmentSnapshot.docs[0].id, ...assessmentSnapshot.docs[0].data() };
                } else {
                    // Initialize with default values
                    stage0Data = {
                        userId: currentUser.uid,
                        areas: {}
                    };
                    assessmentAreas.forEach(area => {
                        stage0Data.areas[area.id] = 5; // Default value
                    });
                }

                renderStage0Assessment();
            } catch (error) {
                console.error('Error loading Stage 0 assessment:', error);
                showError('Error al cargar la auto-evaluaci√≥n');
            }
        }

        function renderStage0Assessment() {
            const container = document.getElementById('stageToolsSection');
            
            // Calculate average
            let total = 0;
            let count = 0;
            if (stage0Data?.areas) {
                Object.values(stage0Data.areas).forEach(value => {
                    total += value;
                    count++;
                });
            }
            const average = count > 0 ? (total / count).toFixed(1) : 5.0;
            
            const html = `
                <div class="card">
                    <h2 class="card-title">üéØ Auto-evaluaci√≥n de √Åreas de Vida</h2>
                    <p style="color: #a1a1aa; margin-bottom: 2rem;">
                        Eval√∫a del 1 al 10 d√≥nde te encuentras en cada √°rea de tu vida. Esta herramienta te ayudar√° a identificar las √°reas que necesitan m√°s atenci√≥n.
                    </p>

                    <div class="assessment-grid">
                        ${assessmentAreas.map(area => `
                            <div class="assessment-item">
                                <div class="assessment-header">
                                    <div class="assessment-label">
                                        ${area.icon} ${area.label.split(' ').slice(1).join(' ')}
                                    </div>
                                    <div class="assessment-value" id="value_${area.id}">
                                        ${stage0Data?.areas?.[area.id] || 5}
                                    </div>
                                </div>
                                <div class="slider-container">
                                    <input 
                                        type="range" 
                                        min="1" 
                                        max="10" 
                                        value="${stage0Data?.areas?.[area.id] || 5}"
                                        class="slider"
                                        id="slider_${area.id}"
                                        oninput="updateAssessmentValue('${area.id}', this.value)"
                                    >
                                    <div class="slider-labels">
                                        <span>1</span>
                                        <span>5</span>
                                        <span>10</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="average-score">
                        <div class="average-score-number" id="averageScore">${average}</div>
                        <div class="average-score-label">Promedio General</div>
                    </div>

                    <div class="save-indicator" id="stage0SaveIndicator" style="margin-top: 1rem;">
                        <span id="stage0SaveText">Sin cambios</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        window.updateAssessmentValue = function(areaId, value) {
            // Update display
            document.getElementById(`value_${areaId}`).textContent = value;
            
            // Update data
            if (!stage0Data.areas) stage0Data.areas = {};
            stage0Data.areas[areaId] = parseInt(value);
            
            // Recalculate average
            let total = 0;
            let count = 0;
            Object.values(stage0Data.areas).forEach(val => {
                total += val;
                count++;
            });
            const average = count > 0 ? (total / count).toFixed(1) : 5.0;
            document.getElementById('averageScore').textContent = average;
            
            // Schedule auto-save
            scheduleStage0AutoSave();
        }

        function scheduleStage0AutoSave() {
            const indicator = document.getElementById('stage0SaveIndicator');
            const text = document.getElementById('stage0SaveText');
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (stage0AutoSaveTimer) {
                clearTimeout(stage0AutoSaveTimer);
            }

            stage0AutoSaveTimer = setTimeout(async () => {
                await saveStage0Assessment(true);
            }, 2000);
        }

        async function saveStage0Assessment(isAutoSave = false) {
            if (!currentUser || !stage0Data) return;

            try {
                const assessmentData = {
                    userId: currentUser.uid,
                    areas: stage0Data.areas,
                    updatedAt: Timestamp.now()
                };

                if (stage0Data.id) {
                    // Update existing
                    await updateDoc(doc(db, 'stage0Assessment', stage0Data.id), assessmentData);
                } else {
                    // Create new
                    assessmentData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stage0Assessment'), assessmentData);
                    stage0Data.id = docRef.id;
                }

                const indicator = document.getElementById('stage0SaveIndicator');
                const text = document.getElementById('stage0SaveText');
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '‚úì Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('‚úÖ Auto-evaluaci√≥n guardada correctamente');
                }
            } catch (error) {
                console.error('Error saving Stage 0 assessment:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        // ========================================
        // END OF STAGE 0 FUNCTIONS
        // ========================================

        // ========================================
        // STAGE 1: ERRORS MANAGEMENT FUNCTIONS
        // ========================================

        // Framework questions for Stage 1
        const errorQuestions = [
            {
                number: 1,
                text: "Describe el error en detalle",
                help: "Incluye ejemplos del comportamiento, descripciones de tus emociones y mentalidad"
            },
            {
                number: 2,
                text: "¬øQu√© suele pasar justo antes de empezar a participar en este error/comportamiento?",
                help: "Explica las condiciones que lo desencadenan, as√≠ como cualquier respuesta emocional que parezca impulsar este comportamiento"
            },
            {
                number: 3,
                text: "¬øCu√°l es la intenci√≥n positiva que este comportamiento tiene para ti?",
                help: "Aunque sea irracional, explica la l√≥gica o la justificaci√≥n detr√°s del comportamiento"
            },
            {
                number: 4,
                text: "¬øQu√© en tus circunstancias personales contribuyen a este patr√≥n de comportamiento?",
                help: "¬øQu√© hay sobre ti o sobre tu experiencia pasada que podr√≠a ser una raz√≥n por la que tienes esta tendencia?"
            },
            {
                number: 5,
                text: "¬øC√≥mo sabotea este comportamiento tu trading?",
                help: "Describe c√≥mo este comportamiento afecta negativamente tus operaciones a pesar de cualquier intenci√≥n positiva"
            },
            {
                number: 6,
                text: "¬øCu√°l es la mejor manera de lograr las intenciones positivas de la Pregunta 3? (TU TOP LEVEL)",
                help: "¬øQu√© h√°bitos o comportamientos puedes hacer para reemplazar los patrones descritos en el punto 3?"
            },
            {
                number: 7,
                text: "¬øC√≥mo aplicar√°s este Top Level espec√≠ficamente a tu proceso de trading?",
                help: "Describe en detalle las formas en que te asegurar√°s de que puedes aplicar esto"
            }
        ];

        // Load errors for Stage 1
        async function loadStage1Errors() {
            if (!currentUser) return;

            try {
                // Simple query without orderBy to avoid index requirement
                const errorsQuery = query(
                    collection(db, 'stageErrors'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', 1)
                );

                const snapshot = await getDocs(errorsQuery);
                currentErrors = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(error => !error.deleted); // Filter deleted errors

                // Sort manually by createdAt
                currentErrors.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                renderErrorsList();
            } catch (error) {
                console.error('Error loading errors:', error);
                showError('Error al cargar tus errores: ' + error.message);
            }
        }

        // Render errors list
        function renderErrorsList() {
            const container = document.getElementById('stageToolsSection');
            
            const errorsListHTML = `
                <div class="items-list-container">
                    <div class="items-header">
                        <h3>‚ùå Mis Errores Identificados</h3>
                        <button class="btn btn-small" onclick="showErrorEditor(null)">
                            ‚ûï A√±adir Nuevo Error
                        </button>
                    </div>

                    ${currentErrors.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéØ</div>
                            <div class="empty-state-title">A√∫n no has identificado errores</div>
                            <div class="empty-state-text">
                                Haz clic en "A√±adir Nuevo Error" para comenzar a identificar los patrones que quieres mejorar en tu trading.
                            </div>
                        </div>
                    ` : `
                        <div class="items-list">
                            ${currentErrors.map(error => `
                                <div class="item-card" onclick="showErrorEditor('${error.id}')">
                                    <div class="item-info">
                                        <div class="item-title">‚ùå ${error.title || 'Error sin t√≠tulo'}</div>
                                        <div class="item-status">
                                            ${error.completedQuestions || 0}/7 preguntas completadas
                                        </div>
                                    </div>
                                    <div class="item-actions" onclick="event.stopPropagation()">
                                        <button class="btn-icon edit" onclick="showErrorEditor('${error.id}')">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button class="btn-icon delete" onclick="deleteError('${error.id}')">
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;

            container.innerHTML = errorsListHTML;
            container.classList.remove('hidden');
        }

        // Show error editor
        window.showErrorEditor = async function(errorId) {
            currentErrorId = errorId;
            let errorData = null;

            // If editing existing error, load it
            if (errorId) {
                errorData = currentErrors.find(e => e.id === errorId);
            }

            const container = document.getElementById('stageToolsSection');
            
            const editorHTML = `
                <div class="item-editor">
                    <div class="item-editor-header">
                        <div>
                            <button onclick="cancelErrorEditor()" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; font-size: 1rem; margin-bottom: 0.5rem;">
                                ‚Üê Volver a la lista
                            </button>
                            <h2 class="item-editor-title">
                                ${errorId ? '‚úèÔ∏è Editar Error' : '‚ûï Nuevo Error'}
                            </h2>
                        </div>
                        <div class="save-indicator" id="errorSaveIndicator">
                            <span id="errorSaveText">Sin cambios</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label class="form-label">Nombre del error *</label>
                        <input 
                            type="text" 
                            id="errorTitle" 
                            class="form-input" 
                            placeholder="Ej: Overtrading, FOMO, Revenge trading..."
                            value="${errorData?.title || ''}"
                            oninput="scheduleErrorAutoSave()"
                        >
                    </div>

                    ${errorQuestions.map((q, index) => `
                        <div class="question-block">
                            <div class="question-number">Pregunta ${q.number}</div>
                            <div class="question-text">${q.text}</div>
                            <div class="question-help">${q.help}</div>
                            <textarea 
                                id="errorAnswer${q.number}" 
                                class="form-textarea" 
                                placeholder="Escribe tu respuesta aqu√≠..."
                                oninput="scheduleErrorAutoSave()"
                                style="min-height: 150px;"
                            >${errorData?.answers?.[index] || ''}</textarea>
                        </div>
                    `).join('')}

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="cancelErrorEditor()">
                            Cancelar
                        </button>
                        <button class="btn" onclick="saveError()">
                            üíæ Guardar Error
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = editorHTML;
        }

        // Schedule auto-save for errors
        window.scheduleErrorAutoSave = function() {
            const indicator = document.getElementById('errorSaveIndicator');
            const text = document.getElementById('errorSaveText');
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (errorAutoSaveTimer) {
                clearTimeout(errorAutoSaveTimer);
            }

            errorAutoSaveTimer = setTimeout(async () => {
                await saveError(true);
            }, 2000);
        }

        // Save error - FIXED VERSION
        window.saveError = async function(isAutoSave = false) {
            const titleElement = document.getElementById('errorTitle');
            const title = titleElement?.value?.trim();
            
            if (!title && !isAutoSave) {
                showError('Por favor ingresa un nombre para el error');
                return;
            }

            if (!currentUser) return;

            try {
                const answers = [];
                let completedQuestions = 0;

                for (let i = 1; i <= 7; i++) {
                    const answerElement = document.getElementById(`errorAnswer${i}`);
                    const answer = answerElement?.value?.trim() || '';
                    answers.push(answer);
                    if (answer) completedQuestions++;
                }

                const errorData = {
                    userId: currentUser.uid,
                    stageId: 1,
                    title: title || 'Error sin t√≠tulo',
                    answers: answers,
                    completedQuestions: completedQuestions,
                    deleted: false, // Always include this field
                    updatedAt: Timestamp.now()
                };

                if (currentErrorId) {
                    // Update existing error
                    await updateDoc(doc(db, 'stageErrors', currentErrorId), errorData);
                    console.log('Error updated:', currentErrorId);
                } else {
                    // Create new error
                    errorData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stageErrors'), errorData);
                    currentErrorId = docRef.id;
                    console.log('Error created:', docRef.id);
                }

                const indicator = document.getElementById('errorSaveIndicator');
                const text = document.getElementById('errorSaveText');
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '‚úì Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('‚úÖ Error guardado correctamente');
                    await loadStage1Errors();
                }
            } catch (error) {
                console.error('Error saving:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        // Cancel error editor
        window.cancelErrorEditor = function() {
            currentErrorId = null;
            if (errorAutoSaveTimer) {
                clearTimeout(errorAutoSaveTimer);
            }
            renderErrorsList();
        }

        // Delete error
        window.deleteError = async function(errorId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este error? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                await updateDoc(doc(db, 'stageErrors', errorId), {
                    deleted: true,
                    deletedAt: Timestamp.now()
                });

                showSuccess('‚úÖ Error eliminado');
                await loadStage1Errors();
            } catch (error) {
                console.error('Error deleting:', error);
                showError('Error al eliminar el error');
            }
        }

        // ========================================
        // END OF STAGE 1 FUNCTIONS
        // ========================================

        // ========================================
        // STAGE 2: TOOLS MANAGEMENT FUNCTIONS
        // ========================================

        // RED tool types
        const redToolTypes = [
            { id: 'daily', label: 'Diaria', icon: 'üìÖ' },
            { id: 'weekly', label: 'Semanal', icon: 'üìÜ' },
            { id: 'monthly', label: 'Mensual', icon: 'üìä' }
        ];

        // Load all Stage 2 tools
        async function loadStage2Tools() {
            if (!currentUser) return;

            const container = document.getElementById('stageToolsSection');
            
            // Create collapsible cards for each tool
            const html = `
                <div class="tool-card-compact" id="redToolCard">
                    <div class="tool-card-header" onclick="toggleToolCard('redToolCard')">
                        <div class="tool-card-header-left">
                            <div class="tool-card-icon">üîÑ</div>
                            <div class="tool-card-title-group">
                                <h3>RED: Reinicio-Evaluaci√≥n-Direcci√≥n</h3>
                                <div class="tool-card-subtitle">Proceso de 3 pasos para redirigir tu enfoque</div>
                            </div>
                        </div>
                        <div class="tool-card-expand-icon">‚ñº</div>
                    </div>
                    <div class="tool-card-body">
                        <div class="tool-card-content" id="redToolContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="tool-card-compact" id="systemsToolCard">
                    <div class="tool-card-header" onclick="toggleToolCard('systemsToolCard')">
                        <div class="tool-card-header-left">
                            <div class="tool-card-icon">‚öôÔ∏è</div>
                            <div class="tool-card-title-group">
                                <h3>Sistemas y Procesos</h3>
                                <div class="tool-card-subtitle">Define tus reglas, l√≠mites y procesos de trading</div>
                            </div>
                        </div>
                        <div class="tool-card-expand-icon">‚ñº</div>
                    </div>
                    <div class="tool-card-body">
                        <div class="tool-card-content" id="systemsToolContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="tool-card-compact" id="habitsToolCard">
                    <div class="tool-card-header" onclick="toggleToolCard('habitsToolCard')">
                        <div class="tool-card-header-left">
                            <div class="tool-card-icon">üéØ</div>
                            <div class="tool-card-title-group">
                                <h3>H√°bitos y Rutinas</h3>
                                <div class="tool-card-subtitle">Define h√°bitos claros y repetibles</div>
                            </div>
                        </div>
                        <div class="tool-card-expand-icon">‚ñº</div>
                    </div>
                    <div class="tool-card-body">
                        <div class="tool-card-content" id="habitsToolContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');

            // Load each tool's content
            await loadREDTool();
            await loadSystemsTool();
            await loadHabitsTool();
        }

        window.toggleToolCard = function(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('expanded');
        }

        // ========================================
        // RED TOOL (Duplicable)
        // ========================================

        async function loadREDTool() {
            if (!currentUser) return;

            try {
                // Simple query without orderBy to avoid index requirement
                const redQuery = query(
                    collection(db, 'stage2RED'),
                    where('userId', '==', currentUser.uid)
                );

                const snapshot = await getDocs(redQuery);
                currentREDItems = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(item => !item.deleted); // Filter deleted items

                // Sort manually by createdAt
                currentREDItems.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                renderREDList();
            } catch (error) {
                console.error('Error loading RED items:', error);
                showError('Error al cargar herramientas RED: ' + error.message);
            }
        }

        function renderREDList() {
            const container = document.getElementById('redToolContent');
            
            const html = `
                <div class="items-list-container" style="padding: 0;">
                    <div class="items-header">
                        <div>
                            <p style="color: #a1a1aa; margin-bottom: 1rem; font-size: 0.9rem;">
                                Crea diferentes versiones de RED para distintas situaciones (diaria, semanal, despu√©s de errores, etc.)
                            </p>
                        </div>
                        <button class="btn btn-small" onclick="showREDEditor(null)">
                            ‚ûï Nueva RED
                        </button>
                    </div>

                    ${currentREDItems.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîÑ</div>
                            <div class="empty-state-title">A√∫n no has creado ninguna RED</div>
                            <div class="empty-state-text">
                                Haz clic en "Nueva RED" para crear tu primer proceso de Reinicio-Evaluaci√≥n-Direcci√≥n.
                            </div>
                        </div>
                    ` : `
                        <div class="items-list">
                            ${currentREDItems.map(item => {
                                const typeLabel = redToolTypes.find(t => t.id === item.type)?.label || item.customType || 'Personalizada';
                                const isComplete = item.step1 && item.step2 && item.step3;
                                return `
                                    <div class="item-card" onclick="showREDEditor('${item.id}')">
                                        <div class="item-info">
                                            <div class="item-title">üîÑ RED ${typeLabel}</div>
                                            <div class="item-status">
                                                ${isComplete ? '‚úì Completada' : '‚óã Incompleta'}
                                            </div>
                                        </div>
                                        <div class="item-actions" onclick="event.stopPropagation()">
                                            <button class="btn-icon edit" onclick="showREDEditor('${item.id}')">
                                                ‚úèÔ∏è Editar
                                            </button>
                                            <button class="btn-icon delete" onclick="deleteREDItem('${item.id}')">
                                                üóëÔ∏è Eliminar
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;

            container.innerHTML = html;
        }

        window.showREDEditor = function(redId) {
            currentREDId = redId;
            let redData = null;

            if (redId) {
                redData = currentREDItems.find(r => r.id === redId);
            }

            const container = document.getElementById('redToolContent');
            
            const editorHTML = `
                <div class="item-editor" style="padding: 0;">
                    <div class="item-editor-header">
                        <div>
                            <button onclick="cancelREDEditor()" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; font-size: 1rem; margin-bottom: 0.5rem;">
                                ‚Üê Volver a la lista
                            </button>
                            <h3 class="item-editor-title">
                                ${redId ? '‚úèÔ∏è Editar RED' : '‚ûï Nueva RED'}
                            </h3>
                        </div>
                        <div class="save-indicator" id="redSaveIndicator">
                            <span id="redSaveText">Sin cambios</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Tipo de RED *</label>
                        <select id="redType" class="form-select" onchange="toggleCustomREDType()">
                            <option value="">Selecciona un tipo...</option>
                            ${redToolTypes.map(type => `
                                <option value="${type.id}" ${redData?.type === type.id ? 'selected' : ''}>
                                    ${type.icon} ${type.label}
                                </option>
                            `).join('')}
                            <option value="custom" ${redData?.type === 'custom' ? 'selected' : ''}>
                                ‚ú® Personalizada (Otra)
                            </option>
                        </select>
                    </div>

                    <div class="form-group ${redData?.type === 'custom' ? '' : 'hidden'}" id="customTypeGroup" style="margin-bottom: 2rem;">
                        <label class="form-label">Nombre personalizado *</label>
                        <input 
                            type="text" 
                            id="redCustomType" 
                            class="form-input" 
                            placeholder="Ej: Despu√©s de errores, Post-p√©rdida, etc."
                            value="${redData?.customType || ''}"
                            oninput="scheduleREDAutoSave()"
                        >
                    </div>

                    <div class="question-block">
                        <div class="question-number">Paso 1</div>
                        <div class="question-text">Reinicio</div>
                        <div class="question-help">¬øC√≥mo te reinicias cuando est√°s frustrado o fuera de balance?</div>
                        <textarea 
                            id="redStep1" 
                            class="form-textarea" 
                            placeholder="Describe tu proceso de reinicio..."
                            oninput="scheduleREDAutoSave()"
                            style="min-height: 120px;"
                        >${redData?.step1 || ''}</textarea>
                    </div>

                    <div class="question-block">
                        <div class="question-number">Paso 2</div>
                        <div class="question-text">Evaluaci√≥n</div>
                        <div class="question-help">¬øC√≥mo eval√∫as tu estado actual y tus operaciones?</div>
                        <textarea 
                            id="redStep2" 
                            class="form-textarea" 
                            placeholder="Describe tu proceso de evaluaci√≥n..."
                            oninput="scheduleREDAutoSave()"
                            style="min-height: 120px;"
                        >${redData?.step2 || ''}</textarea>
                    </div>

                    <div class="question-block">
                        <div class="question-number">Paso 3</div>
                        <div class="question-text">Direcci√≥n</div>
                        <div class="question-help">¬øHacia d√≥nde diriges tu atenci√≥n y esfuerzo despu√©s?</div>
                        <textarea 
                            id="redStep3" 
                            class="form-textarea" 
                            placeholder="Describe tu proceso de direcci√≥n..."
                            oninput="scheduleREDAutoSave()"
                            style="min-height: 120px;"
                        >${redData?.step3 || ''}</textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="cancelREDEditor()">
                            Cancelar
                        </button>
                        <button class="btn" onclick="saveREDItem()">
                            üíæ Guardar RED
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = editorHTML;
        }

        window.toggleCustomREDType = function() {
            const typeSelect = document.getElementById('redType');
            const customGroup = document.getElementById('customTypeGroup');
            
            if (typeSelect.value === 'custom') {
                customGroup.classList.remove('hidden');
            } else {
                customGroup.classList.add('hidden');
            }
        }

        window.scheduleREDAutoSave = function() {
            const indicator = document.getElementById('redSaveIndicator');
            const text = document.getElementById('redSaveText');
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (redAutoSaveTimer) {
                clearTimeout(redAutoSaveTimer);
            }

            redAutoSaveTimer = setTimeout(async () => {
                await saveREDItem(true);
            }, 2000);
        }

        window.saveREDItem = async function(isAutoSave = false) {
            const type = document.getElementById('redType')?.value;
            const customType = document.getElementById('redCustomType')?.value?.trim();
            const step1 = document.getElementById('redStep1')?.value?.trim();
            const step2 = document.getElementById('redStep2')?.value?.trim();
            const step3 = document.getElementById('redStep3')?.value?.trim();
            
            if (!type && !isAutoSave) {
                showError('Por favor selecciona un tipo de RED');
                return;
            }

            if (type === 'custom' && !customType && !isAutoSave) {
                showError('Por favor ingresa un nombre personalizado');
                return;
            }

            if (!currentUser) return;

            try {
                const redData = {
                    userId: currentUser.uid,
                    type: type || 'custom',
                    customType: type === 'custom' ? customType : '',
                    step1: step1 || '',
                    step2: step2 || '',
                    step3: step3 || '',
                    deleted: false, // Always include this field
                    updatedAt: Timestamp.now()
                };

                if (currentREDId) {
                    await updateDoc(doc(db, 'stage2RED', currentREDId), redData);
                } else {
                    redData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stage2RED'), redData);
                    currentREDId = docRef.id;
                }

                const indicator = document.getElementById('redSaveIndicator');
                const text = document.getElementById('redSaveText');
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '‚úì Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('‚úÖ RED guardada correctamente');
                    await loadREDTool();
                }
            } catch (error) {
                console.error('Error saving RED:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        window.cancelREDEditor = function() {
            currentREDId = null;
            if (redAutoSaveTimer) {
                clearTimeout(redAutoSaveTimer);
            }
            renderREDList();
        }

        window.deleteREDItem = async function(redId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta RED?')) {
                return;
            }

            try {
                await updateDoc(doc(db, 'stage2RED', redId), {
                    deleted: true,
                    deletedAt: Timestamp.now()
                });

                showSuccess('‚úÖ RED eliminada');
                await loadREDTool();
            } catch (error) {
                console.error('Error deleting RED:', error);
                showError('Error al eliminar la RED');
            }
        }

        // ========================================
        // SYSTEMS TOOL (Expandable sections with multiple items)
        // ========================================

        async function loadSystemsTool() {
            if (!currentUser) return;

            try {
                const systemsQuery = query(
                    collection(db, 'stage2Systems'),
                    where('userId', '==', currentUser.uid)
                );

                const snapshot = await getDocs(systemsQuery);
                
                if (!snapshot.empty) {
                    stage2SystemsData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                } else {
                    stage2SystemsData = {
                        userId: currentUser.uid,
                        markets: [],
                        riskParams: [],
                        tradingLimits: {},
                        positionManagement: {},
                        preMarketPrep: [],
                        prohibitedConditions: [],
                        successBehaviors: {},
                        professionalGuidelines: {}
                    };
                }

                renderSystemsTool();
            } catch (error) {
                console.error('Error loading Systems tool:', error);
                document.getElementById('systemsToolContent').innerHTML = 
                    '<p style="color: #ef4444; padding: 1rem;">Error al cargar Sistemas</p>';
            }
        }

        function renderSystemsTool() {
            const container = document.getElementById('systemsToolContent');
            const data = stage2SystemsData;
            
            const html = `
                <div style="padding: 0;">
                    <!-- Markets & Schedule -->
                    <div class="expandable-section" id="marketsSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('marketsSection')">
                            <div class="expandable-section-title">üìä Mercados y Horarios</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                ${(data.markets || []).map((item, index) => `
                                    <div class="subsection-item">
                                        <div class="subsection-item-header">
                                            <div class="subsection-item-label">Sesi√≥n ${index + 1}</div>
                                            <button onclick="removeSystemsItem('markets', ${index})">üóëÔ∏è Eliminar</button>
                                        </div>
                                        <textarea 
                                            class="form-textarea" 
                                            placeholder="Ej: Forex EUR/USD, Lunes a Viernes 9:00-17:00"
                                            onchange="updateSystemsItem('markets', ${index}, this.value)"
                                            style="min-height: 80px;"
                                        >${item}</textarea>
                                    </div>
                                `).join('')}
                                <button class="add-item-btn" onclick="addSystemsItem('markets')">
                                    ‚ûï A√±adir Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Parameters -->
                    <div class="expandable-section" id="riskSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('riskSection')">
                            <div class="expandable-section-title">‚ö†Ô∏è Par√°metros de Riesgo</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                ${(data.riskParams || []).map((item, index) => `
                                    <div class="subsection-item">
                                        <div class="subsection-item-header">
                                            <div class="subsection-item-label">Par√°metro ${index + 1}</div>
                                            <button onclick="removeSystemsItem('riskParams', ${index})">üóëÔ∏è Eliminar</button>
                                        </div>
                                        <textarea 
                                            class="form-textarea" 
                                            placeholder="Ej: Riesgo por posici√≥n: 1% del capital"
                                            onchange="updateSystemsItem('riskParams', ${index}, this.value)"
                                            style="min-height: 80px;"
                                        >${item}</textarea>
                                    </div>
                                `).join('')}
                                <button class="add-item-btn" onclick="addSystemsItem('riskParams')">
                                    ‚ûï A√±adir Par√°metro de Riesgo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Limits -->
                    <div class="expandable-section" id="limitsSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('limitsSection')">
                            <div class="expandable-section-title">üö¶ Limitaciones de Trading</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Max # trades por d√≠a</div>
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        placeholder="Ej: 3 trades m√°ximo"
                                        value="${data.tradingLimits?.maxTrades || ''}"
                                        onchange="updateSystemsObject('tradingLimits', 'maxTrades', this.value)"
                                    >
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Max # posiciones abiertas</div>
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        placeholder="Ej: 2 posiciones simult√°neas"
                                        value="${data.tradingLimits?.maxPositions || ''}"
                                        onchange="updateSystemsObject('tradingLimits', 'maxPositions', this.value)"
                                    >
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Max # p√©rdidas por d√≠a</div>
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        placeholder="Ej: Parar despu√©s de 2 p√©rdidas"
                                        value="${data.tradingLimits?.maxLosses || ''}"
                                        onchange="updateSystemsObject('tradingLimits', 'maxLosses', this.value)"
                                    >
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Max # ganancias por d√≠a</div>
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        placeholder="Ej: Parar despu√©s de alcanzar objetivo diario"
                                        value="${data.tradingLimits?.maxWins || ''}"
                                        onchange="updateSystemsObject('tradingLimits', 'maxWins', this.value)"
                                    >
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Riesgo total m√°ximo</div>
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        placeholder="Ej: 3% del capital total por d√≠a"
                                        value="${data.tradingLimits?.maxRisk || ''}"
                                        onchange="updateSystemsObject('tradingLimits', 'maxRisk', this.value)"
                                    >
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Management -->
                    <div class="expandable-section" id="positionSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('positionSection')">
                            <div class="expandable-section-title">üìà Gesti√≥n de Posiciones</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Ejecuci√≥n</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="Describe tu proceso de ejecuci√≥n de trades..."
                                        onchange="updateSystemsObject('positionManagement', 'execution', this.value)"
                                    >${data.positionManagement?.execution || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Stop Loss</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo defines y gestionas tus stop loss?"
                                        onchange="updateSystemsObject('positionManagement', 'stopLoss', this.value)"
                                    >${data.positionManagement?.stopLoss || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Break Even y Parciales</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øCu√°ndo y c√≥mo mueves a BE y tomas parciales?"
                                        onchange="updateSystemsObject('positionManagement', 'breakEven', this.value)"
                                    >${data.positionManagement?.breakEven || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Optimizaci√≥n TP y RRR</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo optimizas tus take profit y ratio riesgo/beneficio?"
                                        onchange="updateSystemsObject('positionManagement', 'takeProfit', this.value)"
                                    >${data.positionManagement?.takeProfit || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Otras Reglas</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="Otras reglas de gesti√≥n de posiciones..."
                                        onchange="updateSystemsObject('positionManagement', 'otherRules', this.value)"
                                    >${data.positionManagement?.otherRules || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pre-Market Preparation -->
                    <div class="expandable-section" id="prepSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('prepSection')">
                            <div class="expandable-section-title">‚òÄÔ∏è Preparaci√≥n Pre-Mercado</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                ${(data.preMarketPrep || []).map((item, index) => `
                                    <div class="subsection-item">
                                        <div class="subsection-item-header">
                                            <div class="subsection-item-label">Rutina ${index + 1}</div>
                                            <button onclick="removeSystemsItem('preMarketPrep', ${index})">üóëÔ∏è Eliminar</button>
                                        </div>
                                        <textarea 
                                            class="form-textarea" 
                                            placeholder="Ej: Revisar noticias econ√≥micas, an√°lisis t√©cnico, plan del d√≠a..."
                                            onchange="updateSystemsItem('preMarketPrep', ${index}, this.value)"
                                        >${item}</textarea>
                                    </div>
                                `).join('')}
                                <button class="add-item-btn" onclick="addSystemsItem('preMarketPrep')">
                                    ‚ûï A√±adir Rutina
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Prohibited Conditions -->
                    <div class="expandable-section" id="prohibitedSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('prohibitedSection')">
                            <div class="expandable-section-title">üö´ Conductas Prohibidas</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                ${(data.prohibitedConditions || []).map((item, index) => `
                                    <div class="subsection-item">
                                        <div class="subsection-item-header">
                                            <div class="subsection-item-label">Prohibici√≥n ${index + 1}</div>
                                            <button onclick="removeSystemsItem('prohibitedConditions', ${index})">üóëÔ∏è Eliminar</button>
                                        </div>
                                        <textarea 
                                            class="form-textarea" 
                                            placeholder="Ej: No operar si dorm√≠ menos de 6 horas, no operar despu√©s de 2 p√©rdidas..."
                                            onchange="updateSystemsItem('prohibitedConditions', ${index}, this.value)"
                                        >${item}</textarea>
                                    </div>
                                `).join('')}
                                <button class="add-item-btn" onclick="addSystemsItem('prohibitedConditions')">
                                    ‚ûï A√±adir Prohibici√≥n
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Success Behaviors -->
                    <div class="expandable-section" id="successSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('successSection')">
                            <div class="expandable-section-title">‚ú® Comportamiento para asegurar el √©xito</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Planes de responsabilidad</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo te mantienes responsable de tus reglas?"
                                        onchange="updateSystemsObject('successBehaviors', 'accountability', this.value)"
                                    >${data.successBehaviors?.accountability || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Proceso para corregir errores</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øQu√© haces cuando cometes un error?"
                                        onchange="updateSystemsObject('successBehaviors', 'errorCorrection', this.value)"
                                    >${data.successBehaviors?.errorCorrection || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Recompensa por seguir reglas</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo te recompensas por seguir tus reglas?"
                                        onchange="updateSystemsObject('successBehaviors', 'rewards', this.value)"
                                    >${data.successBehaviors?.rewards || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Estrategias para asegurar el m√°ximo rendimiento</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øQu√© estrategias usas para rendir al m√°ximo?"
                                        onchange="updateSystemsObject('successBehaviors', 'performance', this.value)"
                                    >${data.successBehaviors?.performance || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Guidelines -->
                    <div class="expandable-section" id="guidelinesSection">
                        <div class="expandable-section-header" onclick="toggleExpandableSection('guidelinesSection')">
                            <div class="expandable-section-title">üéì Directrices Generales para el comportamiento profesional</div>
                            <div class="expandable-section-icon">‚ñº</div>
                        </div>
                        <div class="expandable-section-body">
                            <div class="expandable-section-content">
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Responsabilidad financiera diaria</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo gestionas tu responsabilidad financiera?"
                                        onchange="updateSystemsObject('professionalGuidelines', 'financial', this.value)"
                                    >${data.professionalGuidelines?.financial || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Gesti√≥n del riesgo</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="Principios generales de gesti√≥n del riesgo..."
                                        onchange="updateSystemsObject('professionalGuidelines', 'riskManagement', this.value)"
                                    >${data.professionalGuidelines?.riskManagement || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Disciplina emocional</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo mantienes disciplina emocional?"
                                        onchange="updateSystemsObject('professionalGuidelines', 'emotional', this.value)"
                                    >${data.professionalGuidelines?.emotional || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Comunicaci√≥n, recolecci√≥n de datos y revisi√≥n del desempe√±o</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo documentas y revisas tu desempe√±o?"
                                        onchange="updateSystemsObject('professionalGuidelines', 'review', this.value)"
                                    >${data.professionalGuidelines?.review || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Conducta profesional y cumplimiento de reglas</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="Directrices sobre conducta profesional..."
                                        onchange="updateSystemsObject('professionalGuidelines', 'conduct', this.value)"
                                    >${data.professionalGuidelines?.conduct || ''}</textarea>
                                </div>
                                <div class="subsection-item">
                                    <div class="subsection-item-label">Equilibrio Vida-Trabajo</div>
                                    <textarea 
                                        class="form-textarea" 
                                        placeholder="¬øC√≥mo mantienes equilibrio entre trading y vida personal?"
                                        onchange="updateSystemsObject('professionalGuidelines', 'balance', this.value)"
                                    >${data.professionalGuidelines?.balance || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="save-indicator" id="systemsSaveIndicator" style="margin-top: 1rem;">
                        <span id="systemsSaveText">Sin cambios</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        window.toggleExpandableSection = function(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('expanded');
        }

        window.addSystemsItem = function(field) {
            if (!stage2SystemsData[field]) {
                stage2SystemsData[field] = [];
            }
            stage2SystemsData[field].push('');
            renderSystemsTool();
        }

        window.removeSystemsItem = function(field, index) {
            stage2SystemsData[field].splice(index, 1);
            renderSystemsTool();
            scheduleSystemsAutoSave();
        }

        window.updateSystemsItem = function(field, index, value) {
            if (!stage2SystemsData[field]) {
                stage2SystemsData[field] = [];
            }
            stage2SystemsData[field][index] = value;
            scheduleSystemsAutoSave();
        }

        window.updateSystemsObject = function(field, subfield, value) {
            if (!stage2SystemsData[field]) {
                stage2SystemsData[field] = {};
            }
            stage2SystemsData[field][subfield] = value;
            scheduleSystemsAutoSave();
        }

        function scheduleSystemsAutoSave() {
            const indicator = document.getElementById('systemsSaveIndicator');
            const text = document.getElementById('systemsSaveText');
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (systemsAutoSaveTimer) {
                clearTimeout(systemsAutoSaveTimer);
            }

            systemsAutoSaveTimer = setTimeout(async () => {
                await saveSystemsTool(true);
            }, 2000);
        }

        async function saveSystemsTool(isAutoSave = false) {
            if (!currentUser || !stage2SystemsData) return;

            try {
                const systemsData = {
                    userId: currentUser.uid,
                    ...stage2SystemsData,
                    updatedAt: Timestamp.now()
                };

                if (stage2SystemsData.id) {
                    await updateDoc(doc(db, 'stage2Systems', stage2SystemsData.id), systemsData);
                } else {
                    systemsData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stage2Systems'), systemsData);
                    stage2SystemsData.id = docRef.id;
                }

                const indicator = document.getElementById('systemsSaveIndicator');
                const text = document.getElementById('systemsSaveText');
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '‚úì Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('‚úÖ Sistemas guardados correctamente');
                }
            } catch (error) {
                console.error('Error saving Systems:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        // ========================================
        // HABITS TOOL (Same as before)
        // ========================================

        async function loadHabitsTool() {
            if (!currentUser) return;

            try {
                const habitsQuery = query(
                    collection(db, 'stage2Habits'),
                    where('userId', '==', currentUser.uid)
                );

                const snapshot = await getDocs(habitsQuery);
                
                if (!snapshot.empty) {
                    stage2HabitsData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                } else {
                    stage2HabitsData = {
                        userId: currentUser.uid,
                        reflection: '',
                        habits: []
                    };
                }

                renderHabitsTool();
            } catch (error) {
                console.error('Error loading Habits tool:', error);
                document.getElementById('habitsToolContent').innerHTML = 
                    '<p style="color: #ef4444; padding: 1rem;">Error al cargar H√°bitos</p>';
            }
        }

        function renderHabitsTool() {
            const container = document.getElementById('habitsToolContent');
            const data = stage2HabitsData;
            
            const html = `
                <div style="padding: 0;">
                    <div class="question-block">
                        <div class="question-number">Reflexi√≥n</div>
                        <div class="question-text">Reflexiona sobre tus Rutinas</div>
                        <div class="question-help">
                            ¬øQu√© te prepara bien para el d√≠a? ¬øQu√© es clave para rendir al m√°ximo? ¬øD√≥nde hay ineficiencias que roban tiempo?
                        </div>
                        <textarea 
                            id="habitsReflection" 
                            class="form-textarea" 
                            placeholder="Reflexiona sobre tus rutinas actuales..."
                            oninput="scheduleHabitsAutoSave()"
                            style="min-height: 150px;"
                        >${data.reflection || ''}</textarea>
                    </div>

                    <div class="question-block">
                        <div class="question-number">H√°bitos</div>
                        <div class="question-text">Mis H√°bitos Diarios</div>
                        <div class="question-help">
                            Lista h√°bitos espec√≠ficos y accionables que seguir√°s con constancia
                        </div>
                        <div id="habitsList" style="margin-top: 1rem;">
                            ${(data.habits || []).map((habit, index) => `
                                <div class="subsection-item">
                                    <div class="subsection-item-header">
                                        <span style="color: #4F46E5; font-weight: 600;">${index + 1}.</span>
                                        <button onclick="removeHabit(${index})">üóëÔ∏è Eliminar</button>
                                    </div>
                                    <input 
                                        type="text" 
                                        class="form-input"
                                        value="${habit}"
                                        onchange="updateHabit(${index}, this.value)"
                                        placeholder="Escribe un h√°bito..."
                                    />
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-item-btn" onclick="addHabit()">
                            ‚ûï A√±adir H√°bito
                        </button>
                    </div>

                    <div class="save-indicator" id="habitsSaveIndicator" style="margin-top: 1rem;">
                        <span id="habitsSaveText">Sin cambios</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        window.addHabit = function() {
            if (!stage2HabitsData.habits) {
                stage2HabitsData.habits = [];
            }
            stage2HabitsData.habits.push('');
            renderHabitsTool();
        }

        window.updateHabit = function(index, value) {
            if (!stage2HabitsData?.habits) return;
            stage2HabitsData.habits[index] = value;
            scheduleHabitsAutoSave();
        }

        window.removeHabit = function(index) {
            if (!stage2HabitsData?.habits) return;
            stage2HabitsData.habits.splice(index, 1);
            renderHabitsTool();
            scheduleHabitsAutoSave();
        }

        function scheduleHabitsAutoSave() {
            const indicator = document.getElementById('habitsSaveIndicator');
            const text = document.getElementById('habitsSaveText');
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (habitsAutoSaveTimer) {
                clearTimeout(habitsAutoSaveTimer);
            }

            habitsAutoSaveTimer = setTimeout(async () => {
                await saveHabitsTool(true);
            }, 2000);
        }

        async function saveHabitsTool(isAutoSave = false) {
            if (!currentUser || !stage2HabitsData) return;

            try {
                const reflection = document.getElementById('habitsReflection')?.value || stage2HabitsData.reflection;
                
                const habitsData = {
                    userId: currentUser.uid,
                    reflection: reflection,
                    habits: stage2HabitsData.habits || [],
                    updatedAt: Timestamp.now()
                };

                if (stage2HabitsData.id) {
                    await updateDoc(doc(db, 'stage2Habits', stage2HabitsData.id), habitsData);
                } else {
                    habitsData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stage2Habits'), habitsData);
                    stage2HabitsData.id = docRef.id;
                }

                const indicator = document.getElementById('habitsSaveIndicator');
                const text = document.getElementById('habitsSaveText');
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '‚úì Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('‚úÖ H√°bitos guardados correctamente');
                }
            } catch (error) {
                console.error('Error saving Habits:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        // ========================================
        // END OF STAGE 2 FUNCTIONS
        // ========================================

        // Stage submission and review
        window.submitStageForReview = async function() {
            const currentStepId = parseInt(document.getElementById('stepDetailTitle').textContent.match(/\d+/)[0]);
            
            if (currentStepId === 0) {
                showError('La auto-evaluaci√≥n no requiere revisi√≥n');
                return;
            }

            // Validation for Stage 1
            if (currentStepId === 1) {
                if (currentErrors.length === 0) {
                    showError('Debes identificar al menos un error antes de enviar la etapa');
                    return;
                }
                
                const hasCompleteError = currentErrors.some(error => error.completedQuestions === 7);
                if (!hasCompleteError) {
                    showError('Debes completar las 7 preguntas de al menos un error antes de enviar');
                    return;
                }
            }

            // Validation for Stage 2
            if (currentStepId === 2) {
                const hasREDItems = currentREDItems && currentREDItems.length > 0;
                const hasCompleteSystems = stage2SystemsData && stage2SystemsData.id;
                const hasHabits = stage2HabitsData && stage2HabitsData.habits && stage2HabitsData.habits.length >= 3;

                if (!hasREDItems || !hasCompleteSystems || !hasHabits) {
                    const missing = [];
                    if (!hasREDItems) missing.push('al menos una RED');
                    if (!hasCompleteSystems) missing.push('Sistemas y Procesos');
                    if (!hasHabits) missing.push('al menos 3 H√°bitos');
                    
                    showError(`Debes completar: ${missing.join(', ')}`);
                    return;
                }
            }

            try {
                const stageSubmission = {
                    userId: currentUser.uid,
                    stageId: currentStepId,
                    status: 'pending',
                    submittedAt: Timestamp.now(),
                    createdAt: Timestamp.now()
                };

                await addDoc(collection(db, 'stageSubmissions'), stageSubmission);
                
                showSuccess('¬°Etapa enviada para revisi√≥n!');
                updateStageSubmitStatus(currentStepId);
            } catch (error) {
                console.error('Error submitting stage:', error);
                showError('Error al enviar la etapa: ' + error.message);
            }
        }

        async function updateStageSubmitStatus(stageId) {
            try {
                const q = query(
                    collection(db, 'stageSubmissions'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', stageId)
                );
                
                const snapshot = await getDocs(q);
                const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                submissions.sort((a, b) => {
                    const aTime = a.submittedAt?.toMillis ? a.submittedAt.toMillis() : 0;
                    const bTime = b.submittedAt?.toMillis ? b.submittedAt.toMillis() : 0;
                    return bTime - aTime;
                });

                const latestSubmission = submissions[0];
                const statusDiv = document.getElementById('stageSubmitStatus');
                const submitBtn = document.getElementById('submitStageBtn');

                if (!latestSubmission) {
                    statusDiv.innerHTML = '';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì§ Enviar Etapa para Revisi√≥n';
                } else if (latestSubmission.status === 'pending') {
                    statusDiv.innerHTML = '<div class="success-message">‚è≥ Etapa enviada - Esperando revisi√≥n del mentor</div>';
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'En Revisi√≥n...';
                } else if (latestSubmission.status === 'approved') {
                    statusDiv.innerHTML = `<div class="success-message">‚úÖ Etapa Aprobada${latestSubmission.mentorFeedback ? '<br><strong>Feedback:</strong> ' + latestSubmission.mentorFeedback : ''}</div>`;
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚úì Aprobada';
                } else if (latestSubmission.status === 'rejected') {
                    statusDiv.innerHTML = `<div class="error-message">‚ùå Etapa Rechazada - Revisa el feedback<br><strong>Feedback:</strong> ${latestSubmission.mentorFeedback || 'Sin feedback'}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üîÑ Reenviar para Revisi√≥n';
                }
            } catch (error) {
                console.error('Error loading stage status:', error);
            }
        }

        // Admin functions
        async function loadAdminDashboard() {
            if (userData?.role !== 'admin') {
                navigateToPage('dashboard');
                return;
            }

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(u => u.role !== 'admin');

                const exercisesSnapshot = await getDocs(
                    query(collection(db, 'exercises'), where('status', '==', 'pending'))
                );
                const pendingExercises = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                document.getElementById('adminTotalStudents').textContent = users.length;
                document.getElementById('adminPendingReviews').textContent = pendingExercises.length;
                document.getElementById('adminActiveStudents').textContent = users.filter(u => u.currentStep > 1).length;

                renderAdminUsersList(users);
                renderAdminPendingExercises(pendingExercises, users);
                await loadPendingStages();
                await loadStagesContent();
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        function renderAdminUsersList(users) {
            const container = document.getElementById('adminUsersList');
            
            container.innerHTML = users.map(user => {
                const completedSteps = (user.unlockedSteps?.length || 1) - 2;
                
                return `
                    <div class="user-card">
                        <div class="user-header">
                            <div>
                                <div class="user-name">${user.name || user.email}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                        
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-value">${user.currentStep || 1}</div>
                                <div class="user-stat-label">Etapa Actual</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${completedSteps}</div>
                                <div class="user-stat-label">Completadas</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${user.completedExercises || 0}</div>
                                <div class="user-stat-label">Ejercicios</div>
                            </div>
                        </div>

                        <div class="step-unlock-controls">
                            <select class="form-select" id="stepSelect_${user.id}" style="flex: 1;">
                                ${steps.filter(s => s.id > 0).map(step => `
                                    <option value="${step.id}" ${user.currentStep === step.id ? 'selected' : ''}>
                                        Etapa ${step.id}: ${step.title}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="btn btn-small" onclick="unlockStepForUser('${user.id}')">
                                Desbloquear Etapa
                            </button>
                        </div>

                        <div class="user-actions">
                            <button class="btn btn-secondary btn-small" onclick="toggleCalendar('${user.id}', ${!user.calendarUnlocked})">
                                ${user.calendarUnlocked ? 'üîì Bloquear' : 'üîí Desbloquear'} Calendario
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.unlockStepForUser = async function(userId) {
            try {
                const selectedStep = parseInt(document.getElementById(`stepSelect_${userId}`).value);
                
                if (!selectedStep || isNaN(selectedStep)) {
                    showError('Selecciona una etapa v√°lida');
                    return;
                }
                
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (!userDoc.exists()) {
                    showError('Usuario no encontrado');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('Desbloqueando etapa', selectedStep, 'para usuario', userId);
                
                const unlockedSteps = userData.unlockedSteps || [0, 1];
                if (!unlockedSteps.includes(selectedStep)) {
                    unlockedSteps.push(selectedStep);
                    unlockedSteps.sort((a, b) => a - b);
                }
                
                // Also ensure Stage 0 is included
                if (!unlockedSteps.includes(0)) {
                    unlockedSteps.unshift(0);
                }

                await updateDoc(userRef, {
                    currentStep: selectedStep,
                    unlockedSteps: unlockedSteps
                });

                console.log('Etapa desbloqueada exitosamente');
                showSuccess(`‚úÖ Etapa ${selectedStep} desbloqueada para el alumno`);
                
                // Reload admin dashboard after a short delay
                setTimeout(() => {
                    loadAdminDashboard();
                }, 500);
            } catch (error) {
                console.error('Error unlocking step:', error);
                showError('Error al desbloquear la etapa: ' + error.message);
            }
        }

        window.toggleCalendar = async function(userId, unlock) {
            try {
                await updateDoc(doc(db, 'users', userId), {
                    calendarUnlocked: unlock
                });

                showSuccess(unlock ? 'Calendario desbloqueado' : 'Calendario bloqueado');
                loadAdminDashboard();
            } catch (error) {
                console.error('Error toggling calendar:', error);
                showError('Error al actualizar el calendario');
            }
        }

        function renderAdminPendingExercises(exercises, users) {
            const container = document.getElementById('adminPendingExercises');
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay ejercicios pendientes</p>';
                return;
            }

            container.innerHTML = exercises.map(exercise => {
                const user = users.find(u => u.id === exercise.userId);
                
                let typeClass, typeLabel;
                if (exercise.type === 'weekly') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Semanal';
                } else if (exercise.type === 'monthly') {
                    typeClass = 'type-monthly';
                    typeLabel = 'Mensual';
                } else if (exercise.type === 'quarterly') {
                    typeClass = 'type-quarterly';
                    typeLabel = 'Trimestral';
                } else if (exercise.type === 'pattern') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Diario de Patrones';
                }
                
                const date = exercise.submittedAt?.toDate ? exercise.submittedAt.toDate().toLocaleDateString('es-ES') : 'Sin fecha';

                return `
                    <div class="exercise-card" onclick="openReviewModal('${exercise.id}', '${user?.name || 'Alumno'}')">
                        <div class="exercise-info">
                            <h3>${user?.name || user?.email || 'Alumno'} - ${typeLabel}</h3>
                            <div class="exercise-meta">Enviado el ${date}</div>
                        </div>
                        <span class="exercise-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        window.openReviewModal = async function(exerciseId, userName) {
            try {
                const exerciseDoc = await getDoc(doc(db, 'exercises', exerciseId));
                if (!exerciseDoc.exists()) return;

                currentReviewExercise = { id: exerciseId, ...exerciseDoc.data() };
                
                const modal = document.getElementById('reviewModal');
                const content = document.getElementById('reviewModalContent');
                
                let typeLabel = '';
                if (currentReviewExercise.type === 'weekly') typeLabel = 'Semanal';
                else if (currentReviewExercise.type === 'monthly') typeLabel = 'Mensual';
                else if (currentReviewExercise.type === 'quarterly') typeLabel = 'Trimestral';
                else if (currentReviewExercise.type === 'pattern') typeLabel = 'Diario de Patrones';

                let contentHTML = `
                    <div class="review-exercise-header">
                        <div>
                            <h3>${userName}</h3>
                            <p style="color: #a1a1aa;">${typeLabel}</p>
                        </div>
                    </div>
                `;

                if (currentReviewExercise.type === 'pattern') {
                    contentHTML += `
                        <div class="review-field">
                            <div class="review-field-title">üìÖ Cu√°ndo ha pasado</div>
                            <div class="review-field-content">${currentReviewExercise.when || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">üí≠ C√≥mo me he sentido / Qu√© he pensado</div>
                            <div class="review-field-content">${currentReviewExercise.feeling || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">‚ö° Qu√© he hecho</div>
                            <div class="review-field-content">${currentReviewExercise.action || 'Sin respuesta'}</div>
                        </div>
                    `;
                } else {
                    const totalTrades = (currentReviewExercise.tradesWon || 0) + (currentReviewExercise.tradesLost || 0) + (currentReviewExercise.tradesBreakeven || 0);
                    const winRate = totalTrades > 0 ? Math.round((currentReviewExercise.tradesWon / totalTrades) * 100) : 0;
                    
                    contentHTML += `
                        <div class="review-field">
                            <div class="review-field-title">üìä M√©tricas</div>
                            <div class="review-field-content">
                                <strong>Ganadas:</strong> ${currentReviewExercise.tradesWon || 0}<br>
                                <strong>Perdidas:</strong> ${currentReviewExercise.tradesLost || 0}<br>
                                <strong>Breakeven:</strong> ${currentReviewExercise.tradesBreakeven || 0}<br>
                                <strong>Win Rate:</strong> ${winRate}%<br>
                                <strong>P&L:</strong> $${currentReviewExercise.pnl || 0}
                            </div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">‚úÖ Qu√© funcion√≥</div>
                            <div class="review-field-content">${currentReviewExercise.whatWorked || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">‚ùå Qu√© no funcion√≥</div>
                            <div class="review-field-content">${currentReviewExercise.whatDidntWork || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">üòì Algo que me cost√≥</div>
                            <div class="review-field-content">${currentReviewExercise.struggles || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">üèÜ Un win (logro)</div>
                            <div class="review-field-content">${currentReviewExercise.wins || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">üîÑ Qu√© cambiar√≠a esta semana para mejorar</div>
                            <div class="review-field-content">${currentReviewExercise.whatChange || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">üéØ KPIs de Proceso</div>
                            <div class="review-field-content">${currentReviewExercise.kpis || 'Sin respuesta'}</div>
                        </div>
                    `;
                }

                content.innerHTML = contentHTML;
                document.getElementById('reviewFeedback').value = '';
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error opening review modal:', error);
            }
        }

        window.closeReviewModal = function() {
            document.getElementById('reviewModal').classList.add('hidden');
            currentReviewExercise = null;
        }

        window.submitReview = async function() {
            if (!currentReviewExercise) return;

            const feedback = document.getElementById('reviewFeedback').value.trim();
            if (!feedback) {
                showError('Por favor, escribe un feedback');
                return;
            }

            try {
                await updateDoc(doc(db, 'exercises', currentReviewExercise.id), {
                    status: 'completed',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                const userRef = doc(db, 'users', currentReviewExercise.userId);
                const userDoc = await getDoc(userRef);
                const currentCount = userDoc.data().completedExercises || 0;
                await updateDoc(userRef, {
                    completedExercises: currentCount + 1
                });

                showSuccess('¬°Ejercicio revisado!');
                closeReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error submitting review:', error);
                showError('Error al enviar la revisi√≥n');
            }
        }

        async function loadPendingStages() {
            try {
                const q = query(
                    collection(db, 'stageSubmissions'),
                    where('status', '==', 'pending')
                );
                
                const snapshot = await getDocs(q);
                const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderPendingStages(submissions, users);
            } catch (error) {
                console.error('Error loading pending stages:', error);
            }
        }

        function renderPendingStages(submissions, users) {
            const container = document.getElementById('adminPendingStages');
            
            if (submissions.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay etapas pendientes</p>';
                return;
            }

            container.innerHTML = submissions.map(submission => {
                const user = users.find(u => u.id === submission.userId);
                const stage = steps.find(s => s.id === submission.stageId);
                const date = submission.submittedAt?.toDate ? submission.submittedAt.toDate().toLocaleDateString('es-ES') : 'Sin fecha';

                return `
                    <div class="exercise-card" onclick="openStageReviewModal('${submission.id}', '${user?.name || 'Alumno'}', ${submission.stageId})">
                        <div class="exercise-info">
                            <h3>${user?.name || user?.email || 'Alumno'} - Etapa ${submission.stageId}: ${stage?.title || ''}</h3>
                            <div class="exercise-meta">Enviado el ${date}</div>
                        </div>
                        <span class="exercise-type type-weekly">Etapa ${submission.stageId}</span>
                    </div>
                `;
            }).join('');
        }

        window.openStageReviewModal = async function(submissionId, userName, stageId) {
            try {
                const submissionDoc = await getDoc(doc(db, 'stageSubmissions', submissionId));
                if (!submissionDoc.exists()) return;

                currentStageSubmission = { id: submissionId, ...submissionDoc.data() };
                
                const stage = steps.find(s => s.id === stageId);
                const modal = document.getElementById('stageReviewModal');
                const content = document.getElementById('stageReviewModalContent');
                
                let stageContent = '<p style="color: #a1a1aa;">Revisi√≥n de etapa completada</p>';

                content.innerHTML = `
                    <div class="review-exercise-header">
                        <div>
                            <h3>${userName}</h3>
                            <p style="color: #a1a1aa;">Etapa ${stageId}: ${stage?.title || ''}</p>
                        </div>
                    </div>
                    ${stageContent}
                `;

                document.getElementById('stageFeedback').value = '';
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error opening stage review modal:', error);
            }
        }

        window.closeStageReviewModal = function() {
            document.getElementById('stageReviewModal').classList.add('hidden');
            currentStageSubmission = null;
        }

        window.approveStage = async function() {
            if (!currentStageSubmission) return;

            const feedback = document.getElementById('stageFeedback').value.trim();

            try {
                await updateDoc(doc(db, 'stageSubmissions', currentStageSubmission.id), {
                    status: 'approved',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                const nextStageId = currentStageSubmission.stageId + 1;
                if (nextStageId <= 5) {
                    const userRef = doc(db, 'users', currentStageSubmission.userId);
                    const userDoc = await getDoc(userRef);
                    const userData = userDoc.data();
                    
                    const unlockedSteps = userData.unlockedSteps || [0, 1];
                    if (!unlockedSteps.includes(nextStageId)) {
                        unlockedSteps.push(nextStageId);
                        unlockedSteps.sort((a, b) => a - b);
                    }

                    await updateDoc(userRef, {
                        currentStep: nextStageId,
                        unlockedSteps: unlockedSteps
                    });

                    if (currentStageSubmission.stageId === 4) {
                        await updateDoc(userRef, {
                            calendarUnlocked: true
                        });
                    }
                }

                showSuccess('‚úÖ Etapa aprobada!');
                closeStageReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error approving stage:', error);
                showError('Error al aprobar la etapa');
            }
        }

        window.rejectStage = async function() {
            if (!currentStageSubmission) return;

            const feedback = document.getElementById('stageFeedback').value.trim();
            if (!feedback) {
                showError('Por favor, escribe un feedback');
                return;
            }

            try {
                await updateDoc(doc(db, 'stageSubmissions', currentStageSubmission.id), {
                    status: 'rejected',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                showSuccess('Etapa rechazada');
                closeStageReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error rejecting stage:', error);
                showError('Error al rechazar la etapa');
            }
        }

        async function loadStagesContent() {
            const container = document.getElementById('stagesContentManagement');
            
            let stagesConfig = {};
            try {
                const configDoc = await getDoc(doc(db, 'config', 'stages'));
                if (configDoc.exists()) {
                    stagesConfig = configDoc.data();
                }
            } catch (error) {
                console.log('No config found');
            }

            container.innerHTML = steps.filter(s => s.id > 0).map(step => {
                const config = stagesConfig[`stage${step.id}`] || {};
                
                return `
                    <div class="content-management-card">
                        <div class="stage-card-header">
                            <div>
                                <span class="stage-number">Etapa ${step.id}</span>
                                <h3 style="margin-top: 0.5rem;">${step.title}</h3>
                            </div>
                        </div>

                        <form id="stageForm_${step.id}" onsubmit="saveStageContent(event, ${step.id})">
                            <div class="form-group">
                                <label class="form-label">Video URL</label>
                                <input 
                                    type="url" 
                                    class="form-input" 
                                    id="video_${step.id}"
                                    value="${config.video || ''}"
                                    placeholder="https://..."
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea 
                                    class="form-textarea" 
                                    id="description_${step.id}"
                                    placeholder="Descripci√≥n de la etapa..."
                                >${config.description || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Recursos Adicionales</label>
                                <textarea 
                                    class="form-textarea" 
                                    id="resources_${step.id}"
                                    placeholder="Links, documentos, material extra..."
                                >${config.resources || ''}</textarea>
                            </div>

                            <button type="submit" class="btn btn-small">
                                üíæ Guardar Cambios
                            </button>
                        </form>
                    </div>
                `;
            }).join('');
        }

        window.saveStageContent = async function(event, stageId) {
            event.preventDefault();
            
            const video = document.getElementById(`video_${stageId}`).value.trim();
            const description = document.getElementById(`description_${stageId}`).value.trim();
            const resources = document.getElementById(`resources_${stageId}`).value.trim();

            try {
                const configRef = doc(db, 'config', 'stages');
                const configDoc = await getDoc(configRef);
                
                let currentConfig = {};
                if (configDoc.exists()) {
                    currentConfig = configDoc.data();
                }

                currentConfig[`stage${stageId}`] = {
                    video,
                    description,
                    resources,
                    updatedAt: Timestamp.now()
                };

                await setDoc(configRef, currentConfig, { merge: true });
                
                const stepIndex = steps.findIndex(s => s.id === stageId);
                if (stepIndex !== -1) {
                    steps[stepIndex].video = video;
                }

                showSuccess(`‚úÖ Etapa ${stageId} actualizada`);
            } catch (error) {
                console.error('Error saving stage content:', error);
                showError('Error al guardar: ' + error.message);
            }
        }

        // Utility functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Email inv√°lido',
                'auth/user-disabled': 'Usuario deshabilitado',
                'auth/user-not-found': 'Usuario no encontrado',
                'auth/wrong-password': 'Contrase√±a incorrecta',
                'auth/invalid-credential': 'Credenciales inv√°lidas'
            };
            return messages[code] || 'Error al iniciar sesi√≥n';
        }

        // Make all functions global
        window.navigateToPage = navigateToPage;
        window.navigateToCurrentStep = navigateToCurrentStep;
        window.navigateToStep = navigateToStep;
        window.openExercise = openExercise;
        window.saveAsDraft = saveAsDraft;
        window.unlockStepForUser = unlockStepForUser;
        window.toggleCalendar = toggleCalendar;
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.submitReview = submitReview;
        window.saveStageContent = saveStageContent;
        window.createMyExercise = createMyExercise;
        window.submitStageForReview = submitStageForReview;
        window.openStageReviewModal = openStageReviewModal;
        window.closeStageReviewModal = closeStageReviewModal;
        window.approveStage = approveStage;
        window.rejectStage = rejectStage;
    </script>
</body>
</html>
