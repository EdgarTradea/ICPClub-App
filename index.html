 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICP Club - Plataforma</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: radial-gradient(ellipse at top, rgba(79, 70, 229, 0.1) 0%, transparent 50%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .logo {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-select {
            cursor: pointer;
        }

        .form-select option {
            background: #1a1a1a;
            color: #ffffff;
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
            width: auto;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .text-center {
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.03);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            padding: 0 1rem;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #a1a1aa;
        }

        .nav-item:hover:not(.locked) {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .nav-item.active {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .nav-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .logout-btn {
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #a1a1aa;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .progress-container {
            margin-top: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            transition: width 0.3s ease;
        }

        .steps-grid {
            display: grid;
            gap: 1.5rem;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-card:not(.locked):hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .step-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-info {
            flex: 1;
        }

        .step-number {
            color: #4F46E5;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-current {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .badge-locked {
            background: rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
        }

        .video-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-card {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .exercises-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            color: #a1a1aa;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #ffffff;
        }

        .tab.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
        }

        .exercises-list {
            display: grid;
            gap: 1rem;
        }

        .exercise-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .exercise-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .exercise-meta {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .exercise-type {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .type-weekly {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .type-monthly {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .type-quarterly {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        .locked-message {
            text-align: center;
            padding: 4rem 2rem;
        }

        .locked-message h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .locked-message p {
            color: #a1a1aa;
        }

        .exercise-form {
            max-width: 800px;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .form-section-desc {
            color: #a1a1aa;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .auto-save-indicator.saving {
            color: #3b82f6;
        }

        .auto-save-indicator.saved {
            color: #10b981;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .review-section {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-section h3 {
            margin-bottom: 1rem;
        }

        .review-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            color: #e5e7eb;
            line-height: 1.6;
        }

        /* Admin styles */
        .admin-section {
            margin-bottom: 2rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-email {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .user-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4F46E5;
        }

        .user-stat-label {
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .step-unlock-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
        }

        .review-exercise-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .review-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .review-field {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .review-field:last-child {
            border-bottom: none;
        }

        .review-field-title {
            font-weight: 600;
            color: #4F46E5;
            margin-bottom: 0.5rem;
        }

        .review-field-content {
            color: #e5e7eb;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .create-exercise-form {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row > * {
            flex: 1;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        /* Stage Tools Styles */
        .stage-tools-section {
            margin-top: 2rem;
        }

        .tools-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tools-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #a1a1aa;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tools-tab:hover {
            color: #ffffff;
        }

        .tools-tab.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
        }

        .error-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .error-item-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .error-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #4F46E5;
            background: rgba(79, 70, 229, 0.05);
        }

        .image-upload-area.dragging {
            border-color: #4F46E5;
            background: rgba(79, 70, 229, 0.1);
        }

        .image-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .content-management-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .stage-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stage-number {
            display: inline-block;
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Stage 1: Errors Management Styles */
        .errors-list-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .errors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .errors-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .errors-list {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .error-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .error-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(79, 70, 229, 0.3);
        }

        .error-item-info {
            flex: 1;
        }

        .error-item-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: #ffffff;
        }

        .error-item-status {
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .error-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border: none;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-icon.edit:hover {
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
        }

        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .error-editor {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .error-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .error-editor-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .error-question {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .error-question-number {
            display: inline-block;
            background: rgba(79, 70, 229, 0.2);
            color: #4F46E5;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .error-question-text {
            font-weight: 500;
            margin-bottom: 1rem;
            line-height: 1.5;
            color: #ffffff;
        }

        .error-question-help {
            font-size: 0.9rem;
            color: #a1a1aa;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #a1a1aa;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .empty-state-text {
            font-size: 0.95rem;
        }

        .save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #a1a1aa;
        }

        .save-indicator.saving {
            color: #3b82f6;
        }

        .save-indicator.saved {
            color: #10b981;
        }

        /* Stage 2: Tools Management Styles */
        .stage2-tools-container {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stage2-tool-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .stage2-tool-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(79, 70, 229, 0.3);
        }

        .stage2-tool-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stage2-tool-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stage2-tool-subtitle {
            color: #a1a1aa;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .stage2-tool-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .stage2-tool-status.complete {
            color: #10b981;
        }

        .stage2-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stage2-section-title {
            font-weight: 600;
            color: #4F46E5;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .stage2-section-desc {
            color: #a1a1aa;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .habits-list {
            display: grid;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .habit-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.02);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .habit-item input[type="text"] {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 0.95rem;
            padding: 0.25rem 0;
        }

        .habit-item input[type="text"]:focus {
            outline: none;
        }

        .habit-item button {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .habit-item button:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .add-habit-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(79, 70, 229, 0.1);
            border: 1px dashed rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            color: #4F46E5;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.75rem;
        }

        .add-habit-btn:hover {
            background: rgba(79, 70, 229, 0.15);
            border-style: solid;
        }

        .stage2-progress-indicator {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage2-progress-text {
            font-weight: 500;
        }

        .stage2-progress-bar-container {
            flex: 1;
            max-width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 1rem;
        }

        .stage2-progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .user-actions {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">ICP Club</div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="tu@email.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Contraseña</label>
                    <input type="password" id="password" class="form-input" placeholder="••••••••" required>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">Iniciar Sesión</button>
            </form>
            
            <p class="text-center" style="margin-top: 1rem; color: #a1a1aa; font-size: 0.9rem;">
                ¿Problemas para acceder? Contacta con tu mentor.
            </p>
        </div>
    </div>

    <div id="dashboardApp" class="app-container hidden">
        <div class="sidebar">
            <div class="sidebar-logo">ICP Club</div>
            
            <div class="nav-menu" id="navMenu">
                <!-- Navigation items will be loaded here -->
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
        </div>

        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">¡Bienvenido, <span id="userName">Trader</span>!</h1>
                    <p class="page-subtitle">Aquí tienes tu progreso y próximas tareas</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="currentStepStat">1</div>
                        <div class="stat-label">Paso Actual</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedExercisesCount">0</div>
                        <div class="stat-label">Ejercicios Completados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="progressPercentage">0%</div>
                        <div class="stat-label">Progreso Total</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Tu Progreso General</h2>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Programa de 5 etapas</span>
                            <span id="progressText">0/5 etapas</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Etapa Actual</h2>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Estás en la <strong style="color: #4F46E5;">Etapa <span id="currentStepText">1</span></strong></p>
                    <button class="btn" onclick="navigateToCurrentStep()" style="width: auto;">Ver Contenido de la Etapa →</button>
                </div>
            </div>

            <!-- Steps Page -->
            <div id="stepsPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Etapas del Programa</h1>
                    <p class="page-subtitle">5 etapas para dominar tu trading</p>
                </div>

                <div class="steps-grid" id="stepsGrid">
                    <!-- Steps will be loaded here -->
                </div>
            </div>

            <!-- Step Detail Page -->
            <div id="stepDetailPage" class="page-content hidden">
                <div class="page-header">
                    <button onclick="navigateToPage('steps')" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; margin-bottom: 1rem; font-size: 1rem;">← Volver a Etapas</button>
                    <h1 class="page-title" id="stepDetailTitle">Etapa</h1>
                    <p class="page-subtitle" id="stepDetailSubtitle"></p>
                </div>

                <div class="video-container" id="stepVideo">
                    <!-- Video will be loaded here -->
                </div>

                <div class="tool-card">
                    <h3>🛠️ Herramienta de esta Etapa</h3>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Accede a la herramienta específica para completar esta etapa</p>
                    <button class="btn" id="toolButton" style="width: auto;">Acceder a la Herramienta</button>
                </div>

                <!-- Stage Tools Section -->
                <div id="stageToolsSection" class="stage-tools-section hidden">
                    <!-- Tools will be loaded here dynamically -->
                </div>

                <!-- Submit Stage for Review -->
                <div class="card" id="submitStageCard">
                    <h2 class="card-title">✅ Completar Etapa</h2>
                    <p style="color: #a1a1aa; margin-bottom: 1rem;">Cuando hayas completado todo el contenido y la herramienta de esta etapa, envíala para revisión.</p>
                    <div id="stageSubmitStatus" style="margin-bottom: 1rem;"></div>
                    <button class="btn" id="submitStageBtn" onclick="submitStageForReview()">📤 Enviar Etapa para Revisión</button>
                </div>

                <div class="card" id="stepContent">
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <p style="color: #a1a1aa;">Contenido de la etapa...</p>
                </div>
            </div>

            <!-- Exercises Page -->
            <div id="exercisesPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Mis Ejercicios</h1>
                    <p class="page-subtitle">Revisiones semanales, mensuales y trimestrales</p>
                </div>

                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">➕ Crear Nuevo Ejercicio</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button class="btn btn-secondary" onclick="createMyExercise('weekly')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">📅</div>
                            <div style="font-weight: 600;">Revisión Semanal</div>
                        </button>
                        <button class="btn btn-secondary" onclick="createMyExercise('monthly')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">📆</div>
                            <div style="font-weight: 600;">Revisión Mensual</div>
                        </button>
                        <button class="btn btn-secondary" onclick="createMyExercise('quarterly')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
                            <div style="font-weight: 600;">Revisión Trimestral</div>
                        </button>
                        <button class="btn btn-secondary" onclick="createMyExercise('pattern')" style="padding: 1.5rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🧠</div>
                            <div style="font-weight: 600;">Diario de Patrones</div>
                        </button>
                    </div>
                </div>

                <div class="exercises-tabs">
                    <div class="tab active" data-tab="pending">Pendientes</div>
                    <div class="tab" data-tab="completed">Completados</div>
                </div>

                <div id="pendingExercises" class="exercises-list">
                    <!-- Pending exercises will be loaded here -->
                </div>

                <div id="completedExercisesList" class="exercises-list hidden">
                    <!-- Completed exercises will be loaded here -->
                </div>
            </div>

            <!-- Exercise Form Page -->
            <div id="exerciseFormPage" class="page-content hidden">
                <div class="page-header">
                    <button onclick="navigateToPage('exercises')" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; margin-bottom: 1rem; font-size: 1rem;">← Volver a Ejercicios</button>
                    <h1 class="page-title" id="exerciseFormTitle">Revisión</h1>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                        <p class="page-subtitle" id="exerciseFormSubtitle">Completa todos los campos</p>
                        <div class="auto-save-indicator" id="autoSaveIndicator">
                            <span id="autoSaveText">Sin cambios</span>
                        </div>
                    </div>
                </div>

                <form class="exercise-form" id="exerciseForm">
                    <div id="reviewFormContent">
                        <!-- Form content will be loaded dynamically based on exercise type -->
                    </div>

                    <div id="reviewSection" class="review-section hidden">
                        <h3>💬 Feedback del Mentor</h3>
                        <div class="review-content" id="reviewContent"></div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">Guardar Borrador</button>
                        <button type="submit" class="btn" id="submitExerciseBtn">Enviar para Revisión</button>
                    </div>
                </form>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminPage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Panel de Administración</h1>
                    <p class="page-subtitle">Gestiona alumnos, etapas y ejercicios</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="adminTotalStudents">0</div>
                        <div class="stat-label">Total Alumnos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminPendingReviews">0</div>
                        <div class="stat-label">Ejercicios Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminActiveStudents">0</div>
                        <div class="stat-label">Alumnos Activos</div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Gestión de Alumnos</h2>
                        <div class="user-list" id="adminUsersList">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Ejercicios Pendientes de Revisión</h2>
                        <div id="adminPendingExercises">
                            <!-- Pending exercises will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Etapas Pendientes de Revisión</h2>
                        <div id="adminPendingStages">
                            <!-- Pending stages will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="card">
                        <h2 class="card-title">Gestión de Contenido de Etapas</h2>
                        <p style="color: #a1a1aa; margin-bottom: 1.5rem;">Edita videos, herramientas y recursos de cada etapa</p>
                        <div id="stagesContentManagement">
                            <!-- Stages content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendarPage" class="page-content hidden">
                <div id="calendarLocked" class="locked-message">
                    <h3>🔒 Llamadas Bloqueadas</h3>
                    <p>Tu mentor desbloqueará esta sección cuando sea el momento de agendar tu llamada 1:1</p>
                </div>

                <div id="calendarUnlocked" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Agendar Llamada</h1>
                        <p class="page-subtitle">Reserva tu sesión 1:1 con tu mentor</p>
                    </div>
                    <div class="card">
                        <div style="min-height: 600px;">
                            <iframe src="https://calendly.com/edgartradea/30min" width="100%" height="600" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page-content hidden">
                <div class="page-header">
                    <h1 class="page-title">Mi Perfil</h1>
                    <p class="page-subtitle">Información de tu cuenta</p>
                </div>
                <div class="card">
                    <p style="color: #a1a1aa;">Esta sección se está construyendo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Revisar Ejercicio</h2>
                <button class="modal-close" onclick="closeReviewModal()">×</button>
            </div>
            
            <div id="reviewModalContent">
                <!-- Exercise content will be loaded here -->
            </div>

            <div class="form-group" style="margin-top: 2rem;">
                <label class="form-label" for="reviewFeedback">Feedback para el alumno</label>
                <textarea id="reviewFeedback" class="form-textarea" placeholder="Escribe aquí tu feedback..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeReviewModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitReview()">Aprobar y Enviar Feedback</button>
            </div>
        </div>
    </div>

    <!-- Stage Review Modal -->
    <div id="stageReviewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Revisar Etapa</h2>
                <button class="modal-close" onclick="closeStageReviewModal()">×</button>
            </div>
            
            <div id="stageReviewModalContent">
                <!-- Stage content will be loaded here -->
            </div>

            <div class="form-group" style="margin-top: 2rem;">
                <label class="form-label" for="stageFeedback">Feedback para el alumno</label>
                <textarea id="stageFeedback" class="form-textarea" placeholder="Escribe aquí tu feedback..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeStageReviewModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="rejectStage()">Rechazar</button>
                <button class="btn btn-success" onclick="approveStage()">Aprobar Etapa</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, addDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1U_K-9vkGGnKcbAALA-pSRMTv8f0B_M4",
            authDomain: "icp-club-app.firebaseapp.com",
            projectId: "icp-club-app",
            storageBucket: "icp-club-app.firebasestorage.app",
            messagingSenderId: "684016793931",
            appId: "1:684016793931:web:4a4870a86beb01ee5290ce",
            measurementId: "G-DDPRR5NY4L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let currentExercise = null;
        let currentReviewExercise = null;
        let currentStageWork = null;
        let currentReviewStage = null;
        let autoSaveTimer = null;
        let currentStageId = null;
        let currentErrorId = null;
        let currentErrors = [];
        let errorAutoSaveTimer = null;
        // Stage 2 variables
        let stage2ToolsData = {
            red: null,
            systems: null,
            habits: null
        };
        let stage2AutoSaveTimer = null;

        const steps = [
            { id: 1, title: "Identificar errores", video: "", tool: "" },
            { id: 2, title: "Sistemas y procesos", video: "", tool: "" },
            { id: 3, title: "Hábitos", video: "", tool: "" },
            { id: 4, title: "Integración al trading", video: "", tool: "" },
            { id: 5, title: "Trading", video: "", tool: "" }
        ];

        const loginPage = document.getElementById('loginPage');
        const dashboardApp = document.getElementById('dashboardApp');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user);
                showDashboard();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            hideMessages();
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showSuccess('Login exitoso!');
            } catch (error) {
                showError(getErrorMessage(error.code));
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
            }
        });

        // Navigation
        function showLogin() {
            loginPage.classList.remove('hidden');
            dashboardApp.classList.add('hidden');
        }

        function showDashboard() {
            loginPage.classList.add('hidden');
            dashboardApp.classList.remove('hidden');
            loadNavigation();
            navigateToPage('dashboard');
        }

        function loadNavigation() {
            const navMenu = document.getElementById('navMenu');
            const isAdmin = userData?.role === 'admin';
            
            const navItems = [
                { id: 'dashboard', icon: '📊', label: 'Dashboard', locked: false },
                { id: 'steps', icon: '📚', label: 'Etapas', locked: false },
                { id: 'exercises', icon: '✍️', label: 'Mis Ejercicios', locked: false },
                { id: 'calendar', icon: '📅', label: 'Agendar Llamada', locked: !userData?.calendarUnlocked && !isAdmin },
                { id: 'profile', icon: '👤', label: 'Perfil', locked: false }
            ];

            if (isAdmin) {
                navItems.splice(4, 0, { id: 'admin', icon: '⚙️', label: 'Admin', locked: false });
            }

            navMenu.innerHTML = navItems.map(item => `
                <div class="nav-item ${item.locked ? 'locked' : ''}" data-page="${item.id}">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                    ${item.locked ? '<span>🔒</span>' : ''}
                </div>
            `).join('');

            document.querySelectorAll('.nav-item:not(.locked)').forEach(item => {
                item.addEventListener('click', () => {
                    navigateToPage(item.dataset.page);
                });
            });
        }

        window.navigateToPage = function(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
            
            const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            if (page === 'dashboard') loadDashboard();
            else if (page === 'steps') loadSteps();
            else if (page === 'exercises') loadExercises();
            else if (page === 'calendar') loadCalendar();
            else if (page === 'admin') loadAdminDashboard();
        }

        window.navigateToCurrentStep = function() {
            const currentStep = userData?.currentStep || 1;
            navigateToStep(currentStep);
        }

        window.navigateToStep = async function(stepId) {
            const step = steps.find(s => s.id === stepId);
            if (!step) return;

            const isUnlocked = userData?.unlockedSteps?.includes(stepId);
            if (!isUnlocked && userData?.role !== 'admin') return;

            // Load stage configuration from Firestore
            let stageConfig = {};
            try {
                const configDoc = await getDoc(doc(db, 'config', 'stages'));
                if (configDoc.exists()) {
                    const allConfig = configDoc.data();
                    stageConfig = allConfig[`stage${stepId}`] || {};
                }
            } catch (error) {
                console.log('No config found for stage');
            }

            document.getElementById('stepDetailTitle').textContent = `Etapa ${stepId}: ${step.title}`;
            document.getElementById('stepDetailSubtitle').textContent = stageConfig.description || '';

            const videoContainer = document.getElementById('stepVideo');
            const videoUrl = stageConfig.video || step.video;
            
            if (videoUrl) {
                let embedUrl = videoUrl;
                
                // Convert YouTube URL to embed
                if (videoUrl.includes('youtube.com/watch')) {
                    const videoId = new URL(videoUrl).searchParams.get('v');
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (videoUrl.includes('youtu.be/')) {
                    const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (videoUrl.includes('loom.com/share/')) {
                    const videoId = videoUrl.split('loom.com/share/')[1].split('?')[0];
                    embedUrl = `https://www.loom.com/embed/${videoId}`;
                } else if (videoUrl.includes('vimeo.com/')) {
                    const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
                    embedUrl = `https://player.vimeo.com/video/${videoId}`;
                }
                
                videoContainer.innerHTML = `<iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                videoContainer.innerHTML = '<p style="color: #a1a1aa;">Video próximamente...</p>';
            }

            const toolButton = document.getElementById('toolButton');
            const toolUrl = stageConfig.tool || step.tool;
            
            if (toolUrl) {
                toolButton.onclick = () => window.open(toolUrl, '_blank');
                toolButton.style.display = 'block';
            } else {
                toolButton.style.display = 'none';
            }

            // Update resources section
            const stepContent = document.getElementById('stepContent');
            if (stageConfig.resources) {
                stepContent.innerHTML = `
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <div style="color: #e5e7eb; line-height: 1.8; white-space: pre-wrap;">${stageConfig.resources}</div>
                `;
            } else {
                stepContent.innerHTML = `
                    <h2 class="card-title">Recursos Adicionales</h2>
                    <p style="color: #a1a1aa;">Próximamente tu mentor añadirá recursos aquí...</p>
                `;
            }

            navigateToPage('stepDetail');
            
            // Load stage-specific tools
            currentStageId = stepId;
            const toolsSection = document.getElementById('stageToolsSection');
            
            if (stepId === 1 && userData?.role !== 'admin') {
                // Stage 1: Load errors management system
                toolsSection.classList.remove('hidden');
                await loadStage1Errors();
            } else if (stepId === 2 && userData?.role !== 'admin') {
                // Stage 2: Load 3 tools (RED, Systems, Habits)
                toolsSection.classList.remove('hidden');
                await loadStage2Tools();
            } else {
                // Other stages: hide tools section for now
                toolsSection.classList.add('hidden');
            }
            
            // Load stage submission status (only for students)
            if (userData?.role !== 'admin') {
                await updateStageSubmitStatus(stepId);
            } else {
                document.getElementById('submitStageCard').style.display = 'none';
            }
        }

        // Load functions
        async function loadUserData(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                } else {
                    userData = {
                        email: user.email,
                        name: user.email.split('@')[0],
                        currentStep: 1,
                        unlockedSteps: [1],
                        calendarUnlocked: false,
                        completedExercises: 0,
                        role: 'student'
                    };
                    await setDoc(doc(db, 'users', user.uid), userData);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadDashboard() {
            document.getElementById('userName').textContent = userData?.name || 'Trader';
            document.getElementById('currentStepStat').textContent = userData?.currentStep || 1;
            document.getElementById('currentStepText').textContent = userData?.currentStep || 1;
            document.getElementById('completedExercisesCount').textContent = userData?.completedExercises || 0;

            const completedSteps = (userData?.unlockedSteps?.length || 1) - 1;
            const progressPercent = Math.round((completedSteps / 5) * 100);
            document.getElementById('progressPercentage').textContent = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${completedSteps}/5 etapas`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
        }

        async function loadSteps() {
            const stepsGrid = document.getElementById('stepsGrid');
            const unlockedSteps = userData?.unlockedSteps || [1];
            const currentStep = userData?.currentStep || 1;

            stepsGrid.innerHTML = steps.map(step => {
                const isUnlocked = unlockedSteps.includes(step.id);
                const isCurrent = step.id === currentStep;
                const isCompleted = step.id < currentStep;
                
                let badge = '';
                if (isCompleted) badge = '<span class="step-badge badge-completed">✓ Completado</span>';
                else if (isCurrent) badge = '<span class="step-badge badge-current">Actual</span>';
                else badge = '<span class="step-badge badge-locked">🔒 Bloqueado</span>';

                return `
                    <div class="step-card ${!isUnlocked ? 'locked' : ''}" onclick="${isUnlocked ? `navigateToStep(${step.id})` : ''}">
                        <div class="step-info">
                            <div class="step-number">Etapa ${step.id}</div>
                            <div class="step-title">${step.title}</div>
                        </div>
                        ${badge}
                    </div>
                `;
            }).join('');
        }

        async function loadExercises() {
            // Setup tabs first (remove old listeners)
            const tabs = document.querySelectorAll('.exercises-tabs .tab');
            tabs.forEach(tab => {
                // Remove old listeners by cloning
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
            });

            // Add new listeners
            document.querySelectorAll('.exercises-tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.exercises-tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.tab === 'pending') {
                        document.getElementById('pendingExercises').classList.remove('hidden');
                        document.getElementById('completedExercisesList').classList.add('hidden');
                    } else {
                        document.getElementById('pendingExercises').classList.add('hidden');
                        document.getElementById('completedExercisesList').classList.remove('hidden');
                    }
                });
            });

            try {
                const exercisesRef = collection(db, 'exercises');
                const q = query(
                    exercisesRef,
                    where('userId', '==', currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                const exercises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort by createdAt manually
                exercises.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                console.log('Ejercicios cargados:', exercises); // Debug

                const pending = exercises.filter(e => e.status === 'draft' || e.status === 'pending');
                const completed = exercises.filter(e => e.status === 'completed');

                renderExercisesList('pendingExercises', pending);
                renderExercisesList('completedExercisesList', completed);
            } catch (error) {
                console.error('Error loading exercises:', error);
                document.getElementById('pendingExercises').innerHTML = 
                    `<p style="color: #ef4444; text-align: center; padding: 2rem;">Error al cargar ejercicios: ${error.message}</p>`;
            }
        }

        function renderExercisesList(containerId, exercises) {
            const container = document.getElementById(containerId);
            
            console.log(`Renderizando ${exercises.length} ejercicios en ${containerId}`); // Debug
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay ejercicios aquí</p>';
                return;
            }

            container.innerHTML = exercises.map(exercise => {
                let typeClass, typeLabel;
                
                if (exercise.type === 'weekly') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Semanal';
                } else if (exercise.type === 'monthly') {
                    typeClass = 'type-monthly';
                    typeLabel = 'Mensual';
                } else if (exercise.type === 'quarterly') {
                    typeClass = 'type-quarterly';
                    typeLabel = 'Trimestral';
                } else if (exercise.type === 'pattern') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Diario de Patrones';
                }
                
                let date = 'Sin fecha';
                if (exercise.createdAt) {
                    try {
                        if (exercise.createdAt.toDate) {
                            date = exercise.createdAt.toDate().toLocaleDateString('es-ES');
                        } else if (exercise.createdAt.seconds) {
                            date = new Date(exercise.createdAt.seconds * 1000).toLocaleDateString('es-ES');
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e);
                    }
                }
                
                const statusLabel = exercise.status === 'draft' ? '📝 Borrador' : 
                                    exercise.status === 'pending' ? '⏳ En revisión' : '✅ Completado';

                return `
                    <div class="exercise-card" onclick="openExercise('${exercise.id}')">
                        <div class="exercise-info">
                            <h3>${typeLabel}</h3>
                            <div class="exercise-meta">${date} · ${statusLabel}</div>
                        </div>
                        <span class="exercise-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        window.createMyExercise = async function(type) {
            if (!currentUser) return;

            try {
                const exerciseData = {
                    userId: currentUser.uid,
                    type: type,
                    status: 'draft',
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                };

                // Add empty fields based on type
                if (type === 'pattern') {
                    exerciseData.when = '';
                    exerciseData.feeling = '';
                    exerciseData.action = '';
                } else {
                    exerciseData.tradesWon = 0;
                    exerciseData.tradesLost = 0;
                    exerciseData.tradesBreakeven = 0;
                    exerciseData.pnl = 0;
                    exerciseData.whatWorked = '';
                    exerciseData.whatDidntWork = '';
                    exerciseData.struggles = '';
                    exerciseData.wins = '';
                    exerciseData.whatChange = '';
                    exerciseData.kpis = '';
                }

                const docRef = await addDoc(collection(db, 'exercises'), exerciseData);
                
                showSuccess('✅ Ejercicio creado! Ahora puedes completarlo');
                
                // Open the newly created exercise
                await openExercise(docRef.id);
            } catch (error) {
                console.error('Error creating exercise:', error);
                showError('Error al crear el ejercicio: ' + error.message);
            }
        }

        window.openExercise = async function(exerciseId) {
            try {
                const exerciseDoc = await getDoc(doc(db, 'exercises', exerciseId));
                if (!exerciseDoc.exists()) {
                    showError('Ejercicio no encontrado');
                    return;
                }

                currentExercise = { id: exerciseId, ...exerciseDoc.data() };
                console.log('Ejercicio cargado:', currentExercise);
                
                // Set title based on type
                let titleText = '';
                if (currentExercise.type === 'weekly') titleText = 'Revisión Semanal';
                else if (currentExercise.type === 'monthly') titleText = 'Revisión Mensual';
                else if (currentExercise.type === 'quarterly') titleText = 'Revisión Trimestral';
                else if (currentExercise.type === 'pattern') titleText = 'Diario de Patrones';
                
                document.getElementById('exerciseFormTitle').textContent = titleText;
                
                // Load appropriate form based on type
                const formContent = document.getElementById('reviewFormContent');
                if (currentExercise.type === 'pattern') {
                    formContent.innerHTML = getPatternFormHTML();
                } else {
                    formContent.innerHTML = getReviewFormHTML();
                }
                
                // Fill form with existing data
                fillExerciseForm(currentExercise);

                // Show review if completed
                const reviewSection = document.getElementById('reviewSection');
                if (currentExercise.status === 'completed' && currentExercise.mentorFeedback) {
                    reviewSection.classList.remove('hidden');
                    document.getElementById('reviewContent').textContent = currentExercise.mentorFeedback;
                } else {
                    reviewSection.classList.add('hidden');
                }

                // Disable form if completed
                const isCompleted = currentExercise.status === 'completed';
                document.querySelectorAll('#exerciseForm input, #exerciseForm textarea').forEach(field => {
                    field.disabled = isCompleted;
                });
                document.getElementById('submitExerciseBtn').disabled = isCompleted;

                navigateToPage('exerciseForm');
                
                // Setup form after navigating
                setTimeout(() => {
                    setupExerciseFormHandlers();
                }, 100);
            } catch (error) {
                console.error('Error opening exercise:', error);
                showError('Error al abrir el ejercicio: ' + error.message);
            }
        }

        function setupExerciseFormHandlers() {
            console.log('Setting up form handlers...');
            
            // Remove old submit listener
            const form = document.getElementById('exerciseForm');
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Add new submit listener
            document.getElementById('exerciseForm').addEventListener('submit', handleExerciseSubmit);
            
            // Setup auto-save
            setupAutoSave();
            
            console.log('Form handlers ready');
        }

        async function handleExerciseSubmit(e) {
            e.preventDefault();
            console.log('Form submitted!');
            
            if (!currentExercise) {
                console.error('No current exercise');
                return;
            }

            const submitBtn = document.getElementById('submitExerciseBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            let exerciseData = {
                status: 'pending',
                submittedAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            };

            try {
                if (currentExercise.type === 'pattern') {
                    exerciseData.when = document.getElementById('when').value;
                    exerciseData.feeling = document.getElementById('feeling').value;
                    exerciseData.action = document.getElementById('action').value;
                    
                    console.log('Pattern data:', exerciseData);
                } else {
                    exerciseData.tradesWon = parseInt(document.getElementById('tradesWon').value) || 0;
                    exerciseData.tradesLost = parseInt(document.getElementById('tradesLost').value) || 0;
                    exerciseData.tradesBreakeven = parseInt(document.getElementById('tradesBreakeven').value) || 0;
                    exerciseData.pnl = parseFloat(document.getElementById('pnl').value) || 0;
                    exerciseData.whatWorked = document.getElementById('whatWorked').value;
                    exerciseData.whatDidntWork = document.getElementById('whatDidntWork').value;
                    exerciseData.struggles = document.getElementById('struggles').value;
                    exerciseData.wins = document.getElementById('wins').value;
                    exerciseData.whatChange = document.getElementById('whatChange').value;
                    exerciseData.kpis = document.getElementById('kpis').value;
                    
                    console.log('Review data:', exerciseData);
                }

                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
                console.log('Exercise submitted successfully');
                
                showSuccess('¡Ejercicio enviado para revisión!');
                setTimeout(() => {
                    navigateToPage('exercises');
                    loadExercises();
                }, 1500);
            } catch (error) {
                console.error('Error submitting exercise:', error);
                showError('Error al enviar el ejercicio: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar para Revisión';
            }
        }

        function getReviewFormHTML() {
            return `
                <div class="form-section">
                    <div class="form-section-title">📊 Métricas</div>
                    <div class="form-section-desc">Resultados numéricos de tu trading</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ganadas</label>
                            <input type="number" id="tradesWon" class="form-input" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Perdidas</label>
                            <input type="number" id="tradesLost" class="form-input" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Breakeven</label>
                            <input type="number" id="tradesBreakeven" class="form-input" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">P&L ($)</label>
                            <input type="number" id="pnl" class="form-input" step="0.01" value="0" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">✅ Qué funcionó</div>
                    <div class="form-section-desc">Describe qué estrategias, comportamientos o decisiones dieron resultado</div>
                    <div class="form-group">
                        <textarea id="whatWorked" class="form-textarea" placeholder="Ej: Respeté mi plan de trading, esperé setups claros, mantuve mi risk management..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">❌ Qué no funcionó</div>
                    <div class="form-section-desc">Identifica errores, patrones negativos o decisiones que no dieron resultado</div>
                    <div class="form-group">
                        <textarea id="whatDidntWork" class="form-textarea" placeholder="Ej: Forcé trades sin setup, salí antes de tiempo por miedo..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">😓 Algo que me costó</div>
                    <div class="form-section-desc">¿Qué te resultó difícil o desafiante en este período?</div>
                    <div class="form-group">
                        <textarea id="struggles" class="form-textarea" placeholder="Ej: Me costó mantener la disciplina después de una pérdida, controlar la ansiedad..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">🏆 Un win (logro)</div>
                    <div class="form-section-desc">Celebra un logro, por pequeño que sea</div>
                    <div class="form-group">
                        <textarea id="wins" class="form-textarea" placeholder="Ej: Logré seguir mi checklist todos los días, tuve mi mejor semana en ganancias..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">🔄 Qué cambiaría esta semana para mejorar</div>
                    <div class="form-section-desc">Acciones específicas que tomarás para mejorar</div>
                    <div class="form-group">
                        <textarea id="whatChange" class="form-textarea" placeholder="Ej: Voy a reducir el tamaño de posición en días volátiles, haré más breaks..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">🎯 KPIs de Proceso</div>
                    <div class="form-section-desc">Define objetivos de proceso (comportamientos) para el siguiente período</div>
                    <div class="form-group">
                        <textarea id="kpis" class="form-textarea" placeholder="Ej: Seguir mi checklist 100% de los días, hacer journaling post-trade, respetar mis horarios de trading, tomar 1 break cada 2 horas..." required></textarea>
                    </div>
                </div>
            `;
        }

        function getPatternFormHTML() {
            return `
                <div class="form-section">
                    <div class="form-section-title">🧠 Diario de Patrones de Ejecución</div>
                    <div class="form-section-desc">Identifica patrones en tu comportamiento. Límite: 100 palabras por campo</div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">📅 Cuándo ha pasado</div>
                    <div class="form-section-desc">Describe el contexto y momento (máx 100 palabras)</div>
                    <div class="form-group">
                        <textarea id="when" class="form-textarea" maxlength="600" placeholder="Ej: Después de 2 pérdidas seguidas, cuando el mercado estaba muy volátil..." required></textarea>
                        <div style="text-align: right; color: #a1a1aa; font-size: 0.85rem; margin-top: 0.25rem;">
                            <span id="whenCount">0</span>/600 caracteres (~100 palabras)
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">💭 Cómo me he sentido / Qué he pensado</div>
                    <div class="form-section-desc">Tus emociones y pensamientos en ese momento (máx 100 palabras)</div>
                    <div class="form-group">
                        <textarea id="feeling" class="form-textarea" maxlength="600" placeholder="Ej: Me sentí frustrado y ansioso. Pensé que tenía que recuperar lo perdido rápido..." required></textarea>
                        <div style="text-align: right; color: #a1a1aa; font-size: 0.85rem; margin-top: 0.25rem;">
                            <span id="feelingCount">0</span>/600 caracteres (~100 palabras)
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">⚡ Qué he hecho</div>
                    <div class="form-section-desc">Tu acción y comportamiento (máx 100 palabras)</div>
                    <div class="form-group">
                        <textarea id="action" class="form-textarea" maxlength="600" placeholder="Ej: Entré en un trade sin setup claro, aumenté el tamaño de posición para recuperar..." required></textarea>
                        <div style="text-align: right; color: #a1a1aa; font-size: 0.85rem; margin-top: 0.25rem;">
                            <span id="actionCount">0</span>/600 caracteres (~100 palabras)
                        </div>
                    </div>
                </div>
            `;
        }

        function fillExerciseForm(exercise) {
            if (exercise.type === 'pattern') {
                document.getElementById('when').value = exercise.when || '';
                document.getElementById('feeling').value = exercise.feeling || '';
                document.getElementById('action').value = exercise.action || '';
                
                // Setup character counters
                ['when', 'feeling', 'action'].forEach(field => {
                    const textarea = document.getElementById(field);
                    const counter = document.getElementById(`${field}Count`);
                    counter.textContent = textarea.value.length;
                    
                    textarea.addEventListener('input', function() {
                        counter.textContent = this.value.length;
                    });
                });
            } else {
                document.getElementById('tradesWon').value = exercise.tradesWon || 0;
                document.getElementById('tradesLost').value = exercise.tradesLost || 0;
                document.getElementById('tradesBreakeven').value = exercise.tradesBreakeven || 0;
                document.getElementById('pnl').value = exercise.pnl || 0;
                document.getElementById('whatWorked').value = exercise.whatWorked || '';
                document.getElementById('whatDidntWork').value = exercise.whatDidntWork || '';
                document.getElementById('struggles').value = exercise.struggles || '';
                document.getElementById('wins').value = exercise.wins || '';
                document.getElementById('whatChange').value = exercise.whatChange || '';
                document.getElementById('kpis').value = exercise.kpis || '';
            }
        }

        function setupAutoSave() {
            let fields = [];
            
            if (currentExercise.type === 'pattern') {
                fields = ['when', 'feeling', 'action'];
            } else {
                fields = ['tradesWon', 'tradesLost', 'tradesBreakeven', 'pnl', 'whatWorked', 'whatDidntWork', 'struggles', 'wins', 'whatChange', 'kpis'];
            }
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', () => {
                        clearTimeout(autoSaveTimer);
                        updateAutoSaveIndicator('saving');
                        
                        autoSaveTimer = setTimeout(async () => {
                            await saveAsDraft();
                            updateAutoSaveIndicator('saved');
                        }, 2000);
                    });
                }
            });
        }

        function updateAutoSaveIndicator(state) {
            const indicator = document.getElementById('autoSaveIndicator');
            const text = document.getElementById('autoSaveText');
            
            indicator.className = 'auto-save-indicator';
            
            if (state === 'saving') {
                indicator.classList.add('saving');
                text.textContent = '💾 Guardando...';
            } else if (state === 'saved') {
                indicator.classList.add('saved');
                text.textContent = '✓ Guardado';
                setTimeout(() => {
                    indicator.className = 'auto-save-indicator';
                    text.textContent = 'Sin cambios';
                }, 2000);
            }
        }

        window.saveAsDraft = async function() {
            if (!currentExercise) {
                console.error('No current exercise to save');
                return;
            }

            console.log('Saving draft...');

            let exerciseData = {
                status: 'draft',
                updatedAt: Timestamp.now()
            };

            try {
                if (currentExercise.type === 'pattern') {
                    const whenField = document.getElementById('when');
                    const feelingField = document.getElementById('feeling');
                    const actionField = document.getElementById('action');
                    
                    if (whenField) exerciseData.when = whenField.value;
                    if (feelingField) exerciseData.feeling = feelingField.value;
                    if (actionField) exerciseData.action = actionField.value;
                } else {
                    const tradesWonField = document.getElementById('tradesWon');
                    const tradesLostField = document.getElementById('tradesLost');
                    const tradesBreakevenField = document.getElementById('tradesBreakeven');
                    const pnlField = document.getElementById('pnl');
                    const whatWorkedField = document.getElementById('whatWorked');
                    const whatDidntWorkField = document.getElementById('whatDidntWork');
                    const strugglesField = document.getElementById('struggles');
                    const winsField = document.getElementById('wins');
                    const whatChangeField = document.getElementById('whatChange');
                    const kpisField = document.getElementById('kpis');
                    
                    if (tradesWonField) exerciseData.tradesWon = parseInt(tradesWonField.value) || 0;
                    if (tradesLostField) exerciseData.tradesLost = parseInt(tradesLostField.value) || 0;
                    if (tradesBreakevenField) exerciseData.tradesBreakeven = parseInt(tradesBreakevenField.value) || 0;
                    if (pnlField) exerciseData.pnl = parseFloat(pnlField.value) || 0;
                    if (whatWorkedField) exerciseData.whatWorked = whatWorkedField.value;
                    if (whatDidntWorkField) exerciseData.whatDidntWork = whatDidntWorkField.value;
                    if (strugglesField) exerciseData.struggles = strugglesField.value;
                    if (winsField) exerciseData.wins = winsField.value;
                    if (whatChangeField) exerciseData.whatChange = whatChangeField.value;
                    if (kpisField) exerciseData.kpis = kpisField.value;
                }

                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
                console.log('Draft saved successfully');
            } catch (error) {
                console.error('Error saving draft:', error);
                showError('Error al guardar: ' + error.message);
            }
        }

        document.getElementById('exerciseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentExercise) return;

            const submitBtn = document.getElementById('submitExerciseBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            let exerciseData = {
                status: 'pending',
                submittedAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            };

            try {
                if (currentExercise.type === 'pattern') {
                    exerciseData.when = document.getElementById('when').value;
                    exerciseData.feeling = document.getElementById('feeling').value;
                    exerciseData.action = document.getElementById('action').value;
                } else {
                    exerciseData.tradesWon = parseInt(document.getElementById('tradesWon').value) || 0;
                    exerciseData.tradesLost = parseInt(document.getElementById('tradesLost').value) || 0;
                    exerciseData.tradesBreakeven = parseInt(document.getElementById('tradesBreakeven').value) || 0;
                    exerciseData.pnl = parseFloat(document.getElementById('pnl').value) || 0;
                    exerciseData.whatWorked = document.getElementById('whatWorked').value;
                    exerciseData.whatDidntWork = document.getElementById('whatDidntWork').value;
                    exerciseData.struggles = document.getElementById('struggles').value;
                    exerciseData.wins = document.getElementById('wins').value;
                    exerciseData.whatChange = document.getElementById('whatChange').value;
                    exerciseData.kpis = document.getElementById('kpis').value;
                }

                await updateDoc(doc(db, 'exercises', currentExercise.id), exerciseData);
                showSuccess('¡Ejercicio enviado para revisión!');
                setTimeout(() => {
                    navigateToPage('exercises');
                    loadExercises();
                }, 1500);
            } catch (error) {
                console.error('Error submitting exercise:', error);
                showError('Error al enviar el ejercicio: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar para Revisión';
            }
        });

        async function loadCalendar() {
            const locked = document.getElementById('calendarLocked');
            const unlocked = document.getElementById('calendarUnlocked');
            
            if (userData?.calendarUnlocked || userData?.role === 'admin') {
                locked.classList.add('hidden');
                unlocked.classList.remove('hidden');
            } else {
                locked.classList.remove('hidden');
                unlocked.classList.add('hidden');
            }
        }

        // Admin functions
        async function loadAdminDashboard() {
            if (userData?.role !== 'admin') {
                navigateToPage('dashboard');
                return;
            }

            try {
                // Load all users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(u => u.role !== 'admin');

                // Load pending exercises
                const exercisesSnapshot = await getDocs(
                    query(collection(db, 'exercises'), where('status', '==', 'pending'))
                );
                const pendingExercises = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update stats
                document.getElementById('adminTotalStudents').textContent = users.length;
                document.getElementById('adminPendingReviews').textContent = pendingExercises.length;
                document.getElementById('adminActiveStudents').textContent = users.filter(u => u.currentStep > 1).length;

                // Render users list
                renderAdminUsersList(users);

                // Render pending exercises
                renderAdminPendingExercises(pendingExercises, users);

                // Load pending stages
                await loadPendingStages();

                // Load stages content management
                await loadStagesContent();
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        function renderAdminUsersList(users) {
            const container = document.getElementById('adminUsersList');
            
            container.innerHTML = users.map(user => {
                const completedSteps = (user.unlockedSteps?.length || 1) - 1;
                
                return `
                    <div class="user-card">
                        <div class="user-header">
                            <div>
                                <div class="user-name">${user.name || user.email}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                        
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-value">${user.currentStep || 1}</div>
                                <div class="user-stat-label">Etapa Actual</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${completedSteps}</div>
                                <div class="user-stat-label">Completadas</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${user.completedExercises || 0}</div>
                                <div class="user-stat-label">Ejercicios</div>
                            </div>
                        </div>

                        <div class="step-unlock-controls">
                            <select class="form-select" id="stepSelect_${user.id}" style="flex: 1;">
                                ${steps.map(step => `
                                    <option value="${step.id}" ${user.currentStep === step.id ? 'selected' : ''}>
                                        Etapa ${step.id}: ${step.title}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="btn btn-small" onclick="unlockStepForUser('${user.id}')">
                                Desbloquear Etapa
                            </button>
                        </div>

                        <div class="create-exercise-form" id="createExForm_${user.id}" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: #4F46E5;">Crear Ejercicio</h4>
                            <div class="form-row">
                                <select class="form-select" id="exType_${user.id}">
                                    <option value="weekly">Semanal</option>
                                    <option value="monthly">Mensual</option>
                                    <option value="quarterly">Trimestral</option>
                                    <option value="pattern">Diario de Patrones</option>
                                </select>
                                <button class="btn btn-success btn-small" onclick="createExerciseForUser('${user.id}')">
                                    Crear
                                </button>
                            </div>
                        </div>

                        <div class="user-actions">
                            <button class="btn btn-secondary btn-small" onclick="toggleCalendar('${user.id}', ${!user.calendarUnlocked})">
                                ${user.calendarUnlocked ? '🔓 Bloquear' : '🔒 Desbloquear'} Calendario
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="toggleCreateExerciseForm('${user.id}')">
                                ➕ Crear Ejercicio
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.unlockStepForUser = async function(userId) {
            try {
                const selectedStep = parseInt(document.getElementById(`stepSelect_${userId}`).value);
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();
                
                const unlockedSteps = userData.unlockedSteps || [1];
                if (!unlockedSteps.includes(selectedStep)) {
                    unlockedSteps.push(selectedStep);
                    unlockedSteps.sort((a, b) => a - b);
                }

                await updateDoc(userRef, {
                    currentStep: selectedStep,
                    unlockedSteps: unlockedSteps
                });

                showSuccess(`Etapa ${selectedStep} desbloqueada para el alumno`);
                loadAdminDashboard();
            } catch (error) {
                console.error('Error unlocking step:', error);
                showError('Error al desbloquear la etapa');
            }
        }

        window.toggleCalendar = async function(userId, unlock) {
            try {
                await updateDoc(doc(db, 'users', userId), {
                    calendarUnlocked: unlock
                });

                showSuccess(unlock ? 'Calendario desbloqueado' : 'Calendario bloqueado');
                loadAdminDashboard();
            } catch (error) {
                console.error('Error toggling calendar:', error);
                showError('Error al actualizar el calendario');
            }
        }

        function renderAdminPendingExercises(exercises, users) {
            const container = document.getElementById('adminPendingExercises');
            
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay ejercicios pendientes de revisión</p>';
                return;
            }

            container.innerHTML = exercises.map(exercise => {
                const user = users.find(u => u.id === exercise.userId);
                
                let typeClass, typeLabel;
                if (exercise.type === 'weekly') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Semanal';
                } else if (exercise.type === 'monthly') {
                    typeClass = 'type-monthly';
                    typeLabel = 'Mensual';
                } else if (exercise.type === 'quarterly') {
                    typeClass = 'type-quarterly';
                    typeLabel = 'Trimestral';
                } else if (exercise.type === 'pattern') {
                    typeClass = 'type-weekly';
                    typeLabel = 'Diario de Patrones';
                }
                
                const date = exercise.submittedAt?.toDate ? exercise.submittedAt.toDate().toLocaleDateString('es-ES') : 'Sin fecha';

                return `
                    <div class="exercise-card" onclick="openReviewModal('${exercise.id}', '${user?.name || 'Alumno'}')">
                        <div class="exercise-info">
                            <h3>${user?.name || user?.email || 'Alumno'} - ${typeLabel}</h3>
                            <div class="exercise-meta">Enviado el ${date}</div>
                        </div>
                        <span class="exercise-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        window.openReviewModal = async function(exerciseId, userName) {
            try {
                const exerciseDoc = await getDoc(doc(db, 'exercises', exerciseId));
                if (!exerciseDoc.exists()) return;

                currentReviewExercise = { id: exerciseId, ...exerciseDoc.data() };
                
                const modal = document.getElementById('reviewModal');
                const content = document.getElementById('reviewModalContent');
                
                let typeLabel = '';
                if (currentReviewExercise.type === 'weekly') typeLabel = 'Semanal';
                else if (currentReviewExercise.type === 'monthly') typeLabel = 'Mensual';
                else if (currentReviewExercise.type === 'quarterly') typeLabel = 'Trimestral';
                else if (currentReviewExercise.type === 'pattern') typeLabel = 'Diario de Patrones';

                let contentHTML = `
                    <div class="review-exercise-header">
                        <div>
                            <h3>${userName}</h3>
                            <p style="color: #a1a1aa;">${typeLabel}</p>
                        </div>
                    </div>
                `;

                if (currentReviewExercise.type === 'pattern') {
                    contentHTML += `
                        <div class="review-field">
                            <div class="review-field-title">📅 Cuándo ha pasado</div>
                            <div class="review-field-content">${currentReviewExercise.when || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">💭 Cómo me he sentido / Qué he pensado</div>
                            <div class="review-field-content">${currentReviewExercise.feeling || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">⚡ Qué he hecho</div>
                            <div class="review-field-content">${currentReviewExercise.action || 'Sin respuesta'}</div>
                        </div>
                    `;
                } else {
                    const totalTrades = (currentReviewExercise.tradesWon || 0) + (currentReviewExercise.tradesLost || 0) + (currentReviewExercise.tradesBreakeven || 0);
                    const winRate = totalTrades > 0 ? Math.round((currentReviewExercise.tradesWon / totalTrades) * 100) : 0;
                    
                    contentHTML += `
                        <div class="review-field">
                            <div class="review-field-title">📊 Métricas</div>
                            <div class="review-field-content">
                                <strong>Ganadas:</strong> ${currentReviewExercise.tradesWon || 0}<br>
                                <strong>Perdidas:</strong> ${currentReviewExercise.tradesLost || 0}<br>
                                <strong>Breakeven:</strong> ${currentReviewExercise.tradesBreakeven || 0}<br>
                                <strong>Win Rate:</strong> ${winRate}%<br>
                                <strong>P&L:</strong> $${currentReviewExercise.pnl || 0}
                            </div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">✅ Qué funcionó</div>
                            <div class="review-field-content">${currentReviewExercise.whatWorked || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">❌ Qué no funcionó</div>
                            <div class="review-field-content">${currentReviewExercise.whatDidntWork || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">😓 Algo que me costó</div>
                            <div class="review-field-content">${currentReviewExercise.struggles || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">🏆 Un win (logro)</div>
                            <div class="review-field-content">${currentReviewExercise.wins || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">🔄 Qué cambiaría esta semana para mejorar</div>
                            <div class="review-field-content">${currentReviewExercise.whatChange || 'Sin respuesta'}</div>
                        </div>

                        <div class="review-field">
                            <div class="review-field-title">🎯 KPIs de Proceso</div>
                            <div class="review-field-content">${currentReviewExercise.kpis || 'Sin respuesta'}</div>
                        </div>
                    `;
                }

                content.innerHTML = contentHTML;
                document.getElementById('reviewFeedback').value = '';
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error opening review modal:', error);
            }
        }

        window.closeReviewModal = function() {
            document.getElementById('reviewModal').classList.add('hidden');
            currentReviewExercise = null;
        }

        window.submitReview = async function() {
            if (!currentReviewExercise) return;

            const feedback = document.getElementById('reviewFeedback').value.trim();
            if (!feedback) {
                showError('Por favor, escribe un feedback para el alumno');
                return;
            }

            try {
                await updateDoc(doc(db, 'exercises', currentReviewExercise.id), {
                    status: 'completed',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                // Update user's completed exercises count
                const userRef = doc(db, 'users', currentReviewExercise.userId);
                const userDoc = await getDoc(userRef);
                const currentCount = userDoc.data().completedExercises || 0;
                await updateDoc(userRef, {
                    completedExercises: currentCount + 1
                });

                showSuccess('¡Ejercicio revisado y feedback enviado!');
                closeReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error submitting review:', error);
                showError('Error al enviar la revisión');
            }
        }

        // Stage Review System
        let currentStageSubmission = null;

        window.submitStageForReview = async function() {
            const currentStepId = parseInt(document.getElementById('stepDetailTitle').textContent.match(/\d+/)[0]);
            
            console.log('Submitting stage:', currentStepId, 'for user:', currentUser.uid);

            // Validation for Stage 1: must have at least one error
            if (currentStepId === 1) {
                if (currentErrors.length === 0) {
                    showError('Debes identificar al menos un error antes de enviar la etapa para revisión');
                    return;
                }
                
                // Check if at least one error has all questions answered
                const hasCompleteError = currentErrors.some(error => error.completedQuestions === 7);
                if (!hasCompleteError) {
                    showError('Debes completar las 7 preguntas de al menos un error antes de enviar');
                    return;
                }
            }

            // Validation for Stage 2: all 3 tools must be completed
            if (currentStepId === 2) {
                const redComplete = stage2ToolsData.red?.completed || false;
                const systemsComplete = stage2ToolsData.systems?.completed || false;
                const habitsComplete = stage2ToolsData.habits?.completed || false;

                if (!redComplete || !systemsComplete || !habitsComplete) {
                    const missing = [];
                    if (!redComplete) missing.push('RED (Reinicio-Evaluación-Dirección)');
                    if (!systemsComplete) missing.push('Sistemas y Procesos');
                    if (!habitsComplete) missing.push('Hábitos y Rutinas');
                    
                    showError(`Debes completar todas las herramientas antes de enviar. Faltan: ${missing.join(', ')}`);
                    return;
                }
            }

            try {
                const stageSubmission = {
                    userId: currentUser.uid,
                    stageId: currentStepId,
                    status: 'pending',
                    submittedAt: Timestamp.now(),
                    createdAt: Timestamp.now()
                };

                await addDoc(collection(db, 'stageSubmissions'), stageSubmission);
                
                showSuccess('¡Etapa enviada para revisión!');
                updateStageSubmitStatus(currentStepId);
            } catch (error) {
                console.error('Error submitting stage:', error);
                showError('Error al enviar la etapa: ' + error.message);
            }
        }

        async function updateStageSubmitStatus(stageId) {
            try {
                const q = query(
                    collection(db, 'stageSubmissions'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', stageId)
                );
                
                const snapshot = await getDocs(q);
                const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by submittedAt descending to get latest
                submissions.sort((a, b) => {
                    const aTime = a.submittedAt?.toMillis ? a.submittedAt.toMillis() : 0;
                    const bTime = b.submittedAt?.toMillis ? b.submittedAt.toMillis() : 0;
                    return bTime - aTime;
                });

                const latestSubmission = submissions[0];
                const statusDiv = document.getElementById('stageSubmitStatus');
                const submitBtn = document.getElementById('submitStageBtn');

                if (!latestSubmission) {
                    statusDiv.innerHTML = '';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '📤 Enviar Etapa para Revisión';
                } else if (latestSubmission.status === 'pending') {
                    statusDiv.innerHTML = '<div class="success-message">⏳ Etapa enviada - Esperando revisión del mentor</div>';
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'En Revisión...';
                } else if (latestSubmission.status === 'approved') {
                    statusDiv.innerHTML = `<div class="success-message">✅ Etapa Aprobada${latestSubmission.mentorFeedback ? '<br><strong>Feedback:</strong> ' + latestSubmission.mentorFeedback : ''}</div>`;
                    submitBtn.disabled = true;
                    submitBtn.textContent = '✓ Aprobada';
                } else if (latestSubmission.status === 'rejected') {
                    statusDiv.innerHTML = `<div class="error-message">❌ Etapa Rechazada - Revisa el feedback<br><strong>Feedback:</strong> ${latestSubmission.mentorFeedback || 'Sin feedback'}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = '🔄 Reenviar para Revisión';
                }
            } catch (error) {
                console.error('Error loading stage status:', error);
            }
        }

        async function loadPendingStages() {
            try {
                const q = query(
                    collection(db, 'stageSubmissions'),
                    where('status', '==', 'pending')
                );
                
                const snapshot = await getDocs(q);
                const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Load all users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderPendingStages(submissions, users);
            } catch (error) {
                console.error('Error loading pending stages:', error);
            }
        }

        function renderPendingStages(submissions, users) {
            const container = document.getElementById('adminPendingStages');
            
            if (submissions.length === 0) {
                container.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem;">No hay etapas pendientes de revisión</p>';
                return;
            }

            container.innerHTML = submissions.map(submission => {
                const user = users.find(u => u.id === submission.userId);
                const stage = steps.find(s => s.id === submission.stageId);
                const date = submission.submittedAt?.toDate ? submission.submittedAt.toDate().toLocaleDateString('es-ES') : 'Sin fecha';

                return `
                    <div class="exercise-card" onclick="openStageReviewModal('${submission.id}', '${user?.name || 'Alumno'}', ${submission.stageId})">
                        <div class="exercise-info">
                            <h3>${user?.name || user?.email || 'Alumno'} - Etapa ${submission.stageId}: ${stage?.title || ''}</h3>
                            <div class="exercise-meta">Enviado el ${date}</div>
                        </div>
                        <span class="exercise-type type-weekly">Etapa ${submission.stageId}</span>
                    </div>
                `;
            }).join('');
        }

        window.openStageReviewModal = async function(submissionId, userName, stageId) {
            try {
                const submissionDoc = await getDoc(doc(db, 'stageSubmissions', submissionId));
                if (!submissionDoc.exists()) return;

                currentStageSubmission = { id: submissionId, ...submissionDoc.data() };
                
                const stage = steps.find(s => s.id === stageId);
                const modal = document.getElementById('stageReviewModal');
                const content = document.getElementById('stageReviewModalContent');
                
                let stageContent = '';

                // For Stage 1, load and display all errors
                if (stageId === 1) {
                    const errorsQuery = query(
                        collection(db, 'stageErrors'),
                        where('userId', '==', currentStageSubmission.userId),
                        where('stageId', '==', 1),
                        orderBy('createdAt', 'desc')
                    );
                    
                    const errorsSnapshot = await getDocs(errorsQuery);
                    const errors = errorsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(error => !error.deleted); // Exclude deleted errors

                    if (errors.length === 0) {
                        stageContent = `
                            <div class="review-field">
                                <div class="review-field-title">❌ Errores Identificados</div>
                                <div class="review-field-content">
                                    <em style="color: #a1a1aa;">El alumno no ha identificado ningún error todavía.</em>
                                </div>
                            </div>
                        `;
                    } else {
                        stageContent = `
                            <div class="review-field">
                                <div class="review-field-title">❌ Errores Identificados (${errors.length})</div>
                            </div>
                            ${errors.map(error => `
                                <div class="review-field" style="background: rgba(255, 255, 255, 0.02); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="color: #4F46E5; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                        ❌ ${error.title || 'Error sin título'}
                                    </h4>
                                    <div style="color: #a1a1aa; margin-bottom: 1rem; font-size: 0.9rem;">
                                        ${error.completedQuestions}/7 preguntas completadas
                                    </div>
                                    
                                    ${errorQuestions.map((q, index) => {
                                        const answer = error.answers?.[index] || '';
                                        return answer ? `
                                            <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">
                                                    Pregunta ${q.number}: ${q.text}
                                                </div>
                                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">
                                                    ${answer}
                                                </div>
                                            </div>
                                        ` : '';
                                    }).join('')}
                                </div>
                            `).join('')}
                        `;
                    }
                } else if (stageId === 2) {
                    // For Stage 2, load and display all 3 tools
                    const toolsQuery = query(
                        collection(db, 'stage2Tools'),
                        where('userId', '==', currentStageSubmission.userId),
                        where('stageId', '==', 2)
                    );
                    
                    const toolsSnapshot = await getDocs(toolsQuery);
                    const tools = {};
                    toolsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        tools[data.toolType] = data;
                    });

                    const redTool = tools.red;
                    const systemsTool = tools.systems;
                    const habitsTool = tools.habits;

                    stageContent = `
                        <!-- RED Tool -->
                        <div class="review-field" style="background: rgba(255, 255, 255, 0.02); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #4F46E5; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                🔄 RED: Reinicio-Evaluación-Dirección
                            </h4>
                            <div style="color: #a1a1aa; margin-bottom: 1rem; font-size: 0.9rem;">
                                ${redTool?.completed ? '✓ Completado' : '○ Incompleto'}
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">
                                    Paso 1: Reinicio
                                </div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">
                                    ${redTool?.step1 || '<em style="color: #a1a1aa;">Sin contenido</em>'}
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">
                                    Paso 2: Evaluación
                                </div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">
                                    ${redTool?.step2 || '<em style="color: #a1a1aa;">Sin contenido</em>'}
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">
                                    Paso 3: Dirección
                                </div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">
                                    ${redTool?.step3 || '<em style="color: #a1a1aa;">Sin contenido</em>'}
                                </div>
                            </div>
                        </div>

                        <!-- Systems Tool -->
                        <div class="review-field" style="background: rgba(255, 255, 255, 0.02); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #4F46E5; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                ⚙️ Sistemas y Procesos
                            </h4>
                            <div style="color: #a1a1aa; margin-bottom: 1rem; font-size: 0.9rem;">
                                ${systemsTool?.completed ? '✓ Completado' : '○ Incompleto'}
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Mercados y Horarios</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.markets || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Parámetros de Riesgo</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.risk || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Limitaciones de Trading</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.limits || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Gestión de Operaciones</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.management || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Preparación Física y Mental</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.preparation || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Prohibido Trading Bajo Estas Condiciones</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.prohibited || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Estrategias de Comportamiento</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.behavior || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Guías para el Comportamiento Profesional</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${systemsTool?.guidelines || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>
                        </div>

                        <!-- Habits Tool -->
                        <div class="review-field" style="background: rgba(255, 255, 255, 0.02); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #4F46E5; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                🎯 Hábitos y Rutinas
                            </h4>
                            <div style="color: #a1a1aa; margin-bottom: 1rem; font-size: 0.9rem;">
                                ${habitsTool?.completed ? '✓ Completado' : '○ Incompleto'}
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Reflexión sobre Rutinas</div>
                                <div style="color: #e5e7eb; line-height: 1.6; white-space: pre-wrap;">${habitsTool?.reflection || '<em style="color: #a1a1aa;">Sin contenido</em>'}</div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <div style="color: #4F46E5; font-weight: 600; margin-bottom: 0.5rem;">Hábitos Diarios</div>
                                ${habitsTool?.habits && habitsTool.habits.length > 0 ? `
                                    <ol style="color: #e5e7eb; line-height: 1.8; padding-left: 1.5rem;">
                                        ${habitsTool.habits.map(habit => `<li>${habit}</li>`).join('')}
                                    </ol>
                                ` : '<em style="color: #a1a1aa;">Sin hábitos definidos</em>'}
                            </div>
                        </div>
                    `;
                } else {
                    stageContent = `
                        <div class="review-field">
                            <div class="review-field-title">📝 Revisión de Etapa</div>
                            <div class="review-field-content">
                                El alumno ha marcado esta etapa como completada.<br>
                                <strong>Próximamente:</strong> Aquí verás el contenido de las herramientas completadas.
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div class="review-exercise-header">
                        <div>
                            <h3>${userName}</h3>
                            <p style="color: #a1a1aa;">Etapa ${stageId}: ${stage?.title || ''}</p>
                        </div>
                    </div>

                    ${stageContent}
                `;

                document.getElementById('stageFeedback').value = '';
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error opening stage review modal:', error);
                showError('Error al cargar la revisión: ' + error.message);
            }
        }

        window.closeStageReviewModal = function() {
            document.getElementById('stageReviewModal').classList.add('hidden');
            currentStageSubmission = null;
        }

        window.approveStage = async function() {
            if (!currentStageSubmission) return;

            const feedback = document.getElementById('stageFeedback').value.trim();

            try {
                await updateDoc(doc(db, 'stageSubmissions', currentStageSubmission.id), {
                    status: 'approved',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                // Unlock next stage for user
                const nextStageId = currentStageSubmission.stageId + 1;
                if (nextStageId <= 5) {
                    const userRef = doc(db, 'users', currentStageSubmission.userId);
                    const userDoc = await getDoc(userRef);
                    const userData = userDoc.data();
                    
                    const unlockedSteps = userData.unlockedSteps || [1];
                    if (!unlockedSteps.includes(nextStageId)) {
                        unlockedSteps.push(nextStageId);
                        unlockedSteps.sort((a, b) => a - b);
                    }

                    await updateDoc(userRef, {
                        currentStep: nextStageId,
                        unlockedSteps: unlockedSteps
                    });

                    // If approving stage 4, unlock calendar
                    if (currentStageSubmission.stageId === 4) {
                        await updateDoc(userRef, {
                            calendarUnlocked: true
                        });
                    }
                }

                showSuccess('✅ Etapa aprobada! ' + (nextStageId <= 5 ? `Etapa ${nextStageId} desbloqueada` : 'Programa completado'));
                closeStageReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error approving stage:', error);
                showError('Error al aprobar la etapa: ' + error.message);
            }
        }

        window.rejectStage = async function() {
            if (!currentStageSubmission) return;

            const feedback = document.getElementById('stageFeedback').value.trim();
            if (!feedback) {
                showError('Por favor, escribe un feedback explicando por qué rechazas la etapa');
                return;
            }

            try {
                await updateDoc(doc(db, 'stageSubmissions', currentStageSubmission.id), {
                    status: 'rejected',
                    mentorFeedback: feedback,
                    reviewedAt: Timestamp.now()
                });

                showSuccess('Etapa rechazada. El alumno recibirá tu feedback.');
                closeStageReviewModal();
                loadAdminDashboard();
            } catch (error) {
                console.error('Error rejecting stage:', error);
                showError('Error al rechazar la etapa');
            }
        }

        // Utility functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Email inválido',
                'auth/user-disabled': 'Usuario deshabilitado',
                'auth/user-not-found': 'Usuario no encontrado',
                'auth/wrong-password': 'Contraseña incorrecta',
                'auth/invalid-credential': 'Credenciales inválidas'
            };
            return messages[code] || 'Error al iniciar sesión';
        }

        window.toggleCreateExerciseForm = function(userId) {
            const form = document.getElementById(`createExForm_${userId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        window.createExerciseForUser = async function(userId) {
            const type = document.getElementById(`exType_${userId}`).value;
            
            try {
                const exerciseData = {
                    userId: userId,
                    type: type,
                    status: 'draft',
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                };

                // Add empty fields based on type
                if (type === 'pattern') {
                    exerciseData.when = '';
                    exerciseData.feeling = '';
                    exerciseData.action = '';
                } else {
                    exerciseData.tradesWon = 0;
                    exerciseData.tradesLost = 0;
                    exerciseData.tradesBreakeven = 0;
                    exerciseData.pnl = 0;
                    exerciseData.whatWorked = '';
                    exerciseData.whatDidntWork = '';
                    exerciseData.struggles = '';
                    exerciseData.wins = '';
                    exerciseData.whatChange = '';
                    exerciseData.kpis = '';
                }

                await addDoc(collection(db, 'exercises'), exerciseData);
                
                let typeLabel = '';
                if (type === 'weekly') typeLabel = 'semanal';
                else if (type === 'monthly') typeLabel = 'mensual';
                else if (type === 'quarterly') typeLabel = 'trimestral';
                else if (type === 'pattern') typeLabel = 'diario de patrones';
                
                showSuccess(`✅ Ejercicio ${typeLabel} creado!`);
                document.getElementById(`createExForm_${userId}`).style.display = 'none';
            } catch (error) {
                console.error('Error creating exercise:', error);
                showError('Error al crear el ejercicio');
            }
        }

        async function loadStagesContent() {
            const container = document.getElementById('stagesContentManagement');
            
            // Load stages configuration from Firestore
            let stagesConfig = {};
            try {
                const configDoc = await getDoc(doc(db, 'config', 'stages'));
                if (configDoc.exists()) {
                    stagesConfig = configDoc.data();
                }
            } catch (error) {
                console.log('No config found, using defaults');
            }

            container.innerHTML = steps.map(step => {
                const config = stagesConfig[`stage${step.id}`] || {};
                
                return `
                    <div class="content-management-card">
                        <div class="stage-card-header">
                            <div>
                                <span class="stage-number">Etapa ${step.id}</span>
                                <h3 style="margin-top: 0.5rem;">${step.title}</h3>
                            </div>
                        </div>

                        <form id="stageForm_${step.id}" onsubmit="saveStageContent(event, ${step.id})">
                            <div class="form-group">
                                <label class="form-label">Video URL (YouTube, Loom, Vimeo)</label>
                                <input 
                                    type="url" 
                                    class="form-input" 
                                    id="video_${step.id}"
                                    value="${config.video || ''}"
                                    placeholder="https://www.youtube.com/watch?v=..."
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">Herramienta URL</label>
                                <input 
                                    type="url" 
                                    class="form-input" 
                                    id="tool_${step.id}"
                                    value="${config.tool || ''}"
                                    placeholder="https://..."
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripción</label>
                                <textarea 
                                    class="form-textarea" 
                                    id="description_${step.id}"
                                    placeholder="Descripción de la etapa..."
                                >${config.description || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Recursos Adicionales</label>
                                <textarea 
                                    class="form-textarea" 
                                    id="resources_${step.id}"
                                    placeholder="Links, documentos, material extra..."
                                >${config.resources || ''}</textarea>
                            </div>

                            <button type="submit" class="btn btn-small">
                                💾 Guardar Cambios
                            </button>
                        </form>
                    </div>
                `;
            }).join('');
        }

        window.saveStageContent = async function(event, stageId) {
            event.preventDefault();
            console.log('Saving stage content for stage:', stageId);
            
            const video = document.getElementById(`video_${stageId}`).value.trim();
            const tool = document.getElementById(`tool_${stageId}`).value.trim();
            const description = document.getElementById(`description_${stageId}`).value.trim();
            const resources = document.getElementById(`resources_${stageId}`).value.trim();

            console.log('Stage data:', { video, tool, description, resources });

            try {
                const configRef = doc(db, 'config', 'stages');
                const configDoc = await getDoc(configRef);
                
                let currentConfig = {};
                if (configDoc.exists()) {
                    currentConfig = configDoc.data();
                }

                currentConfig[`stage${stageId}`] = {
                    video,
                    tool,
                    description,
                    resources,
                    updatedAt: Timestamp.now()
                };

                await setDoc(configRef, currentConfig, { merge: true });
                console.log('Stage saved successfully');
                
                // Update local steps array
                const stepIndex = steps.findIndex(s => s.id === stageId);
                if (stepIndex !== -1) {
                    steps[stepIndex].video = video;
                    steps[stepIndex].tool = tool;
                    steps[stepIndex].description = description;
                }

                showSuccess(`✅ Etapa ${stageId} actualizada correctamente`);
            } catch (error) {
                console.error('Error saving stage content:', error);
                showError('Error al guardar los cambios: ' + error.message);
            }
        }

        // ========================================
        // STAGE 1: ERRORS MANAGEMENT FUNCTIONS
        // ========================================

        // Framework questions for Stage 1
        const errorQuestions = [
            {
                number: 1,
                text: "Describe el error en detalle",
                help: "Incluye ejemplos del comportamiento, descripciones de tus emociones y mentalidad"
            },
            {
                number: 2,
                text: "¿Qué suele pasar justo antes de empezar a participar en este error/comportamiento?",
                help: "Explica las condiciones que lo desencadenan, así como cualquier respuesta emocional que parezca impulsar este comportamiento"
            },
            {
                number: 3,
                text: "¿Cuál es la intención positiva que este comportamiento tiene para ti?",
                help: "Aunque sea irracional, explica la lógica o la justificación detrás del comportamiento"
            },
            {
                number: 4,
                text: "¿Qué en tus circunstancias personales contribuyen a este patrón de comportamiento?",
                help: "¿Qué hay sobre ti o sobre tu experiencia pasada que podría ser una razón por la que tienes esta tendencia?"
            },
            {
                number: 5,
                text: "¿Cómo sabotea este comportamiento tu trading?",
                help: "Describe cómo este comportamiento afecta negativamente tus operaciones a pesar de cualquier intención positiva"
            },
            {
                number: 6,
                text: "¿Cuál es la mejor manera de lograr las intenciones positivas de la Pregunta 3? (TU TOP LEVEL)",
                help: "¿Qué hábitos o comportamientos puedes hacer para reemplazar los patrones descritos en el punto 3?"
            },
            {
                number: 7,
                text: "¿Cómo aplicarás este Top Level específicamente a tu proceso de trading?",
                help: "Describe en detalle las formas en que te asegurarás de que puedes aplicar esto"
            }
        ];

        // Load errors for Stage 1
        async function loadStage1Errors() {
            if (!currentUser) return;

            try {
                const errorsQuery = query(
                    collection(db, 'stageErrors'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', 1),
                    orderBy('createdAt', 'desc')
                );

                const snapshot = await getDocs(errorsQuery);
                currentErrors = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(error => !error.deleted); // Exclude deleted errors

                renderErrorsList();
            } catch (error) {
                console.error('Error loading errors:', error);
                showError('Error al cargar tus errores');
            }
        }

        // Render errors list
        function renderErrorsList() {
            const container = document.getElementById('stageToolsSection');
            
            const errorsListHTML = `
                <div class="errors-list-container">
                    <div class="errors-header">
                        <h3>❌ Mis Errores Identificados</h3>
                        <button class="btn btn-small" onclick="showErrorEditor(null)">
                            ➕ Añadir Nuevo Error
                        </button>
                    </div>

                    ${currentErrors.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">🎯</div>
                            <div class="empty-state-title">Aún no has identificado errores</div>
                            <div class="empty-state-text">
                                Haz clic en "Añadir Nuevo Error" para comenzar a identificar los patrones que quieres mejorar en tu trading.
                            </div>
                        </div>
                    ` : `
                        <div class="errors-list">
                            ${currentErrors.map(error => `
                                <div class="error-item" onclick="showErrorEditor('${error.id}')">
                                    <div class="error-item-info">
                                        <div class="error-item-title">❌ ${error.title || 'Error sin título'}</div>
                                        <div class="error-item-status">
                                            ${error.completedQuestions || 0}/7 preguntas completadas
                                        </div>
                                    </div>
                                    <div class="error-item-actions" onclick="event.stopPropagation()">
                                        <button class="btn-icon edit" onclick="showErrorEditor('${error.id}')">
                                            ✏️ Editar
                                        </button>
                                        <button class="btn-icon delete" onclick="deleteError('${error.id}')">
                                            🗑️ Eliminar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;

            container.innerHTML = errorsListHTML;
            container.classList.remove('hidden');
        }

        // Show error editor
        window.showErrorEditor = async function(errorId) {
            currentErrorId = errorId;
            let errorData = null;

            // If editing existing error, load it
            if (errorId) {
                errorData = currentErrors.find(e => e.id === errorId);
            }

            const container = document.getElementById('stageToolsSection');
            
            const editorHTML = `
                <div class="error-editor">
                    <div class="error-editor-header">
                        <div>
                            <button onclick="cancelErrorEditor()" style="background: transparent; border: none; color: #4F46E5; cursor: pointer; font-size: 1rem; margin-bottom: 0.5rem;">
                                ← Volver a la lista
                            </button>
                            <h2 class="error-editor-title">
                                ${errorId ? '✏️ Editar Error' : '➕ Nuevo Error'}
                            </h2>
                        </div>
                        <div class="save-indicator" id="errorSaveIndicator">
                            <span id="errorSaveText">Sin cambios</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label class="form-label">Nombre del error *</label>
                        <input 
                            type="text" 
                            id="errorTitle" 
                            class="form-input" 
                            placeholder="Ej: Overtrading, FOMO, Revenge trading..."
                            value="${errorData?.title || ''}"
                            oninput="scheduleErrorAutoSave()"
                        >
                    </div>

                    ${errorQuestions.map((q, index) => `
                        <div class="error-question">
                            <div class="error-question-number">Pregunta ${q.number}</div>
                            <div class="error-question-text">${q.text}</div>
                            <div class="error-question-help">${q.help}</div>
                            <textarea 
                                id="errorAnswer${q.number}" 
                                class="form-textarea" 
                                placeholder="Escribe tu respuesta aquí..."
                                oninput="scheduleErrorAutoSave()"
                                style="min-height: 150px;"
                            >${errorData?.answers?.[index] || ''}</textarea>
                        </div>
                    `).join('')}

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="cancelErrorEditor()">
                            Cancelar
                        </button>
                        <button class="btn" onclick="saveError()">
                            💾 Guardar Error
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = editorHTML;
        }

        // Schedule auto-save for errors
        window.scheduleErrorAutoSave = function() {
            const indicator = document.getElementById('errorSaveIndicator');
            const text = document.getElementById('errorSaveText');
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (errorAutoSaveTimer) {
                clearTimeout(errorAutoSaveTimer);
            }

            errorAutoSaveTimer = setTimeout(async () => {
                await saveError(true);
            }, 2000);
        }

        // Save error
        window.saveError = async function(isAutoSave = false) {
            const title = document.getElementById('errorTitle')?.value?.trim();
            
            if (!title && !isAutoSave) {
                showError('Por favor ingresa un nombre para el error');
                return;
            }

            if (!currentUser) return;

            try {
                const answers = [];
                let completedQuestions = 0;

                for (let i = 1; i <= 7; i++) {
                    const answer = document.getElementById(`errorAnswer${i}`)?.value?.trim() || '';
                    answers.push(answer);
                    if (answer) completedQuestions++;
                }

                const errorData = {
                    userId: currentUser.uid,
                    stageId: 1,
                    title: title || 'Error sin título',
                    answers: answers,
                    completedQuestions: completedQuestions,
                    updatedAt: Timestamp.now()
                };

                if (currentErrorId) {
                    // Update existing error
                    await updateDoc(doc(db, 'stageErrors', currentErrorId), errorData);
                } else {
                    // Create new error
                    errorData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stageErrors'), errorData);
                    currentErrorId = docRef.id;
                }

                const indicator = document.getElementById('errorSaveIndicator');
                const text = document.getElementById('errorSaveText');
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '✓ Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('✅ Error guardado correctamente');
                    await loadStage1Errors();
                }
            } catch (error) {
                console.error('Error saving:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        // Cancel error editor
        window.cancelErrorEditor = function() {
            currentErrorId = null;
            if (errorAutoSaveTimer) {
                clearTimeout(errorAutoSaveTimer);
            }
            renderErrorsList();
        }

        // Delete error
        window.deleteError = async function(errorId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este error? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                await updateDoc(doc(db, 'stageErrors', errorId), {
                    deleted: true,
                    deletedAt: Timestamp.now()
                });

                showSuccess('✅ Error eliminado');
                await loadStage1Errors();
            } catch (error) {
                console.error('Error deleting:', error);
                showError('Error al eliminar el error');
            }
        }

        // ========================================
        // END OF STAGE 1 FUNCTIONS
        // ========================================

        // ========================================
        // STAGE 2: TOOLS MANAGEMENT FUNCTIONS
        // ========================================

        // Load all Stage 2 tools
        async function loadStage2Tools() {
            if (!currentUser) return;

            try {
                // Load RED tool
                const redQuery = query(
                    collection(db, 'stage2Tools'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', 2),
                    where('toolType', '==', 'red')
                );
                const redSnapshot = await getDocs(redQuery);
                if (!redSnapshot.empty) {
                    stage2ToolsData.red = { id: redSnapshot.docs[0].id, ...redSnapshot.docs[0].data() };
                }

                // Load Systems tool
                const systemsQuery = query(
                    collection(db, 'stage2Tools'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', 2),
                    where('toolType', '==', 'systems')
                );
                const systemsSnapshot = await getDocs(systemsQuery);
                if (!systemsSnapshot.empty) {
                    stage2ToolsData.systems = { id: systemsSnapshot.docs[0].id, ...systemsSnapshot.docs[0].data() };
                }

                // Load Habits tool
                const habitsQuery = query(
                    collection(db, 'stage2Tools'),
                    where('userId', '==', currentUser.uid),
                    where('stageId', '==', 2),
                    where('toolType', '==', 'habits')
                );
                const habitsSnapshot = await getDocs(habitsQuery);
                if (!habitsSnapshot.empty) {
                    stage2ToolsData.habits = { id: habitsSnapshot.docs[0].id, ...habitsSnapshot.docs[0].data() };
                }

                renderStage2Tools();
            } catch (error) {
                console.error('Error loading Stage 2 tools:', error);
                showError('Error al cargar las herramientas');
            }
        }

        // Render all Stage 2 tools
        function renderStage2Tools() {
            const container = document.getElementById('stageToolsSection');
            
            // Calculate completion
            const completedTools = [
                stage2ToolsData.red?.completed,
                stage2ToolsData.systems?.completed,
                stage2ToolsData.habits?.completed
            ].filter(Boolean).length;

            const html = `
                <div class="stage2-progress-indicator">
                    <div class="stage2-progress-text">
                        Progreso de la Etapa 2
                    </div>
                    <div class="stage2-progress-bar-container">
                        <div class="stage2-progress-bar-fill" style="width: ${(completedTools / 3) * 100}%"></div>
                    </div>
                    <div class="stage2-progress-text">
                        ${completedTools}/3 herramientas completadas
                    </div>
                </div>

                <div class="stage2-tools-container">
                    ${renderREDTool()}
                    ${renderSystemsTool()}
                    ${renderHabitsTool()}
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        // Render RED tool
        function renderREDTool() {
            const data = stage2ToolsData.red;
            const isComplete = data?.completed || false;
            
            return `
                <div class="stage2-tool-card" id="redToolCard">
                    <div class="stage2-tool-header">
                        <div>
                            <div class="stage2-tool-title">🔄 RED: Reinicio-Evaluación-Dirección</div>
                            <div class="stage2-tool-subtitle">
                                Proceso de 3 pasos para redirigir tu enfoque, restaurar el equilibrio y mantener una mentalidad profesional
                            </div>
                        </div>
                        <div class="stage2-tool-status ${isComplete ? 'complete' : ''}">
                            ${isComplete ? '✓ Completado' : '○ Pendiente'}
                        </div>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Paso 1: Reinicio</div>
                        <div class="stage2-section-desc">¿Cómo te reinicias cuando estás frustrado o fuera de balance?</div>
                        <textarea 
                            class="form-textarea" 
                            id="redStep1"
                            placeholder="Describe tu proceso de reinicio..."
                            oninput="scheduleStage2AutoSave('red')"
                            style="min-height: 120px;"
                        >${data?.step1 || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Paso 2: Evaluación</div>
                        <div class="stage2-section-desc">¿Cómo evalúas tu estado actual y tus operaciones?</div>
                        <textarea 
                            class="form-textarea" 
                            id="redStep2"
                            placeholder="Describe tu proceso de evaluación..."
                            oninput="scheduleStage2AutoSave('red')"
                            style="min-height: 120px;"
                        >${data?.step2 || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Paso 3: Dirección</div>
                        <div class="stage2-section-desc">¿Hacia dónde diriges tu atención y esfuerzo después?</div>
                        <textarea 
                            class="form-textarea" 
                            id="redStep3"
                            placeholder="Describe tu proceso de dirección..."
                            oninput="scheduleStage2AutoSave('red')"
                            style="min-height: 120px;"
                        >${data?.step3 || ''}</textarea>
                    </div>

                    <div class="save-indicator" id="redSaveIndicator">
                        <span id="redSaveText">Sin cambios</span>
                    </div>
                </div>
            `;
        }

        // Render Systems tool
        function renderSystemsTool() {
            const data = stage2ToolsData.systems;
            const isComplete = data?.completed || false;
            
            return `
                <div class="stage2-tool-card" id="systemsToolCard">
                    <div class="stage2-tool-header">
                        <div>
                            <div class="stage2-tool-title">⚙️ Sistemas y Procesos</div>
                            <div class="stage2-tool-subtitle">
                                Define tus reglas, límites y procesos de trading para mantener la consistencia
                            </div>
                        </div>
                        <div class="stage2-tool-status ${isComplete ? 'complete' : ''}">
                            ${isComplete ? '✓ Completado' : '○ Pendiente'}
                        </div>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Mercados y Horarios</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsMarkets"
                            placeholder="¿Qué mercados operas y en qué horarios/sesiones?"
                            oninput="scheduleStage2AutoSave('systems')"
                        >${data?.markets || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Parámetros de Riesgo</div>
                        <div class="stage2-section-desc">Define: riesgo por posición, por idea, exposición máxima, límite diario y semanal de pérdida</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsRisk"
                            placeholder="Escribe tus parámetros de riesgo..."
                            oninput="scheduleStage2AutoSave('systems')"
                            style="min-height: 150px;"
                        >${data?.risk || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Limitaciones de Trading</div>
                        <div class="stage2-section-desc">Define: número de trades por día, posiciones abiertas, pérdidas/ganancias máximas por día, riesgo total máximo</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsLimits"
                            placeholder="Escribe tus limitaciones..."
                            oninput="scheduleStage2AutoSave('systems')"
                            style="min-height: 150px;"
                        >${data?.limits || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Gestión de Operaciones</div>
                        <div class="stage2-section-desc">Define: ejecución, stop loss, break even, parciales, optimización de TP y R:R</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsManagement"
                            placeholder="Describe tu gestión de operaciones..."
                            oninput="scheduleStage2AutoSave('systems')"
                            style="min-height: 150px;"
                        >${data?.management || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Preparación Física y Mental</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsPreparation"
                            placeholder="¿Cómo te preparas física y mentalmente para trading?"
                            oninput="scheduleStage2AutoSave('systems')"
                        >${data?.preparation || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Prohibido Trading Bajo Estas Condiciones</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsProhibited"
                            placeholder="¿En qué condiciones NO debes operar?"
                            oninput="scheduleStage2AutoSave('systems')"
                        >${data?.prohibited || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Estrategias de Comportamiento</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsBehavior"
                            placeholder="¿Qué estrategias sigues para mantener un comportamiento profesional?"
                            oninput="scheduleStage2AutoSave('systems')"
                            style="min-height: 120px;"
                        >${data?.behavior || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Guías para el Comportamiento Profesional</div>
                        <textarea 
                            class="form-textarea" 
                            id="systemsGuidelines"
                            placeholder="¿Qué guías seguirás para mantener profesionalismo?"
                            oninput="scheduleStage2AutoSave('systems')"
                            style="min-height: 120px;"
                        >${data?.guidelines || ''}</textarea>
                    </div>

                    <div class="save-indicator" id="systemsSaveIndicator">
                        <span id="systemsSaveText">Sin cambios</span>
                    </div>
                </div>
            `;
        }

        // Render Habits tool
        function renderHabitsTool() {
            const data = stage2ToolsData.habits;
            const isComplete = data?.completed || false;
            const habits = data?.habits || [];
            
            return `
                <div class="stage2-tool-card" id="habitsToolCard">
                    <div class="stage2-tool-header">
                        <div>
                            <div class="stage2-tool-title">🎯 Hábitos y Rutinas</div>
                            <div class="stage2-tool-subtitle">
                                Define hábitos claros, simples y repetibles que mantengan tu enfoque y alto rendimiento
                            </div>
                        </div>
                        <div class="stage2-tool-status ${isComplete ? 'complete' : ''}">
                            ${isComplete ? '✓ Completado' : '○ Pendiente'}
                        </div>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Reflexión sobre tus Rutinas</div>
                        <div class="stage2-section-desc">
                            ¿Qué te prepara bien para el día? ¿Qué es clave para rendir al máximo? ¿Dónde hay ineficiencias que roban tiempo?
                        </div>
                        <textarea 
                            class="form-textarea" 
                            id="habitsReflection"
                            placeholder="Reflexiona sobre tus rutinas actuales..."
                            oninput="scheduleStage2AutoSave('habits')"
                            style="min-height: 150px;"
                        >${data?.reflection || ''}</textarea>
                    </div>

                    <div class="stage2-section">
                        <div class="stage2-section-title">Mis Hábitos Diarios</div>
                        <div class="stage2-section-desc">
                            Lista hábitos específicos y accionables que seguirás con constancia
                        </div>
                        <div class="habits-list" id="habitsList">
                            ${habits.map((habit, index) => `
                                <div class="habit-item">
                                    <span style="color: #4F46E5; font-weight: 600;">${index + 1}.</span>
                                    <input 
                                        type="text" 
                                        value="${habit}"
                                        onchange="updateHabit(${index}, this.value)"
                                        placeholder="Escribe un hábito..."
                                    />
                                    <button onclick="removeHabit(${index})">🗑️</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-habit-btn" onclick="addHabit()">
                            ➕ Añadir Hábito
                        </button>
                    </div>

                    <div class="save-indicator" id="habitsSaveIndicator">
                        <span id="habitsSaveText">Sin cambios</span>
                    </div>
                </div>
            `;
        }

        // Schedule auto-save for Stage 2 tools
        window.scheduleStage2AutoSave = function(toolType) {
            const indicator = document.getElementById(`${toolType}SaveIndicator`);
            const text = document.getElementById(`${toolType}SaveText`);
            
            if (indicator && text) {
                indicator.classList.remove('saved');
                indicator.classList.add('saving');
                text.textContent = 'Guardando...';
            }

            if (stage2AutoSaveTimer) {
                clearTimeout(stage2AutoSaveTimer);
            }

            stage2AutoSaveTimer = setTimeout(async () => {
                await saveStage2Tool(toolType, true);
            }, 2000);
        }

        // Save Stage 2 tool
        async function saveStage2Tool(toolType, isAutoSave = false) {
            if (!currentUser) return;

            try {
                let toolData = {
                    userId: currentUser.uid,
                    stageId: 2,
                    toolType: toolType,
                    updatedAt: Timestamp.now()
                };

                let isComplete = false;

                if (toolType === 'red') {
                    const step1 = document.getElementById('redStep1')?.value?.trim() || '';
                    const step2 = document.getElementById('redStep2')?.value?.trim() || '';
                    const step3 = document.getElementById('redStep3')?.value?.trim() || '';
                    
                    toolData.step1 = step1;
                    toolData.step2 = step2;
                    toolData.step3 = step3;
                    isComplete = step1 && step2 && step3;
                } else if (toolType === 'systems') {
                    const markets = document.getElementById('systemsMarkets')?.value?.trim() || '';
                    const risk = document.getElementById('systemsRisk')?.value?.trim() || '';
                    const limits = document.getElementById('systemsLimits')?.value?.trim() || '';
                    const management = document.getElementById('systemsManagement')?.value?.trim() || '';
                    const preparation = document.getElementById('systemsPreparation')?.value?.trim() || '';
                    const prohibited = document.getElementById('systemsProhibited')?.value?.trim() || '';
                    const behavior = document.getElementById('systemsBehavior')?.value?.trim() || '';
                    const guidelines = document.getElementById('systemsGuidelines')?.value?.trim() || '';
                    
                    toolData.markets = markets;
                    toolData.risk = risk;
                    toolData.limits = limits;
                    toolData.management = management;
                    toolData.preparation = preparation;
                    toolData.prohibited = prohibited;
                    toolData.behavior = behavior;
                    toolData.guidelines = guidelines;
                    isComplete = markets && risk && limits && management && preparation && prohibited && behavior && guidelines;
                } else if (toolType === 'habits') {
                    const reflection = document.getElementById('habitsReflection')?.value?.trim() || '';
                    const habits = stage2ToolsData.habits?.habits || [];
                    
                    toolData.reflection = reflection;
                    toolData.habits = habits;
                    isComplete = reflection && habits.length >= 3; // At least 3 habits
                }

                toolData.completed = isComplete;

                if (stage2ToolsData[toolType]?.id) {
                    // Update existing
                    await updateDoc(doc(db, 'stage2Tools', stage2ToolsData[toolType].id), toolData);
                } else {
                    // Create new
                    toolData.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, 'stage2Tools'), toolData);
                    stage2ToolsData[toolType] = { id: docRef.id, ...toolData };
                }

                const indicator = document.getElementById(`${toolType}SaveIndicator`);
                const text = document.getElementById(`${toolType}SaveText`);
                
                if (indicator && text) {
                    indicator.classList.remove('saving');
                    indicator.classList.add('saved');
                    text.textContent = '✓ Guardado';
                }

                if (!isAutoSave) {
                    showSuccess('✅ Herramienta guardada correctamente');
                    // Reload to update completion status
                    await loadStage2Tools();
                }
            } catch (error) {
                console.error('Error saving Stage 2 tool:', error);
                if (!isAutoSave) {
                    showError('Error al guardar: ' + error.message);
                }
            }
        }

        // Habits functions
        window.addHabit = async function() {
            if (!stage2ToolsData.habits) {
                stage2ToolsData.habits = { habits: [] };
            }
            if (!stage2ToolsData.habits.habits) {
                stage2ToolsData.habits.habits = [];
            }
            
            stage2ToolsData.habits.habits.push('');
            renderStage2Tools();
            
            // Focus on the new input
            setTimeout(() => {
                const inputs = document.querySelectorAll('#habitsList input');
                if (inputs.length > 0) {
                    inputs[inputs.length - 1].focus();
                }
            }, 100);
        }

        window.updateHabit = async function(index, value) {
            if (!stage2ToolsData.habits?.habits) return;
            
            stage2ToolsData.habits.habits[index] = value;
            await saveStage2Tool('habits', false);
        }

        window.removeHabit = async function(index) {
            if (!stage2ToolsData.habits?.habits) return;
            
            stage2ToolsData.habits.habits.splice(index, 1);
            await saveStage2Tool('habits', false);
        }

        // ========================================
        // END OF STAGE 2 FUNCTIONS
        // ========================================

        // Make functions global
        window.navigateToPage = navigateToPage;
        window.navigateToCurrentStep = navigateToCurrentStep;
        window.navigateToStep = navigateToStep;
        window.openExercise = openExercise;
        window.saveAsDraft = saveAsDraft;
        window.unlockStepForUser = unlockStepForUser;
        window.toggleCalendar = toggleCalendar;
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.submitReview = submitReview;
        window.toggleCreateExerciseForm = toggleCreateExerciseForm;
        window.createExerciseForUser = createExerciseForUser;
        window.saveStageContent = saveStageContent;
        window.createMyExercise = createMyExercise;
        window.submitStageForReview = submitStageForReview;
        window.openStageReviewModal = openStageReviewModal;
        window.closeStageReviewModal = closeStageReviewModal;
        window.approveStage = approveStage;
        window.rejectStage = rejectStage;
        // Stage 1 functions
        window.showErrorEditor = showErrorEditor;
        window.cancelErrorEditor = cancelErrorEditor;
        window.saveError = saveError;
        window.deleteError = deleteError;
        window.scheduleErrorAutoSave = scheduleErrorAutoSave;
        // Stage 2 functions
        window.scheduleStage2AutoSave = scheduleStage2AutoSave;
        window.addHabit = addHabit;
        window.updateHabit = updateHabit;
        window.removeHabit = removeHabit;
    </script>
</body>
</html>
